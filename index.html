<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Seyahat CÃ¼zdanÄ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- PROFESYONEL VE TEMÄ°Z STÄ°LLER --- */
        body {
            font-family: 'Inter', sans-serif
        }

        /* KRÄ°TÄ°K DÃœZELTME: Sayfa kaymasÄ±nÄ± kesinlikle engeller */
        html,
        body {
            overflow-x: hidden !important;
            width: 100%;
            max-width: 100vw;
            height: 100%;
        }

        #app-root {
            width: 100%;
            max-width: 100%;
        }

        /* Scrollbar */
        .scrl::-webkit-scrollbar {
            width: 6px;
            height: 6px
        }

        .scrl::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.5);
            border-radius: 99px
        }

        .scrl::-webkit-scrollbar-track {
            background: transparent
        }

        /* Checkbox custom style (Daha az parlak, daha mat yeÅŸil) */
        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg>");
            border-color: transparent;
            background-color: #059669;
        }

        /* Daha az opak, daha az belirgin bir cam efekti */
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* HARCAMA DETAYI MODAL BAÅžLIÄžI: Sade ve Profesyonel Mavi-MenekÅŸe */
        .fixed-gradient-header {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 50%, #8b5cf6 100%);
            position: relative;
            overflow: hidden;
            /* Hafif, soft gÃ¶lge */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* YENÄ° KAYIT EKRANI Ä°Ã‡Ä°N MODAL SARIYICI */
        .form-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 45;
            background-color: rgba(0, 0, 0, 0.85);
            /* Daha koyu arka plan */
            backdrop-filter: blur(8px);
            overflow-y: auto;
            display: flex;
            justify-content: center;
            padding: 1rem;
        }

        /* Form iÃ§eriÄŸi iÃ§in max-height ayarÄ± */
        .form-content-box {
            max-height: 95vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Harcama listesindeki ÅŸehir baÅŸlÄ±ÄŸÄ± iÃ§in yeni stil */
        .city-header-gradient {
            background: linear-gradient(90deg, #1e293b 0%, #1f2937 80%, rgba(30, 41, 59, 0) 100%);
        }

        /* Ana menÃ¼ butonu stili */
        .menu-btn-base {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0.2rem;
            border-radius: 0.75rem;
            transition: all 0.3s;
            border-width: 1px;
        }

        .menu-btn-icon-box {
            width: 2.2rem;
            height: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
        }

        /* KRÄ°TÄ°K DÃœZELTME Ä°Ã‡Ä°N EK STÄ°L: InputlarÄ±n dikeyde tam doldurmasÄ±nÄ± saÄŸlamak iÃ§in */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            /* Etiket ve input arasÄ±na boÅŸluk */
        }

        /* DÄ°ÄžER SEKME KART MODAL STÄ°LLERÄ° */
        .helper-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            z-index: 50;
        }

        .helper-modal:target {
            display: flex;
        }

        .helper-modal-inner {
            background-color: #020617;
            /* slate-950 */
            border-radius: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 1.25rem;
            max-width: 42rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .helper-modal-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
        }
    </style>


    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="min-h-screen bg-[#0F111A] text-slate-200 flex justify-center p-4 selection:bg-blue-500/30">


    <!-- Login modal -->
    <div id="auth-login-modal"
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-slate-900 w-full max-w-sm mx-4 rounded-2xl border border-slate-700 shadow-2xl p-4 relative">
            <button data-act="auth-close" class="absolute top-3 right-3 text-slate-400 hover:text-white">
                âœ•
            </button>
            <h2 class="text-sm font-bold text-white mb-1">GiriÅŸ yap</h2>
            <p id="auth-login-message" class="text-[11px] text-slate-400 mb-3">
                GeliÅŸmiÅŸ Ã¶zellikler ve PDF dÃ¶kÃ¼mÃ¼ iÃ§in giriÅŸ yapmanÄ±z gerekir.
            </p>
            <button type="button" data-act="auth-google"
                class="w-full mb-3 inline-flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg bg-red-500 text-white text-xs font-semibold hover:bg-red-600">
                <span>G</span>
                <span>Google ile giriÅŸ yap</span>
            </button>
            <div class="text-[10px] text-slate-500 mb-2">veya e-posta ile devam edin</div>
            <input id="auth-email-input" type="email" placeholder="E-posta"
                class="w-full mb-1.5 px-2.5 py-1.5 border border-slate-700 rounded-lg bg-slate-800 text-xs text-slate-200 outline-none focus:border-blue-500" />
            <input id="auth-password-input" type="password" placeholder="Åžifre"
                class="w-full mb-2.5 px-2.5 py-1.5 border border-slate-700 rounded-lg bg-slate-800 text-xs text-slate-200 outline-none focus:border-blue-500" />
            <div class="flex gap-2">
                <button type="button" data-act="auth-email-login"
                    class="flex-1 px-2.5 py-1.5 text-[11px] rounded-lg bg-slate-100 text-slate-900 font-semibold">
                    GiriÅŸ yap
                </button>
                <button type="button" data-act="auth-email-register"
                    class="flex-1 px-2.5 py-1.5 text-[11px] rounded-lg bg-slate-700 text-slate-100 border border-slate-600">
                    KayÄ±t ol
                </button>
            </div>

            <button type="button" id="auth-logout-btn" data-act="auth-logout"
                class="mt-3 w-full text-[11px] rounded-lg border border-red-500/60 text-red-200 py-1.5 hidden">
                Ã‡Ä±kÄ±ÅŸ yap
            </button>
        </div>
    </div>

    <div id="app-root" class="w-full max-w-xl md:max-w-2xl"></div>

    <script>
        (() => {
            // --- Firebase Auth + Misafir Limitleri ---
            const firebaseConfig = {
                apiKey: "AIzaSyDiZ7KZBF1bPb185duB0iIXvtqrdfJ91e8",
                authDomain: "seyahat-takip.firebaseapp.com",
                projectId: "seyahat-takip",
                storageBucket: "seyahat-takip.firebasestorage.app",
                messagingSenderId: "740530417306",
                appId: "1:740530417306:web:62b1538f1f85fa9e8c7923",
                measurementId: "G-68BX89MR14"
            };

            let auth = null;
            let currentUser = null;
            let db = null;
            let isCloudLoading = false;
            let isCloudSaving = false;


            function initFirebaseAuth() {
                try {
                    if (typeof firebase !== 'undefined') {
                        if (!firebase.apps || !firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        auth = firebase.auth();
                        if (firebase.firestore) {
                            db = firebase.firestore();
                        }
                        auth.onAuthStateChanged(user => {
                            console.log('onAuthStateChanged, user:', user);
                            currentUser = user;
                            updateAuthUi();
                            if (currentUser) {
                                loadUserDataFromCloud();
                            }
                        });
                    } else {
                        console.warn('Firebase yÃ¼klÃ¼ deÄŸil');
                    }
                } catch (err) {
                    console.error('Firebase init hatasÄ±', err);
                }
            }

            function updateAuthUi() {
                const loginBtn = document.getElementById('auth-btn-login-toggle');
                const logoutBtn = document.getElementById('auth-logout-btn');
                const userMenu = document.getElementById('auth-user-menu');
                if (!loginBtn) return;

                // VarsayÄ±lan hali: misafir (gri ikon)
                loginBtn.classList.remove('bg-emerald-500/80', 'border-emerald-400');
                loginBtn.classList.add('bg-slate-800/70', 'border-slate-600');

                if (logoutBtn) {
                    logoutBtn.classList.add('hidden');
                }
                if (userMenu && !currentUser) {
                    userMenu.classList.add('hidden');
                }

                if (currentUser) {
                    // GiriÅŸ yapÄ±lmÄ±ÅŸsa: ikon yeÅŸil
                    loginBtn.classList.remove('bg-slate-800/70', 'border-slate-600');
                    loginBtn.classList.add('bg-emerald-500/80', 'border-emerald-400');

                    if (logoutBtn) {
                        logoutBtn.classList.remove('hidden');
                    }
                }
            }


            function openLoginModal(message) {
                const modal = document.getElementById('auth-login-modal');
                const msg = document.getElementById('auth-login-message');
                if (msg) {
                    if (currentUser) {
                        msg.textContent = 'Åžu anda giriÅŸ yapmÄ±ÅŸ durumdasÄ±nÄ±z. Ä°sterseniz aÅŸaÄŸÄ±dan Ã§Ä±kÄ±ÅŸ yapabilirsiniz.';
                    } else if (message) {
                        msg.textContent = message;
                    } else {
                        msg.textContent = 'GeliÅŸmiÅŸ Ã¶zellikler ve PDF dÃ¶kÃ¼mÃ¼ iÃ§in giriÅŸ yapmanÄ±z gerekir.';
                    }
                }
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            }

            function closeLoginModal() {
                const modal = document.getElementById('auth-login-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }


            function toggleUserMenu(forceHide = false) {
                const menu = document.getElementById('auth-user-menu');
                const emailEl = document.getElementById('auth-user-email');
                if (!menu) return;

                if (forceHide) {
                    menu.classList.add('hidden');
                    return;
                }

                if (currentUser && emailEl) {
                    emailEl.textContent = currentUser.email || currentUser.displayName || 'Oturum aÃ§Ä±ldÄ±';
                }

                menu.classList.toggle('hidden');
            }

            function isGuest() {
                return !currentUser;
            }

            function getDistinctTripsAll() {
                const fromExp = (state && state.exp ? state.exp : []).map(x => x.trip).filter(Boolean);
                const fromRes = (state && state.res ? state.res : []).map(x => x.trip).filter(Boolean);
                return [...new Set([...fromExp, ...fromRes])];
            }

            function getCurrencyForTrip(tripName) {
                if (!tripName) return state.baseCurrency || BASE_CURRENCY;
                const t = String(tripName || '').toLowerCase();
                const fromExp = (state && state.exp ? state.exp : [])
                    .filter(x => (x.trip || '').toLowerCase() === t && x.cur);
                if (!fromExp.length) return state.baseCurrency || BASE_CURRENCY;
                const freq = {};
                fromExp.forEach(x => {
                    const cur = x.cur || BASE_CURRENCY;
                    freq[cur] = (freq[cur] || 0) + 1;
                });
                return Object.entries(freq).sort((a, b) => b[1] - a[1])[0][0];
            }


            function guestTripLimitExceeded(newTripName) {
                if (!newTripName) return false;
                const trips = getDistinctTripsAll();
                const exists = trips.includes(newTripName);
                return (!exists && trips.length >= 2);
            }

            function guestExpenseLimitExceeded(tripName) {
                if (!tripName || !state || !state.exp) return false;
                const count = state.exp.filter(x => x.trip === tripName).length;
                return count >= 3;
            }

            // --- Sabitler ---
            const K = { EXP: 'travel_expenses', LIST: 'travel_checklist', BUD: 'travel_budget', PREF: 'travel_pref', NOTES: 'travel_notes', RES: 'travel_reservations', TRIPS: 'travel_trips' };
            const AVAILABLE_CURRENCIES = ['TRY', 'EUR', 'USD', 'GBP', 'JPY', 'CAD', 'AUD'];

            // YENÄ° FOTOÄžRAF SABÄ°TLERÄ°
            const MAX_IMAGES = 3;
            const MAX_IMAGE_WIDTH = 800;

            let EXCHANGE_RATES = {
                TRY: 1.0,
                USD: 42.51920, // Dinamik Kur: USD/TRY (Mock)
                EUR: 49.55726, // Dinamik Kur: EUR/TRY (Mock)
                GBP: 52.00,
                JPY: 0.28,
                CAD: 31.00,
                AUD: 29.00,
            };
            let BASE_CURRENCY = 'TRY';
            let rateLastUpdated = 'Statik (BaÅŸlangÄ±Ã§)';

            // YENÄ° SABÄ°T: HARCAMA TÄ°PÄ°
            const EXPENSE_TYPES = [
                { id: 'card', l: 'Kart' },
                { id: 'cash', l: 'Nakit' },
                { id: 'other', l: 'DiÄŸer' }
            ];

            // YENÄ° SABÄ°T: REZERVASYON TÄ°PLERÄ°
            const RESERVATION_TYPES = [
                { id: 'flight', l: 'UÃ§ak Bileti', i: 'âœˆï¸', color: 'from-blue-600 to-sky-500' },
                { id: 'hotel', l: 'Otel/Konaklama', i: 'ðŸ¨', color: 'from-emerald-600 to-teal-500' },
                { id: 'activity', l: 'Etkinlik/Bilet', i: 'ðŸŽŸï¸', color: 'from-purple-600 to-fuchsia-500' },
                { id: 'transport', l: 'Tren/OtobÃ¼s', i: 'ðŸšŒ', color: 'from-orange-600 to-amber-500' },
                { id: 'other', l: 'DiÄŸer', i: 'ðŸ“', color: 'from-slate-600 to-gray-500' },
            ];


            // YENÄ° SABÄ°T: BÄ°REYSEL/ORTAK FÄ°LTRE TÄ°PLERÄ°
            const INDIVIDUAL_FILTERS = [
                { id: '', l: 'TÃ¼m Harcamalar' },
                { id: 'individual', l: 'Bireysel' },
                { id: 'shared', l: 'Ortak' }
            ];


            let chartInst = null, state = {};

            // HarcamayÄ± ana para birimine dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r
            function convertToBase(amount, currency, targetCurrency = BASE_CURRENCY) {
                amount = Number(amount) || 0;
                currency = currency || 'TRY';
                targetCurrency = targetCurrency || 'TRY';

                if (currency === targetCurrency) return amount;

                const rateToTry = EXCHANGE_RATES[currency];
                const rateFromTry = EXCHANGE_RATES[targetCurrency];

                if (!rateToTry || !rateFromTry) {
                    console.warn(`Bilinmeyen kur: ${currency} veya ${targetCurrency}. DÃ¶nÃ¼ÅŸÃ¼m baÅŸarÄ±sÄ±z.`);
                    return amount;
                }

                // TRY'ye dÃ¶nÃ¼ÅŸtÃ¼r, sonra hedef para birimine
                const amountInTry = amount * rateToTry;
                return amountInTry / rateFromTry;
            }

            // --- KRÄ°TÄ°K FONKSÄ°YON: KUR Ã‡EKÄ°MÄ°NÄ° SÄ°MÃœLE EDER VE UYGULAR ---
            function fetchAndApplyRates() {
                const MOCK_USD_RATE = 42.51920;
                const MOCK_EUR_RATE = 49.55726;

                return new Promise(resolve => {
                    setTimeout(() => {
                        try {
                            if (MOCK_USD_RATE && MOCK_USD_RATE > 0) EXCHANGE_RATES.USD = MOCK_USD_RATE;
                            if (MOCK_EUR_RATE && MOCK_EUR_RATE > 0) EXCHANGE_RATES.EUR = MOCK_EUR_RATE;

                            const now = new Date();
                            rateLastUpdated = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')} (Otomatik)`;

                            console.log('Kurlar GÃ¼ncellendi:', EXCHANGE_RATES, 'Zaman:', rateLastUpdated);

                        } catch (e) {
                            console.error("Kur gÃ¼ncelleme hatasÄ± (SimÃ¼lasyon):", e);
                            rateLastUpdated = 'Hata (Statik KullanÄ±lÄ±yor)';
                        }

                        renderApp();
                        resolve();
                    }, 1500);
                });
            }

            // Rapor iÃ§in harcama listesini getirir
            function getTripExpenses(tripName) {
                if (!tripName) return [];
                // Sadece seÃ§ili seyahatin harcamalarÄ±nÄ± getir
                return state.exp.filter(x => x.trip === tripName && !isNaN(Number(x.amt)) && Number(x.amt) > 0);
            }
            function buildReportHtml(payload) {
                const fmt = (n) => n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const dateRange = (payload.dateFrom && payload.dateTo)
                    ? `${payload.dateFrom} â€“ ${payload.dateTo}`
                    : 'Tarih bilgisi yok';

                const s = payload.summary || {};
                const scopeLabel =
                    payload.scope === 'individual' ? 'Bireysel Harcamalar' :
                        payload.scope === 'shared' ? 'Ortak Harcamalar' :
                            'TÃ¼m Harcamalar (Bireysel + Ortak)';

                const esc = (str) => String(str || '').replace(/[&<>"]/g, c => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'
                }[c] || c));

                const expRows = payload.expenses.map(e => `
        <tr>
          <td>${esc(e.date || '')} ${esc(e.time || '')}</td>
          <td>${esc(e.cat || '')}</td>
          <td>${esc(e.place || '')}</td>
          <td>${esc(e.city || '')}</td>
          <td style="text-align:right;">${fmt(e.amt)} ${esc(e.cur)}</td>
          <td>${e.isIndividual ? 'Bireysel' : 'Ortak'}</td>
        </tr>
    `).join('');

                const resRows = payload.reservations.map(r => `
        <tr>
          <td>${esc(r.startDate || '')}</td>
          <td>${esc(r.type || '')}</td>
          <td>${esc(r.name || '')}</td>
          <td>${esc(r.location || '')}</td>
          <td>${esc(r.code || '')}</td>
          <td style="text-align:right;">${fmt(r.cost)} ${esc(r.cur)}</td>
          <td>${r.isIndividual ? 'Bireysel' : 'Ortak'}</td>
        </tr>
    `).join('');

                const html = `<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Seyahat CÃ¼zdanÄ± â€“ ${esc(payload.trip)} Raporu</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 24px;
      color: #111827;
      background: #f3f4f6;
    }
    h1,h2,h3 { margin: 0 0 8px 0; }
    .small { font-size: 11px; color: #4b5563; }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.08);
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
    }
    th {
      background: #f9fafb;
      text-align: left;
      font-weight: 600;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #111827;
    }
    .tag-scope { background:#dbebff; color:#1d4ed8; }
    .tag-cur   { background:#dcfce7; color:#166534; }
    .footer-note {
      font-size: 10px;
      color: #6b7280;
      margin-top: 4px;
    }
    @media print {
      body { margin: 0; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="no-print" style="margin-bottom:12px; font-size:11px; color:#6b7280;">
    Bu sayfayÄ± tarayÄ±cÄ±nÄ±zdan <strong>YazdÄ±r â†’ PDF olarak kaydet</strong> seÃ§eneÄŸi ile PDFâ€™e dÃ¶nÃ¼ÅŸtÃ¼rebilirsiniz.
  </div>

  <div class="card">
    <h1>Seyahat CÃ¼zdanÄ± â€“ Harcama Raporu</h1>
    <div class="small">
      <div><strong>Seyahat:</strong> ${esc(payload.trip)}</div>
      <div><strong>Tarih AralÄ±ÄŸÄ±:</strong> ${esc(dateRange)}</div>
      <div><strong>Rapor Para Birimi:</strong> <span class="tag tag-cur">${esc(payload.reportCurrency)}</span></div>
      <div><strong>Harcama KapsamÄ±:</strong> <span class="tag tag-scope">${esc(scopeLabel)}</span></div>
      <div><strong>OluÅŸturulma Tarihi:</strong> ${esc(payload.generatedAt)}</div>
    </div>
  </div>

  <div class="card">
    <h2>1) Genel Ã–zet</h2>
    <div class="grid-2">
      <div>
        <div><strong>Toplam Harcama:</strong> ${fmt(s.totalReport || 0)} ${esc(payload.reportCurrency)}</div>
        <div><strong>Rezervasyon Maliyetleri:</strong> ${fmt(s.totalResReport || 0)} ${esc(payload.reportCurrency)}</div>
        <div><strong>Harcamalar (GÃ¼n iÃ§i):</strong> ${fmt(s.totalExpReport || 0)} ${esc(payload.reportCurrency)}</div>
      </div>
      <div>
        <div><strong>GÃ¼nlÃ¼k Ortalama:</strong> ${fmt(s.dailyAvg || 0)} ${esc(payload.reportCurrency)} / gÃ¼n</div>
        <div><strong>GÃ¼n SayÄ±sÄ±:</strong> ${s.dayCount || 0}</div>
        <div><strong>Ä°ÅŸlem SayÄ±sÄ±:</strong> ${s.expenseCount || 0} harcama + ${s.reservationCount || 0} rezervasyon</div>
      </div>
    </div>
    <div style="margin-top:8px; font-size:11px;">
      <strong>Bireysel:</strong> ${fmt(s.indivTotal || 0)} ${esc(payload.reportCurrency)}
      &nbsp;Â·&nbsp;
      <strong>Ortak:</strong> ${fmt(s.sharedTotal || 0)} ${esc(payload.reportCurrency)}
    </div>
  </div>

  <div class="card">
    <h2>2) Rezervasyon Ã–zeti</h2>
    <table>
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Tip</th>
          <th>BaÅŸlÄ±k</th>
          <th>Lokasyon</th>
          <th>Kod</th>
          <th style="text-align:right;">Maliyet</th>
          <th>Kapsam</th>
        </tr>
      </thead>
      <tbody>
        ${resRows || '<tr><td colspan="7">KayÄ±tlÄ± rezervasyon bulunmamaktadÄ±r.</td></tr>'}
      </tbody>
    </table>
    <div class="footer-note">
      Rezervasyon maliyetleri toplam harcamaya dahildir. Bireysel/ortak bilgisi uygulamadaki iÅŸaretlemelere gÃ¶re alÄ±nmÄ±ÅŸtÄ±r.
    </div>
  </div>

  <div class="card">
    <h2>3) GÃ¼nlÃ¼k Harcama DÃ¶kÃ¼mÃ¼</h2>
    <table>
      <thead>
        <tr>
          <th>Tarih / Saat</th>
          <th>Kategori</th>
          <th>Yer / AÃ§Ä±klama</th>
          <th>Åžehir</th>
          <th style="text-align:right;">Tutar (Orijinal)</th>
          <th>Kapsam</th>
        </tr>
      </thead>
      <tbody>
        ${expRows || '<tr><td colspan="6">KayÄ±tlÄ± harcama bulunmamaktadÄ±r.</td></tr>'}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>4) Notlar</h2>
    <p class="footer-note">
      â€¢ Rezervasyon maliyetleri toplam harcamaya dahil edilmiÅŸtir.<br/>
      â€¢ Bireysel/ortak ayrÄ±mÄ± seyahat cÃ¼zdanÄ± uygulamasÄ±ndaki iÅŸaretlemelere gÃ¶re yapÄ±lmÄ±ÅŸtÄ±r.<br/>
      â€¢ Rapor para birimi ${esc(payload.reportCurrency)}â€™dir; diÄŸer para birimlerindeki harcamalar uygulamadaki kur bilgilerine gÃ¶re dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸtÃ¼r.
    </p>
  </div>
</body>
</html>`;

                return html;
            }


            // --- HARCAMA GRAFÄ°ÄžÄ° VE RAPOR VERÄ° HAZIRLAMA ---
            function getChartDataset(expenses = state.exp) {
                // Ã–nce grafik iÃ§in temel veri setini belirle
                const base = (state._visibleExp && state._visibleExp.length && expenses === state.exp)
                    ? state._visibleExp
                    : expenses;

                const allExp = base.filter(x => !isNaN(Number(x.amt)) && Number(x.amt) > 0);

                if (!allExp.length) {
                    return {
                        labels: [],
                        data: [],
                        colors: [],
                        currency: state.chartCurrency || BASE_CURRENCY,
                        total: 0,
                        trips: [],
                        currencies: [],
                        perCat: {}
                    };
                }

                // Ekranda bulunan kayÄ±tlarÄ±n para birimleri
                const currencies = [...new Set(allExp.map(x => x.cur || BASE_CURRENCY))];

                // 1) SeÃ§ili seyahate gÃ¶re para birimi (Ã¶ncelik buraya verilecek)
                let cur = null;
                if (state.tripFilter) {
                    const tripExps = allExp.filter(x => x.trip === state.tripFilter);
                    const tripCurrencies = [...new Set(tripExps.map(x => x.cur || BASE_CURRENCY))];

                    // SeÃ§ili seyahatte tek bir para birimi varsa onu kullan
                    if (tripCurrencies.length === 1) {
                        cur = tripCurrencies[0];
                    }
                }

                // 2) HÃ¢lÃ¢ belirlenmediyse; kullanÄ±cÄ± seÃ§imi veya varsayÄ±lan
                if (!cur) {
                    cur = state.chartCurrency || BASE_CURRENCY;
                    if (!currencies.includes(cur)) {
                        cur = currencies[0] || BASE_CURRENCY;
                    }
                }

                // Bu fonksiyon state.exp iÃ§in Ã§aÄŸrÄ±lÄ±yorsa, seÃ§ilen para birimini state'te sakla
                if (expenses === state.exp) {
                    state.chartCurrency = cur;
                }

                // Grafik iÃ§in sadece seÃ§ilen para birimindeki harcamalarÄ± kullan
                const filtered = allExp.filter(x => (x.cur || BASE_CURRENCY) === cur);

                const perCat = {};
                filtered.forEach(x => {
                    const cat = x.cat || 'other';
                    const amt = Number(x.amt) || 0;
                    perCat[cat] = (perCat[cat] || 0) + amt;
                });

                const keys = Object.keys(perCat);
                const labels = keys.map(id => (CATS[id] && CATS[id].l) || id);
                const data = keys.map(id => perCat[id]);
                const colors = keys.map(id => (CATS[id] && CATS[id].c) || 'rgba(148,163,184,0.8)');
                const trips = [...new Set(filtered.map(x => x.trip || 'Genel'))];
                const total = data.reduce((a, b) => a + b, 0);

                return {
                    labels,
                    data,
                    colors,
                    currency: cur,
                    currencies,
                    total,
                    trips,
                    perCat
                };
            }


            // --- HARCAMA GRAFÄ°ÄžÄ° Ã‡Ä°ZÄ°M ---
            function renderExpenseChart() {
                try {
                    if (typeof Chart === 'undefined') return;
                    const canvas = document.getElementById('exp-chart');
                    if (!canvas) return;
                    const ds = getChartDataset();
                    if (!ds.labels.length) {
                        if (chartInst) { chartInst.destroy(); chartInst = null; }
                        return;
                    }
                    const ctx = canvas.getContext('2d');
                    if (chartInst) { chartInst.destroy(); chartInst = null; }
                    chartInst = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ds.labels,
                            datasets: [{
                                data: ds.data,
                                backgroundColor: ds.colors,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#cbd5f5',
                                        font: { size: 11 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const label = ctx.label || '';
                                            const value = ctx.parsed || 0;
                                            return `${label}: ${fmtNum(value)} ${ds.currency}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (err) {
                    console.error('Chart render error', err);
                }
            }


            let timeInterval = null;

            const esc = s => String(s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c]));

            const fmtNum = n => Number(n || 0).toLocaleString('tr-TR', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
            const fmtDate = d => { if (!d) return '-'; const p = d.split('-'); return p.length === 3 ? `${p[2]}.${p[1]}.${p[0]}` : d };
            const genId = () => Date.now().toString(36) + Math.random().toString(36).slice(2);

            const titleCase = s => s ? s.toLowerCase().split(' ').map(w => w.length > 0 ? w[0].toUpperCase() + w.slice(1) : w).join(' ') : '';

            const getCityColor = (str) => {
                let hash = 0; if (!str) return 'hsl(210, 50%, 45%)';
                for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                return `hsl(${Math.abs(hash) % 360}, 50%, 45%)`;
            };

            // ZenginleÅŸtirilmiÅŸ Zaman Dilimi Listesi
            const TIMEZONES = [
                { id: 'auto', name: 'â€” Otomatik (Cihaz Saati) â€”' },
                { id: 'Europe/Istanbul', name: 'TÃ¼rkiye (Ä°stanbul)' },
                { id: 'Europe/London', name: 'Ä°ngiltere (Londra)' },
                { id: 'Europe/Paris', name: 'Fransa (Paris)' },
                { id: 'Europe/Berlin', name: 'Almanya (Berlin)' },
                { id: 'America/New_York', name: 'ABD (New York)' },
                { id: 'America/Los_Angeles', name: 'ABD (Los Angeles)' },
                { id: 'Asia/Dubai', name: 'BAE (Dubai)' },
                { id: 'Asia/Tokyo', name: 'Japonya (Tokyo)' },
                { id: 'Asia/Shanghai', name: 'Ã‡in (Åžanghay)' },
                { id: 'Australia/Sydney', name: 'Avustralya (Sydney)' },
                { id: 'Asia/Kolkata', name: 'Hindistan (Kolkata)' },
                { id: 'America/Sao_Paulo', name: 'Brezilya (Sao Paulo)' }
            ];

            // Saat Formatlama
            const formatTime = (timezone) => {
                const now = new Date();
                const effectiveTimezone = timezone === 'auto' || !TIMEZONES.some(tz => tz.id === timezone) ?
                    Intl.DateTimeFormat().resolvedOptions().timeZone :
                    timezone;

                try {
                    const time = now.toLocaleTimeString('tr-TR', {
                        timeZone: effectiveTimezone,
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    const zoneItem = TIMEZONES.find(z => z.id === timezone);
                    const zoneName = zoneItem ? zoneItem.name : effectiveTimezone.split('/').pop().replace('_', ' ');
                    return { time, zoneName };
                } catch (e) {
                    return { time: 'Hata', zoneName: 'Bilinmeyen BÃ¶lge' };
                }
            };

            // SVG Ä°konlarÄ±
            const mkSvg = (d, s = 4) => `<svg class="w-${s} h-${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${d}</svg>`;
            const ICONS = {
                wallet: mkSvg('<rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>', 4),
                trash: mkSvg('<polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>'),
                info: mkSvg('<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'),
                plus: mkSvg('<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>'),
                x: mkSvg('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'),
                chart: mkSvg('<path d="M21.21 15.89A10 10 0 1 1 12 2"/><path d="M22 12A10 10 0 0 0 12 2v10z"/>'),
                clock: mkSvg('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>', 4),
                edit: mkSvg('<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>'),
                down: mkSvg('<polyline points="6 9 12 15 18 9"/>'),
                search: mkSvg('<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>'),
                person: mkSvg('<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'),
                briefcase: mkSvg('<rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>', 4),
                globe: mkSvg('<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="22"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>', 4),
                compass: mkSvg('<circle cx="12" cy="12" r="10"/><polygon points="16 16 12 12 8 16 12 8 16 16"/>', 4),
                hospital: mkSvg('<path d="M12 20v-8m0 0V4m0 8h8m-8 0H4"/><circle cx="12" cy="12" r="10"/>', 4),
                location: mkSvg('<path d="M12 21.7C17.3 17 22 13.3 22 10a10 10 0 0 0-20 0c0 3.3 4.7 7 10 11.7z"/><circle cx="12" cy="10" r="3"/>', 4),
                bus: mkSvg('<rect x="1" y="5" width="22" height="14" rx="2"/><path d="M10 16h4M3 9h18M5 19v2M19 19v2M6 19v2M18 19v2M7 16a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM17 16a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>', 4),
                taxi: mkSvg('<path d="M17 10H7c-2.2 0-4 1.8-4 4v5h18v-5c0-2.2-1.8-4-4-4z"/><path d="M15 10V6c0-1.1-.9-2-2-2h-2c-1.1 0-2 .9-2 2v4"/><path d="M15 10c1.7 0 3 1.3 3 3H6c0-1.7 1.3-3 3-3z"/><path d="M12 2l2 2m-2-2l-2 2"/><rect x="5" y="19" width="4" height="2"/><rect x="15" y="19" width="4" height="2"/><path d="M12 10V4"/>', 4),
                pharmacy: mkSvg('<path d="M12 22s-8-4.5-8-10A8 8 0 0 1 12 4a8 8 0 0 1 8 8c0 5.5-8 10-8 10z"/><path d="M12 9v6m-3-3h6"/>', 4),
                restaurant: mkSvg('<path d="M12 22s-8-4-8-10A8 8 0 0 1 12 4a8 8 0 0 1 8 8c0 6-8 10-8 10zM12 4a4 4 0 0 0 0 8 4 4 0 0 0 0-8z"/>', 4),
                bed: mkSvg('<path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4H2z"/><path d="M2 16h20M7 12V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v6"/>', 4),
                police: mkSvg('<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 18V12m-3 3h6"/>', 4),
                key: mkSvg('<path d="M21 2l-2 2m-7 7l-2 2m-7 7l-2 2"/><path d="M15 11l-2 2m-7 7l-2 2"/><path d="M16 12l2-2m-7 7l-2 2"/><path d="M14 10l2-2m-7 7l-2 2"/><path d="M13 9l2-2m-7 7l-2 2"/><path d="M12 8l2-2m-7 7l-2 2"/><path d="M11 7l2-2m-7 7l-2 2"/><path d="M10 6l2-2m-7 7l-2 2"/><path d="M9 5l2-2m-7 7l-2 2"/><path d="M8 4l2-2m-7 7l-2 2"/><path d="M7 3l2-2m-7 7l-2 2"/><path d="M6 2l2-2m-7 7l-2 2"/><path d="M5 1l2-2m-7 7l-2 2"/><path d="M4 0l2-2m-7 7l-2 2"/><path d="M3 23l-2 2m-7 7l-2 2"/>', 4),
                mapPin: mkSvg('<path d="M12 22s-8-4-8-10c0-4.4 3.6-8 8-8s8 3.6 8 8c0 6-8 10-8 10z"/><circle cx="12" cy="10" r="3"/>', 4),
                flight: mkSvg('<path d="M19 17h-2l-1-2H8l-1 2H5l1-2H2l2-4 1-2h4l1 2h4l1-2h4l1 2 2 4h-3z"/><path d="M14 11l-2-2M10 11l2-2M12 2v3M12 16v6M12 12V6"/>', 4),
                ticket: mkSvg('<path d="M12 22s-8-4-8-10V5l8-3 8 3v7c0 6-8 10-8 10z"/><path d="M12 10v4M10 12h4"/>', 4),
                fuel: mkSvg('<path d="M14 3v4a2 2 0 0 1-2 2h-1a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h1a2 2 0 0 0 2 2v4M5 7h14M5 13h14M5 19h14M12 3v4M12 10v4M12 17v4"/>', 4),
                route: mkSvg('<polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M21 15.5H3M12 2L12 10M12 14L12 22"/>', 4),
                report: mkSvg('<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="10" y1="8" x2="16" y2="8"/><line x1="10" y1="12" x2="14" y2="12"/><line x1="10" y1="16" x2="12" y2="16"/><line x1="7" y1="8" x2="7" y2="16"/>', 4),
                calculate: mkSvg('<path d="M20 9V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v4"/><path d="M2 13h20"/><path d="M17 13v8M7 13v8M4 21h16"/><path d="M10 13v8M14 13v8"/>', 4),
                card: mkSvg('<rect x="2" y="4" width="20" height="16" rx="2" ry="2"/><line x1="2" y1="10" x2="22" y2="10"/><line x1="6" y1="14" x2="6.01" y2="14"/>', 4),
                cash: mkSvg('<circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V8z"/><path d="M12 12v.01"/>', 4),
                refresh: mkSvg('<path d="M21.5 13.5a10 10 0 0 1-18.4 0"/><path d="M2 9v5h5M22 15v-5h-5"/>', 4),
                home: mkSvg('<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>', 4),
                more: mkSvg('<circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>', 4),
                calendar: mkSvg('<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>', 4),
                currency: mkSvg('<circle cx="12" cy="12" r="10"/><path d="M12 18V6"/><path d="M9 9h6"/><path d="M9 15h6"]/>'),
                reserve: mkSvg('<rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="7" cy="7" r="4"/><path d="M14 7h6a2 2 0 0 1 2 2v2M2 9v2M12 15h0"/>', 4),
            };

            // MenÃ¼ ikonlarÄ±nÄ±n estetik gradient renkleri
            const MENU_ICON_COLORS = {
                sum: 'from-blue-500 to-indigo-500',
                exp: 'from-fuchsia-500 to-purple-500',
                chk: 'from-emerald-500 to-teal-500',
                other: 'from-amber-500 to-orange-500',
            };


            // Harcama Kategorileri (Renkler daha mat ve uyumlu hale getirildi)
            const CATS = {
                food: { id: 'food', l: 'Yeme-Ä°Ã§me', i: 'ðŸ½ï¸', g: 'from-pink-600 to-rose-500', c: 'rgba(219,39,119,0.8)' },
                stay: { id: 'stay', l: 'Konaklama', i: 'ðŸ›ï¸', g: 'from-emerald-600 to-teal-500', c: 'rgba(4,120,87,0.8)' },
                transport: { id: 'transport', l: 'UlaÅŸÄ±m', i: 'ðŸš•', g: 'from-blue-600 to-indigo-500', c: 'rgba(37,99,235,0.8)' },
                fuel: { id: 'fuel', l: 'AkaryakÄ±t', i: 'â›½', g: 'from-red-600 to-orange-500', c: 'rgba(220, 38, 38, 0.8)' },
                shopping: { id: 'shopping', l: 'AlÄ±ÅŸveriÅŸ', i: 'ðŸ›ï¸', g: 'from-amber-600 to-orange-500', c: 'rgba(217,119,6,0.8)' },
                activity: { id: 'activity', l: 'MÃ¼ze & Aktivite', i: 'ðŸŽŸï¸', g: 'from-violet-600 to-purple-500', c: 'rgba(124,58,237,0.8)' },
                other: { id: 'other', l: 'DiÄŸer', i: 'ðŸ“¦', g: 'from-slate-600 to-gray-500', c: 'rgba(71,85,105,0.8)' }
            };

            // VarsayÄ±lan Check List Kategorileri ve Maddeleri
            const DEF_CATS = [{ id: 'docs', l: 'Belgeler', i: 'ðŸ“„' }, { id: 'clth', l: 'Giyim', i: 'ðŸ‘•' }, { id: 'elec', l: 'Elektronik', i: 'ðŸ”Œ' }, { id: 'hlth', l: 'SaÄŸlÄ±k', i: 'ðŸ’Š' }, { id: 'otr', l: 'DiÄŸer', i: 'â­' }];

            // DÃœZELTME: Check List maddelerine date alanÄ± eklendi
            const DEF_ITEMS = [
                { cat: 'docs', val: 'Pasaport', date: '' }, { cat: 'docs', val: 'Kimlik / Ehliyet', date: '' }, { cat: 'docs', val: 'UÃ§ak Biletleri', date: '' }, { cat: 'docs', val: 'Otel RezervasyonlarÄ±', date: '' }, { cat: 'docs', val: 'Seyahat SigortasÄ±', date: '' },
                { cat: 'docs', val: 'UÃ§uÅŸ Bilgileri KontrolÃ¼ (KapÄ±/Saat)', date: '' },

                { cat: 'clth', val: 'TiÅŸÃ¶rtler', date: '' }, { cat: 'clth', val: 'Pantolon / Åžort', date: '' }, { cat: 'clth', val: 'Ä°Ã§ Ã‡amaÅŸÄ±rÄ±', date: '' }, { cat: 'clth', val: 'Ã‡oraplar', date: '' }, { cat: 'clth', val: 'Rahat AyakkabÄ±', date: '' }, { cat: 'clth', val: 'Pijama', date: '' },
                { cat: 'elec', val: 'Åžarj Aleti', date: '' }, { cat: 'elec', val: 'Powerbank', date: '' }, { cat: 'elec', val: 'KulaklÄ±k', date: '' }, { cat: 'elec', val: 'Priz DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼', date: '' },
                { cat: 'hlth', val: 'AÄŸrÄ± Kesici', date: '' }, { cat: 'hlth', val: 'Yara BandÄ±', date: '' }, { cat: 'hlth', val: 'KiÅŸisel Ä°laÃ§lar', date: '' }, { cat: 'hlth', val: 'El DezenfektanÄ±', date: '' },
                { cat: 'otr', val: 'GÃ¼neÅŸ GÃ¶zlÃ¼ÄŸÃ¼', date: '' }, { cat: 'otr', val: 'DiÅŸ FÄ±rÃ§asÄ± & Macunu', date: '' }, { cat: 'otr', val: 'Åžampuan & DuÅŸ Jeli', date: '' }
            ];

            const getEmptyForm = () => ({
                id: null,
                trip: '',
                city: '',
                place: '',
                amt: '',
                cur: BASE_CURRENCY,
                date: new Date().toISOString().slice(0, 10),
                cat: '',
                desc: '',
                ppl: '1',
                imgs: [],
                isFuel: false,
                startKm: '',
                endKm: '',
                fuelAmount: '',
                type: EXPENSE_TYPES[0].id,
                isIndividual: false,
            });

            // YENÄ° FONKSÄ°YON: BoÅŸ Rezervasyon Formu
            const getEmptyResForm = () => ({
                id: null,
                trip: '',
                type: RESERVATION_TYPES[0].id,
                name: '', // Rezervasyon adÄ± (Ã¶rn: Hilton Oteli, Pegasus PC1234)
                location: '', // Åžehir/Ãœlke
                startDate: new Date().toISOString().slice(0, 10),
                endDate: '', // UÃ§ak/Oteller iÃ§in
                code: '', // Rezervasyon/PNR kodu
                cost: '',
                cur: BASE_CURRENCY,
                notes: '',
                completed: false,
                isIndividual: false,
                addToCalendar: false, // VarsayÄ±lan: KapalÄ±
            });

            // YENÄ° FONKSÄ°YON: Google Takvim Linki OluÅŸtur
            function getGoogleCalendarUrl(res) {
                const formatDate = (dateStr) => dateStr.replace(/-/g, '');

                const start = formatDate(res.startDate);

                // BitiÅŸ tarihi hesapla (TÃ¼m gÃ¼n etkinliÄŸi iÃ§in +1 gÃ¼n)
                const parts = (res.endDate || res.startDate).split('-');
                const eDate = new Date(parts[0], parts[1] - 1, parts[2]);
                eDate.setDate(eDate.getDate() + 1);

                const y = eDate.getFullYear();
                const m = String(eDate.getMonth() + 1).padStart(2, '0');
                const d = String(eDate.getDate()).padStart(2, '0');
                const end = `${y}${m}${d}`;

                const typeName = (RESERVATION_TYPES.find(t => t.id === res.type) || {}).l || 'Rezervasyon';
                const title = encodeURIComponent(`${typeName}: ${res.name}`);

                const details = encodeURIComponent(
                    `Seyahat: ${res.trip || '-'}\n` +
                    `Kod/PNR: ${res.code || '-'}\n` +
                    `Maliyet: ${res.cost ? res.cost + ' ' + res.cur : '-'}\n\n` +
                    `Notlar:\n${res.notes || '-'}`
                );

                const location = encodeURIComponent(res.location || '');

                return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${end}&details=${details}&location=${location}`;
            }

            // YENÄ° FONKSÄ°YON: BoÅŸ Seyahat Formu
            const getEmptyTripForm = () => ({
                id: null,
                name: '',
                startDate: new Date().toISOString().slice(0, 10),
                endDate: '',
                persons: '',
            });

            function initState() {
                let initialTZ = 'auto';
                try {
                    const browserTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    if (TIMEZONES.some(tz => tz.id === browserTZ)) {
                        initialTZ = browserTZ;
                    }
                } catch (e) {
                    console.error("Zaman dilimi tespiti baÅŸarÄ±sÄ±z oldu:", e);
                }

                let e = [], c = { cats: [...DEF_CATS], items: [] }, r = [], prefTZ = initialTZ; // r[] (Rezervasyonlar) eklendi
                let criticalNotes = [];
                let selectedNoteTrip = '';
                let preferredBaseCurrency = 'TRY';

                try { e = JSON.parse(localStorage.getItem(K.EXP) || '[]'); } catch (err) { }
                try {
                    const l = JSON.parse(localStorage.getItem(K.LIST));
                    if (l) {
                        c.items = l.items || [];
                        c.cats = l.cats || [...DEF_CATS];
                        if (c.cats.length === 0) c.cats = [...DEF_CATS];
                    }
                } catch (err) { }
                // YENÄ°: RezervasyonlarÄ± yÃ¼kle
                try { r = JSON.parse(localStorage.getItem(K.RES) || '[]'); } catch (err) { r = []; }

                try { prefTZ = localStorage.parse(localStorage.getItem(K.PREF + '_tz') || initialTZ); } catch (err) { }
                try { criticalNotes = JSON.parse(localStorage.getItem(K.NOTES) || '[]'); } catch (err) { criticalNotes = []; }
                try { preferredBaseCurrency = localStorage.getItem(K.PREF + '_base_cur') || 'TRY'; } catch (err) { preferredBaseCurrency = 'TRY'; }

                let t = [];
                try { t = JSON.parse(localStorage.getItem(K.TRIPS) || '[]'); } catch (err) { t = []; }

                BASE_CURRENCY = preferredBaseCurrency;

                // Check List Item GeÃ§iÅŸi: date alanÄ± ekle
                if (!c.items || c.items.length === 0) {
                    c.items = DEF_ITEMS.map(i => ({ id: genId(), cat: i.cat, val: i.val, done: false, date: i.date || '' }));
                } else {
                    c.items = c.items.map(i => ({ ...i, date: i.date || '' }));
                }

                // Harcama Veri geÃ§iÅŸi
                e = e.map(item => {
                    const updated = {
                        ...item,
                        imgs: item.imgs || [],
                        isFuel: item.cat === 'fuel',
                        startKm: item.startKm || '',
                        endKm: item.endKm || '',
                        fuelAmount: item.fuelAmount || '',
                        type: item.type || EXPENSE_TYPES[0].id,
                        isIndividual: item.isIndividual !== undefined ? item.isIndividual : false,
                    };
                    delete updated.fuelLocation;
                    delete updated.tripRoute;
                    return updated;
                });

                // Rezervasyon Veri geÃ§iÅŸi
                r = r.map(item => ({
                    ...item,
                    type: item.type || RESERVATION_TYPES[0].id,
                    completed: item.completed !== undefined ? item.completed : false,
                    notes: item.notes || '',
                    isIndividual: item.isIndividual !== undefined ? item.isIndividual : false,
                }));

                const allTrips = [...new Set((e || []).map(x => x.trip).filter(Boolean).concat((r || []).map(x => x.trip).filter(Boolean)))].sort(); // Rezervasyonlardan da seyahat adÄ± al
                if (allTrips.length > 0) {
                    selectedNoteTrip = allTrips[0];
                } else {
                    selectedNoteTrip = 'Genel';
                }

                state = {
                    exp: e,
                    chk: c,
                    res: r, // Yeni: Rezervasyonlar
                    view: 'list',
                    tab: 'sum',
                    tripFilter: '',
                    catFilter: '',
                    search: '',
                    routeTrip: '',
                    typeFilter: '',
                    indFilter: '',
                    selExp: null,
                    selRes: null, // Yeni: SeÃ§ili Rezervasyon
                    selRes: null, // Yeni: SeÃ§ili Rezervasyon
                    modals: { detail: false, chart: false, data: false, tzSelect: false, resForm: false, resDetail: false, tripForm: false }, // resForm ve tripForm eklendi
                    form: getEmptyForm(),
                    resForm: getEmptyResForm(), // Yeni: Rezervasyon formu state'i
                    tripForm: getEmptyTripForm(), // Yeni: Seyahat formu state'i
                    trips: t, // Yeni: KayÄ±tlÄ± Seyahatler
                    expandedCities: {},
                    lightbox: null,
                    err: '',
                    draggedItemId: null,
                    targetTimezone: prefTZ,
                    currentTime: formatTime(prefTZ).time,
                    location: null,
                    locationLoading: false,
                    locationName: 'Bilinmiyor',
                    helpersAccordion: {
                        critical: false,
                        places: false,
                        health: false,
                        transport: false,
                        flightCheck: false,
                        route: false,
                        report: false,
                        data: false,
                        reservations: false, // YENÄ°: Rezervasyon akordiyonu
                    },
                    criticalNotes: criticalNotes,
                    selectedNoteTrip: selectedNoteTrip,
                    newCriticalNote: '',
                    selectedReportTrip: selectedNoteTrip,
                    chartCurrency: preferredBaseCurrency,
                    baseCurrency: preferredBaseCurrency,
                    reportCurrency: preferredBaseCurrency,
                    quickExp: { trip: '', cat: 'food', amt: '', cur: preferredBaseCurrency },
                    quickExpOpen: false,
                };

                state.openChkCats = {};
                (state.chk.cats || []).forEach(x => state.openChkCats[x.id] = false);
            }

            function setState(p) { state = { ...state, ...p }; renderApp(); }

            function save() {
                localStorage.setItem(K.EXP, JSON.stringify(state.exp));
                localStorage.setItem(K.LIST, JSON.stringify(state.chk));
                localStorage.setItem(K.RES, JSON.stringify(state.res)); // RezervasyonlarÄ± kaydet
                localStorage.setItem(K.PREF + '_tz', state.targetTimezone);
                localStorage.setItem(K.NOTES, JSON.stringify(state.criticalNotes));
                localStorage.setItem(K.NOTES, JSON.stringify(state.criticalNotes));
                localStorage.setItem(K.PREF + '_base_cur', state.baseCurrency);
                localStorage.setItem(K.TRIPS, JSON.stringify(state.trips));
                if (!isGuest()) {
                    saveStateToCloud();
                }
            };


            function getUserDocRef() {
                if (!db || !currentUser) return null;
                return db.collection('users').doc(currentUser.uid);
            }

            function loadUserDataFromCloud() {
                if (!db || !currentUser || isCloudLoading) return;
                const ref = getUserDocRef();
                if (!ref) return;
                isCloudLoading = true;
                ref.get()
                    .then(snap => {
                        if (!snap.exists) {
                            // Ä°lk kez giriÅŸ yapÄ±yorsa, mevcut local veriyi buluta yaz
                            saveStateToCloud();
                            return;
                        }
                        const data = snap.data() || {};
                        try {
                            if (Array.isArray(data.exp)) {
                                state.exp = data.exp;
                            }
                            if (Array.isArray(data.res)) {
                                state.res = data.res;
                            }
                            if (data.chk) {
                                state.chk = data.chk;
                            }
                            if (Array.isArray(data.criticalNotes)) {
                                state.criticalNotes = data.criticalNotes;
                            }
                            if (data.targetTimezone) {
                                state.targetTimezone = data.targetTimezone;
                            }
                            if (data.baseCurrency) {
                                state.baseCurrency = data.baseCurrency;
                                state.reportCurrency = data.baseCurrency;
                                state.reportCurrency = data.baseCurrency;
                                state.chartCurrency = data.baseCurrency;
                            }
                            if (Array.isArray(data.trips)) {
                                state.trips = data.trips;
                            }
                            // LocalStorage'i de gÃ¼ncelle
                            save();
                            renderApp();
                        } catch (err) {
                            console.error('Bulut verisi state\'e uygulanÄ±rken hata oluÅŸtu', err);
                        }
                    })
                    .catch(err => {
                        console.error('Bulut verisi okunamadÄ±', err);
                    })
                    .finally(() => {
                        isCloudLoading = false;
                    });
            }

            function saveStateToCloud() {
                if (!db || !currentUser || isCloudSaving) return;
                const ref = getUserDocRef();
                if (!ref) return;
                const payload = {
                    exp: state.exp || [],
                    res: state.res || [],
                    chk: state.chk || {},
                    criticalNotes: state.criticalNotes || [],
                    targetTimezone: state.targetTimezone || '',
                    targetTimezone: state.targetTimezone || '',
                    baseCurrency: state.baseCurrency || 'TRY',
                    trips: state.trips || [],
                    updatedAt: new Date().toISOString()
                };
                isCloudSaving = true;
                ref.set(payload, { merge: true })
                    .catch(err => {
                        console.error('Buluta kaydedilirken hata oluÅŸtu', err);
                    })
                    .finally(() => {
                        isCloudSaving = false;
                    });
            }

            // --- RESÄ°M YENÄ°DEN BOYUTLANDIRMA VE BASE64'E DÃ–NÃœÅžTÃœRME YARDIMCISI ---
            const resizeAndConvertImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => {
                        const image = new Image();
                        image.onload = (imageEvent) => {
                            let canvas = document.createElement('canvas'),
                                max_size = MAX_IMAGE_WIDTH,
                                width = image.width,
                                height = image.height;

                            if (width > height) {
                                if (width > max_size) {
                                    height *= max_size / width;
                                    width = max_size;
                                }
                            } else {
                                if (height > max_size) {
                                    width *= max_size / height;
                                    height = max_size;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            canvas.getContext('2d').drawImage(image, 0, 0, width, height);

                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(dataUrl);
                        };
                        image.onerror = () => {
                            reject(new Error("Resim formatÄ± desteklenmiyor veya bozuk."));
                        };
                        image.src = readerEvent.target.result;
                    };
                    reader.onerror = () => {
                        reject(new Error("Dosya okuma hatasÄ±. Dosya bozuk olabilir."));
                    };
                    reader.readAsDataURL(file);
                });
            };

            // --- KONUM YÃ–NETÄ°MÄ° ---
            const handleGeolocation = () => {
                if (state.locationLoading || state.location) return;

                if (!navigator.geolocation) {
                    setState({
                        err: 'TarayÄ±cÄ±nÄ±z Konum Servislerini desteklemiyor.',
                        locationLoading: false,
                        location: null,
                        locationName: 'Bilinmiyor'
                    });
                    return;
                }

                setState({ locationLoading: true, err: '', locationName: 'AlÄ±nÄ±yor...' });

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // CoÄŸrafi koordinatlardan ÅŸehir ismini almak iÃ§in ters geocoding
                        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;

                        fetch(url, {
                            headers: {
                                'Accept-Language': 'tr'
                            }
                        })
                            .then(resp => resp.json())
                            .then(data => {
                                const addr = data && data.address ? data.address : {};
                                const city =
                                    addr.city ||
                                    addr.town ||
                                    addr.village ||
                                    addr.suburb ||
                                    addr.state ||
                                    data.display_name ||
                                    'Bilinmeyen Konum';

                                setState({
                                    location: {
                                        lat,
                                        lon
                                    },
                                    locationLoading: false,
                                    locationName: city,
                                    err: ''
                                });
                            })
                            .catch(() => {
                                setState({
                                    location: {
                                        lat,
                                        lon
                                    },
                                    locationLoading: false,
                                    locationName: 'Konum BulunamadÄ±',
                                    err: ''
                                });
                            });
                    },
                    (error) => {
                        let message = 'Konum bilgisi alÄ±namadÄ±.';
                        if (error.code === error.PERMISSION_DENIED) {
                            message = 'Konum eriÅŸimi reddedildi. Ä°zin vermeyi deneyin.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            message = 'Konum bilgisi mevcut deÄŸil.';
                        } else if (error.code === error.TIMEOUT) {
                            message = 'Konum bilgisi zaman aÅŸÄ±mÄ±na uÄŸradÄ±.';
                        }

                        setState({
                            err: message,
                            locationLoading: false,
                            location: null,
                            locationName: 'Bilinmiyor'
                        });
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            };

            // --- YARDIMCI FONKSÄ°YON: TÃ¼m Seyahatleri Getir (Harcama + Rezervasyon + Liste) ---
            function getDistinctTripsAll() {
                const tripsFromExp = state.exp.map(x => x.trip).filter(Boolean);
                const tripsFromRes = state.res.map(x => x.trip).filter(Boolean);
                const tripsFromList = state.trips.map(x => x.name).filter(Boolean);
                return [...new Set([...tripsFromExp, ...tripsFromRes, ...tripsFromList])];
            }

            // --- YARDIMCI FONKSÄ°YON: Rota OluÅŸturma Linki (MEKAN BAZLI) ---
            const getRouteUrl = (tripName) => {
                const tripExpenses = state.exp
                    .filter(x => x.trip === tripName)
                    .sort((a, b) => (a.date || '').localeCompare(b.date));

                let uniquePoints = [];
                tripExpenses.forEach(x => {
                    const point = x.place.trim() + ', ' + x.city.trim();

                    if (x.place.trim() && x.city.trim() && (uniquePoints.length === 0 || uniquePoints[uniquePoints.length - 1] !== point)) {
                        uniquePoints.push(point);
                    }
                });

                if (uniquePoints.length < 2) {
                    return { url: '', points: uniquePoints, error: 'Rota iÃ§in en az 2 farklÄ± Mekan kaydÄ± gerekiyor.' };
                }

                const url = `https://www.google.com/maps/dir/${uniquePoints.map(p => encodeURIComponent(p)).join('/')}`;

                return { url, points: uniquePoints, error: '' };
            };

            // KRÄ°TÄ°K DÃœZELTME: AKORDÄ°YON ITEM RENDERER GENEL ALANA TAÅžINDI
            const accordionItem = (id, icon, title, content) => {
                const isOpen = state.helpersAccordion[id];
                // Max height reservation, critical ve report iÃ§in daha fazla olacak
                const maxHeight = (id === 'critical' || id === 'report' || id === 'route' || id === 'reservations') ? '900px' : '500px';

                return `
          <div id="helper-${id}" class="bg-slate-800/60 rounded-xl border border-slate-700/50 shadow-lg overflow-hidden">
              <button data-act="tog-accordion" data-val="${id}" class="w-full flex justify-between items-center p-4 hover:bg-slate-800/80 transition focus:outline-none">
                  <h3 class="flex items-center gap-3 text-base font-bold text-white">
                      ${icon} ${title}
                  </h3>
                  <span class="text-slate-600 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}">
                      ${ICONS.down.replace('w-4 h-4', 'w-4 h-4')}
                  </span>
              </button>
              <div class="transition-all duration-300 ease-in-out overflow-hidden" style="max-height: ${isOpen ? maxHeight : '0'};">
                  <div class="p-4 pt-0">
                      ${content}
                  </div>
              </div>
          </div>
      `;
            };

            // YENÄ° FONKSÄ°YON: REZERVASYON LÄ°STESÄ°NÄ° RENDER ET
            function renderReservationList() {
                const allReservations = state.res
                    .filter(r => state.tripFilter ? r.trip === state.tripFilter : true) // Trip filtresi ekle
                    .sort((a, b) => (a.startDate || '').localeCompare(b.startDate));

                if (!allReservations.length) {
                    return `<div class="text-center py-8 text-slate-500 text-sm border border-dashed border-slate-800 rounded-xl">KayÄ±tlÄ± rezervasyon bulunamadÄ±.</div>`;
                }

                return `
          <div class="space-y-3">
              ${allReservations.map(r => {
                    const type = RESERVATION_TYPES.find(t => t.id === r.type) || RESERVATION_TYPES[0];

                    // Tarihleri hesapla
                    const startDate = fmtDate(r.startDate);
                    const endDate = r.endDate ? fmtDate(r.endDate) : '';
                    // ArtÄ±k sadece baÅŸlangÄ±Ã§ tarihini gÃ¶ster
                    const dateText = startDate;


                    // Fiyat
                    const costText = r.cost ? `${fmtNum(r.cost)} ${r.cur}` : 'Ãœcret: -';

                    return `
                      <div data-act="res-detail" data-id="${r.id}" class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-4 flex justify-between items-start gap-3 cursor-pointer hover:bg-slate-800 transition">
                          <!-- Sol: Ä°kon, BaÅŸlÄ±k, Lokasyon -->
                          <div class="flex items-start gap-3 flex-1 min-w-0">
                              <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gradient-to-br ${type.color} text-xl shadow-md flex-shrink-0">${type.i}</div>
                              <div class="flex-1 min-w-0">
                                  <div class="text-sm font-bold text-white line-clamp-1 ${r.completed ? 'line-through opacity-50' : ''}">${esc(r.name)}</div>
                                  <div class="text-xs text-slate-400 mt-0.5 line-clamp-1">${esc(r.location)} Â· ${esc(r.trip)}</div>
                              </div>
                          </div>
                          
                          <!-- SaÄŸ: Tarih ve Fiyat -->
                          <div class="text-right flex-shrink-0">
                              <div class="text-xs font-bold text-slate-200">${dateText}</div>
                              <div class="text-[10px] font-medium text-slate-500 mt-0.5">${costText}</div>
                          </div>
                      </div>
                  `;
                }).join('')}
          </div>
      `;
            }

            // YENÄ° FONKSÄ°YON: REZERVASYON MODALI (Form)
            function renderResForm() {
                const f = state.resForm;
                const allTrips = getDistinctTripsAll().sort();
                const resTypes = RESERVATION_TYPES;

                const isFlight = f.type === 'flight';
                const isMultiDay = f.type === 'hotel' || f.type === 'flight'; // UÃ§ak ve Otel iÃ§in bitiÅŸ tarihi zorunlu

                return `
        <div class="form-modal-overlay">
          <div class="bg-slate-900 w-full max-w-lg md:rounded-xl rounded-t-xl form-content-box p-4 border border-slate-800 shadow-2xl self-start mt-0 md:mt-4 mb-4">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-slate-900 pt-1 pb-3 z-10 border-b border-slate-800 -mx-4 px-4">
              <h2 class="font-bold text-lg text-white">${f.id ? 'Rezervasyonu DÃ¼zenle' : 'Yeni Rezervasyon'}</h2>
              <button data-act="cancel-res" class="text-slate-400 hover:text-white transition">${ICONS.x}</button>
            </div>
            
            <div class="space-y-3">
              
              <!-- REZERVASYON TÄ°PÄ° -->
              <div>
                 <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Rezervasyon Tipi</label>
                 <div class="flex gap-2 overflow-x-auto pb-2 scrl">
                   ${resTypes.map(t => `
                     <button type="button" data-act="set-res-type" data-val="${t.id}" class="flex-shrink-0 flex flex-col items-center justify-center w-20 h-16 rounded-lg border transition ${f.type === t.id ? 'bg-blue-600/20 border-blue-500 text-white shadow-lg shadow-blue-500/20' : 'bg-slate-800 border-slate-700 text-slate-500 hover:border-slate-500'}">
                     <span class="text-xl mb-1">${t.i}</span><span class="text-[9px] font-bold">${t.l}</span>
                     </button>`).join('')}
                 </div>
              </div>

              <!-- REZERVASYON ADI -->
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Rezervasyon AdÄ± / BaÅŸlÄ±ÄŸÄ±</label>
                <input id="i-res-name" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500" placeholder="${isFlight ? 'UÃ§uÅŸ Åžirketi ve No (THY TK123)' : 'Otel AdÄ± / Etkinlik AdÄ±'}" value="${esc(f.name)}">
              </div>

              <!-- SEYAHAT ve LOKASYON -->
              <div class="grid grid-cols-2 gap-3">
                 <div>
                   <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Seyahat</label>
                   <div class="relative">
                      <select id="i-res-trip" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500 appearance-none cursor-pointer">
                          <option value="">Seyahat SeÃ§...</option>
                          ${allTrips.map(t => `<option value="${esc(t)}" ${f.trip === t ? 'selected' : ''}>${esc(t)}</option>`).join('')}
                          <option value="__new__" class="font-bold text-emerald-400">+ Yeni Seyahat OluÅŸtur</option>
                      </select>
                      <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                      </div>
                   </div>
               
                 </div>
                 <div>
                   <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Konum (Åžehir/Ãœlke)</label>
                   <input id="i-res-location" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500" placeholder="Ã–rn: Roma, Ä°talya" value="${esc(f.location)}">
                 </div>
              </div>
              
              <!-- TARÄ°H (REZERVASYON) -->
<div class="mt-3">
  <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">
    BaÅŸlangÄ±Ã§ Tarihi
  </label>
  <div class="flex items-center bg-slate-800 border border-slate-700 rounded-lg px-3 py-2">
    <input
      id="i-res-start-date"
      type="date"
      class="w-full bg-transparent border-none outline-none text-sm text-slate-200"
      value="${f.startDate}"
    >
  </div>

  <!-- JS tarafÄ± bozulmasÄ±n diye gizli bitiÅŸ tarihi -->
  <input
    id="i-res-end-date"
    type="hidden"
    value="${f.endDate || f.startDate}"
  >
</div>


              <!-- KOD ve Tutar -->
              <div class="grid grid-cols-2 gap-3">
                 <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">${isFlight ? 'PNR/KOD' : 'Kod/Link'}</label>
                    <input id="i-res-code" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500" placeholder="${isFlight ? 'ABCDEF' : 'Web Linki / Kodu'}" value="${esc(f.code)}">
                 </div>
                 <div class="relative">
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Maliyet</label>
                    <input id="i-res-cost" type="text" inputmode="decimal" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500 font-mono" placeholder="0.00" value="${esc(f.cost)}">
                    <select id="i-res-cur" class="absolute right-1 top-[28px] bottom-1 bg-slate-700 text-slate-200 rounded-md text-xs px-2 outline-none border-l border-slate-600 cursor-pointer">
                       ${AVAILABLE_CURRENCIES.map(c => `<option value="${c}" ${f.cur === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                 </div>
              </div>
              
              <!-- BÄ°REYSEL / ORTAK -->
              <div class="flex items-center gap-3">
                <div class="flex-1">
                  <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Bu Rezervasyon</label>
                  <div class="inline-flex gap-2 rounded-lg bg-slate-800/80 p-1 border border-slate-700 w-full">
                    <button
                      type="button"
                      data-act="set-res-ind"
                      data-val="shared"
                      class="flex-1 text-xs font-semibold px-2 py-1.5 rounded-md ${!f.isIndividual ? 'bg-emerald-500/20 text-emerald-200 border border-emerald-400/60' : 'text-slate-300 border border-transparent'
                    }">
                      Ortak
                    </button>
                    <button
                      type="button"
                      data-act="set-res-ind"
                      data-val="individual"
                      class="flex-1 text-xs font-semibold px-2 py-1.5 rounded-md ${f.isIndividual ? 'bg-amber-500/25 text-amber-100 border border-amber-400/70' : 'text-slate-300 border border-transparent'
                    }">
                      Bireysel
                    </button>
                  </div>
                </div>
                
                <!-- Ã–DENDÄ° (Ä°S SETTLED) -->
                <div>
                   <label class="block text-xs font-bold text-slate-500 mb-1 uppercase opacity-0">D</label>
                   <div class="flex items-center gap-2 bg-slate-800/80 border border-slate-700 rounded-lg px-3 py-[7px] h-[38px]">
                      <input type="checkbox" id="i-res-settled" ${f.isSettled ? 'checked' : ''} class="custom-checkbox w-4 h-4 rounded border-slate-600 bg-slate-700 cursor-pointer">
                      <label for="i-res-settled" class="text-xs font-semibold text-slate-300 cursor-pointer select-none">Ã–dendi</label>
                   </div>
                </div>
              </div>

              <!-- HARCAMAYI YAPAN (PAYER) - REZERVASYON Ä°Ã‡Ä°N -->
              <div id="res-payer-wrapper" style="display: ${f.isIndividual ? 'none' : 'block'}">
                 ${(() => {
                        const currentTripObj = (state.trips || []).find(t => t.name === f.trip);
                        const tripPersons = currentTripObj ? currentTripObj.persons.split(',').map(p => p.trim()).filter(Boolean) : [];

                        if (tripPersons.length > 0) {
                            const payerOptions = tripPersons.map(p => `<option value="${esc(p)}" ${f.payer === p ? 'selected' : ''}>${esc(p)}</option>`).join('');
                            return `
                          <div class="mt-3">
                             <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Ã–demeyi Yapan</label>
                             <div class="relative">
                                <select id="i-res-payer" required class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500 appearance-none cursor-pointer">
                                   <option value="">-- SeÃ§iniz --</option>
                                   ${payerOptions}
                                </select>
                                <div class="absolute right-3 top-3.5 text-slate-400 pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
                             </div>
                          </div>
                         `;
                        }
                        return '';
                    })()}
              </div>

              <!-- NOTLAR -->
              <textarea id="i-res-notes" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none resize-none" placeholder="Ekstra Notlar (Check-in saati, koltuk no, vb.)">${esc(f.notes)}</textarea>



              <!-- GOOGLE TAKVÄ°M SEÃ‡ENEÄžÄ° -->
              <div class="flex items-center gap-3 bg-slate-800/50 border border-slate-700 rounded-lg p-3 mb-3">
                <input type="checkbox" id="i-res-calendar" ${f.addToCalendar ? 'checked' : ''} class="custom-checkbox w-5 h-5 rounded border-slate-600 bg-slate-700 cursor-pointer">
                <label for="i-res-calendar" class="flex-1 text-sm text-slate-200 cursor-pointer">
                  <span class="font-semibold">ðŸ“… Google Takvim'e Ekle</span>
                  <span class="block text-xs text-slate-400 mt-0.5">Kaydettikten sonra Google Takvim aÃ§Ä±lacak</span>
                </label>
              </div>

              <button type="button" data-act="save-res" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-blue-500/30 transition">Kaydet</button>
            </div>
          </div>
        </div>
      `;
            }

            // YENÄ° FONKSÄ°YON: REZERVASYON DETAY MODALI
            function renderResDetailModal() {
                const r = state.res.find(res => res.id === state.selRes);
                if (!r) return '';

                const type = RESERVATION_TYPES.find(t => t.id === r.type) || RESERVATION_TYPES[0];

                const startDate = fmtDate(r.startDate);
                const endDate = r.endDate ? fmtDate(r.endDate) : '';
                const dateText = endDate && startDate !== endDate ? `${startDate} - ${endDate}` : startDate;

                const costText = r.cost ? `${fmtNum(r.cost)} ${r.cur}` : 'Ãœcretsiz / Bilinmiyor';
                const codeText = r.code ? esc(r.code) : '-';

                const badgeCls = 'flex items-center gap-1.5 bg-white/10 px-2 py-0.5 rounded-full border border-white/20 backdrop-blur-md text-white text-xs font-bold shadow-sm';

                return `
        <div class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-start justify-center p-0 md:p-4 animate-[fadeIn_0.2s] mt-4" data-act="close-mod" data-val="resDetailOverlay">
          <div class="bg-slate-900 w-full max-w-md md:rounded-xl rounded-t-xl overflow-hidden shadow-2xl relative border border-slate-800" data-act="noop">
             
             <!-- SABÄ°T GRADIENT BAÅžLIK -->
             <div class="relative p-4 pb-10 overflow-hidden bg-gradient-to-r ${type.color} fixed-gradient-header">
                <div class="absolute inset-0 backdrop-blur-[2px]"></div>
                
                <div class="relative z-10 flex justify-between items-start mb-2">
                  <div class="flex items-center gap-2">
                     <!-- TÄ°P VE DURUM -->
                     <div class="${badgeCls}">
                        <span>${type.i}</span><span class="text-xs font-bold uppercase">${type.l}</span>
                     </div>
                     <div class="${badgeCls} ${r.completed ? 'bg-emerald-600/50 border-emerald-500/50' : 'bg-red-600/50 border-red-500/50'}">
                        ${r.completed ? 'TamamlandÄ±' : 'Bekliyor'}
                     </div>
                  </div>
                  <button data-act="close-mod" data-val="resDetail" class="bg-black/20 hover:bg-black/40 text-white rounded-full p-1.5 transition backdrop-blur-md">${ICONS.x}</button>
                </div>

                <div class="relative z-10 mt-1">
                   <h2 class="text-xl font-bold text-white mb-1 leading-tight drop-shadow-md">${esc(r.name)}</h2>
                   
                   <div class="flex items-center gap-2 text-white/80 text-xs font-medium">
                      <span class="bg-black/20 px-2 py-0.5 rounded-full text-[10px]">${esc(r.location)}</span>
                      <span class="w-1 h-1 rounded-full bg-white/60"></span>
                      <span>${dateText}</span>
                   </div>
                   
                   <div class="relative z-10 mt-4 flex justify-between items-end">
                       <div class="inline-block">
                           <div class="text-[10px] text-white/80 font-medium">Seyahat</div>
                           <div class="text-sm font-bold text-white">${esc(r.trip || 'Genel')}</div>
                       </div>
                       <div class="text-right inline-block">
                           <div class="text-[10px] text-white/80">Maliyet</div>
                           <div class="text-xl font-bold text-white tracking-tight text-center">${costText}</div>
                       </div>
                   </div>
                </div>
             </div>

             <!-- Body -->
             <div class="bg-slate-900 p-4 space-y-3 overflow-y-auto max-h-[70vh]">
               
               <!-- KOD/LÄ°NK -->
               <div class="bg-slate-800/30 rounded-lg p-3 border border-slate-700/50">
                 <div class="text-xs font-bold text-slate-500 mb-1 uppercase">${type.id === 'flight' ? 'PNR/UÃ§uÅŸ Kodu' : 'Rezervasyon Kodu/Link'}</div>
                 <p class="text-sm text-blue-400 whitespace-pre-wrap leading-relaxed">${codeText}</p>
                 ${r.code && (r.code.startsWith('http') || r.code.startsWith('www')) ? `
                    <a href="${r.code.startsWith('http') ? r.code : `http://${r.code}`}" target="_blank" class="text-xs text-blue-300 hover:text-blue-200 mt-1 block">Linki AÃ§</a>
                 ` : ''}
               </div>

               <!-- NOTLAR -->
               <div class="bg-slate-800/30 rounded-lg p-3 border border-slate-700/50 min-h-[50px]">
                 <div class="text-xs font-bold text-slate-500 mb-1 uppercase">Notlar</div>
                 <p class="text-sm text-slate-300 whitespace-pre-wrap leading-relaxed">${esc(r.notes) || '<span class="italic text-slate-600">Ekstra not yok.</span>'}</p>
               </div>

               <!-- GOOGLE TAKVÄ°M BUTONU -->
               <a href="${getGoogleCalendarUrl(r)}" target="_blank" class="block w-full text-center bg-slate-800 hover:bg-slate-700 text-blue-400 font-bold text-sm py-3 rounded-lg border border-slate-700/50 transition mb-2 flex items-center justify-center gap-2">
                   <span>ðŸ“…</span> <span>Google Takvim'e Ekle (Web)</span>
               </a>

               <div class="flex gap-3 pt-2">
                 <button data-act="del-res-detail" class="flex-1 py-2.5 rounded-lg font-bold text-sm bg-gradient-to-r from-red-600/10 to-rose-700/10 text-red-400 border border-red-500/20 hover:from-red-600 hover:to-rose-700 hover:text-white transition flex items-center justify-center gap-1.5">
                   ${ICONS.trash.replace('w-4 h-4', 'w-3.5 h-3.5')} Sil
                 </button>
                 <button data-act="edit-res" class="flex-1 py-2.5 rounded-lg font-bold text-sm bg-slate-800 text-slate-200 border border-slate-700 hover:bg-slate-700 transition flex items-center justify-center gap-1.5">
                   ${ICONS.edit.replace('w-4 h-4', 'w-3.5 h-3.5')} DÃ¼zenle
                 </button>
                 <button data-act="toggle-res-complete" class="flex-1 py-2.5 rounded-lg font-bold text-sm ${r.completed ? 'bg-emerald-600/80 text-white' : 'bg-slate-600/80 text-slate-200'} border border-slate-500/50 hover:opacity-80 transition">
                   ${r.completed ? 'Beklemede' : 'Tamamla'}
                 </button>
               </div>
             </div>
          </div>
        </div>`;
            }


            // YENÄ° FONKSÄ°YON: SEYAHAT FORMU (RENDER)
            function renderTripForm() {
                const f = state.tripForm;
                return `
                <div class="form-modal-overlay">
                    <div class="bg-slate-900 w-full max-w-md md:rounded-xl rounded-t-xl form-content-box p-4 border border-slate-800 shadow-2xl self-center mt-4">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-800 pb-2">
                             <div class="flex items-center gap-2">
                                <div class="bg-emerald-600/20 p-2 rounded-lg text-emerald-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                                </div>
                                <h2 class="font-bold text-lg text-white">${f.id ? 'Seyahat DÃ¼zenle' : 'Yeni Seyahat'}</h2>
                            </div>
                            <button data-act="cancel-trip" class="text-slate-400 hover:text-white transition bg-slate-800 p-1.5 rounded-lg hover:bg-slate-700">${ICONS.x}</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Seyahat AdÄ±</label>
                                <div class="relative">
                                    <input id="i-trip-name" class="w-full bg-slate-800 border border-slate-700/70 rounded-xl p-3 pl-10 text-sm text-slate-200 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 transition" placeholder="Ã–rn: Ä°talya Yaz Tatili" value="${esc(f.name)}">
                                    <div class="absolute left-3 top-3.5 text-slate-500 icon-sm">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                </div>
                            </div>

                            <div class="block sm:grid sm:grid-cols-2 sm:gap-3 space-y-3 sm:space-y-0 w-full">
                                <div class="w-full">
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">BaÅŸlangÄ±Ã§</label>
                                    <input id="i-trip-start" type="date" class="w-full bg-slate-800 border border-slate-700/70 rounded-xl p-3 text-sm text-slate-200 outline-none focus:border-emerald-500 transition" value="${f.startDate}">
                                </div>
                                <div class="w-full">
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">BitiÅŸ (Opsiyonel)</label>
                                    <input id="i-trip-end" type="date" class="w-full bg-slate-800 border border-slate-700/70 rounded-xl p-3 text-sm text-slate-200 outline-none focus:border-emerald-500 transition" value="${f.endDate}">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">KatÄ±lÄ±mcÄ±lar</label>
                                <div class="relative">
                                    <input id="i-trip-persons" class="w-full bg-slate-800 border border-slate-700/70 rounded-xl p-3 pl-10 text-sm text-slate-200 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 transition" placeholder="Ali, Veli, AyÅŸe (VirgÃ¼lle ayÄ±rÄ±n)" value="${esc(f.persons)}">
                                    <div class="absolute left-3 top-3.5 text-slate-500">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                    </div>
                                </div>
                                <p class="text-[10px] text-slate-500 mt-1.5 ml-1">Ortak harcamalarda masrafÄ± bÃ¶lÃ¼ÅŸecek kiÅŸileri buraya girin.</p>
                            </div>

                            <div class="flex gap-3 pt-2">
                                ${f.id ? `
                                <button type="button" data-act="del-trip" data-id="${f.id}" class="flex-1 bg-red-600/10 hover:bg-red-600 border border-red-600/30 text-red-500 hover:text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                                    ${ICONS.trash.replace('w-4 h-4', 'w-4 h-4')} Sil
                                </button>
                                ` : ''}
                                <button type="button" data-act="save-trip" class="flex-[2] bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-500/30 transition flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    ${f.id ? 'Kaydet' : 'OluÅŸtur'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            // YENÄ° FONKSÄ°YON: UÃ‡UÅžLAR VE REZERVASYONLAR AKORDÄ°YONU

            function renderReservationsAccordion() {
                // RezervasyonlarÄ±n baÅŸlÄ±ÄŸÄ± ve listesi
                const reservationHeader = `
                <div class="w-full flex justify-between items-center pb-3">
              <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                 ${ICONS.reserve.replace('w-4 h-4', 'w-4 h-4')} Rezervasyonlar
              </h4>
              <button
                type="button"
                data-act="new-res"
                class="bg-blue-600 hover:bg-blue-500 text-xs font-bold transition px-3 py-1 rounded-lg flex items-center justify-center gap-1">
                 ${ICONS.plus.replace('w-4 h-4', 'w-3.5 h-3.5')} Ekle
              </button>
          </div>
                ${renderReservationList()}
            `;

                // UÃ§uÅŸ linkleri iÃ§eriÄŸi
                const flightCheckContent = `
                <p class="text-xs text-slate-400 mb-3">
                    UÃ§uÅŸlarÄ± aramak ve canlÄ± takip etmek iÃ§in harici servisleri kullanabilirsiniz.
          </p>
                <div class="grid grid-cols-2 gap-3">
                    <a
                        href="https://www.google.com/flights"
                        target="_blank"
                        class="bg-slate-900/70 border border-slate-700/70 rounded-xl px-3 py-3 flex flex-col items-center justify-center hover:bg-slate-800/80 hover:border-slate-500 transition shadow-sm">
                        <div class="text-xl mb-1">âœˆï¸</div>
                        <span class="text-xs font-bold text-white/90 text-center leading-tight">
                            Google Flights
                        </span>
                    </a>
                    <a
                        href="https://www.flightradar24.com/"
                        target="_blank"
                        class="bg-slate-900/70 border border-slate-700/70 rounded-xl px-3 py-3 flex flex-col items-center justify-center hover:bg-slate-800/80 hover:border-slate-500 transition shadow-sm">
                        <div class="text-xl mb-1">ðŸ“¡</div>
                        <span class="text-xs font-bold text-white/90 text-center leading-tight">
                            CanlÄ± UÃ§uÅŸ Takibi
                        </span>
                    </a>
                </div>
            `;

                return `
          ${accordionItem(
                    'reservations',
                    ICONS.reserve.replace('w-4 h-4', 'w-4 h-4'),
                    'Rezervasyonlar',
                    `
                <div class="space-y-4 pt-3">
                    ${reservationHeader}
                </div>
              `
                )
                    }
          ${accordionItem(
                        'flightCheck',
                        ICONS.flight.replace('w-4 h-4', 'w-4 h-4'),
                        'UÃ§uÅŸlar',
                        `
                <div class="space-y-4 pt-3">
                    ${flightCheckContent}
                </div>
              `
                    )
                    }
            `;
            }


            // YENÄ° FONKSÄ°YON: BORÃ‡ HESAPLAMA
function calculateDebts(tripName, targetCurrency = (state.baseCurrency || BASE_CURRENCY)) {
    const trip = (state.trips || []).find(t => t.name === tripName);
    if (!trip || !trip.persons) return null;

    const persons = String(trip.persons || '')
        .split(',')
        .map(p => p.trim())
        .filter(Boolean);

    if (persons.length < 2) return null;

    // Ortak harcamalar + (Ã¶denmemiÅŸ) ortak rezervasyonlar
    const sharedExps = (state.exp || []).filter(x =>
        x.trip === tripName &&
        !x.isIndividual &&
        !isNaN(Number(x.amt)) &&
        Number(x.amt) > 0
    );

    const sharedRes = (state.res || []).filter(r =>
        r.trip === tripName &&
        !r.isIndividual &&
        !r.isSettled &&
        !isNaN(Number(r.cost)) &&
        Number(r.cost) > 0
    );

    if (!sharedExps.length && !sharedRes.length) return null;

    // KiÅŸi bakiyeleri (pozitif: alacaklÄ±, negatif: borÃ§lu)
    const balances = {};
    persons.forEach(p => balances[p] = 0);

    const dataWarnings = [];
    let totalSharedCost = 0;

    const addPaid = (payerName, amount, meta) => {
        const valid = (payerName && Object.prototype.hasOwnProperty.call(balances, payerName));
        const payer = valid ? payerName : persons[0];

        if (!valid) {
            dataWarnings.push({
                type: 'missing_payer',
                trip: tripName,
                fallback: payer,
                meta: meta || null
            });
        }

        balances[payer] += amount;
    };

    sharedExps.forEach(x => {
        const amt = convertToBase(Number(x.amt) || 0, x.cur || targetCurrency, targetCurrency);
        totalSharedCost += amt;
        addPaid(x.payer, amt, { kind: 'expense', id: x.id, place: x.place, city: x.city });
    });

    sharedRes.forEach(r => {
        const amt = convertToBase(Number(r.cost) || 0, r.cur || targetCurrency, targetCurrency);
        totalSharedCost += amt;
        addPaid(r.payer, amt, { kind: 'reservation', id: r.id, name: r.name, location: r.location });
    });

    const sharePerPerson = totalSharedCost / persons.length;

    // Herkes kendi payÄ±nÄ± Ã¶demeli: bakiyeden payÄ± dÃ¼ÅŸ
    persons.forEach(p => { balances[p] -= sharePerPerson; });

    // HesaplaÅŸma (kim kime ne Ã¶deyecek)
    const debtors = [];
    const creditors = [];

    Object.entries(balances).forEach(([p, bal]) => {
        if (bal < -0.01) debtors.push({ p, bal });
        else if (bal > 0.01) creditors.push({ p, bal });
    });

    debtors.sort((a, b) => a.bal - b.bal);   // en borÃ§lu Ã¶nce
    creditors.sort((a, b) => b.bal - a.bal); // en alacaklÄ± Ã¶nce

    const transactions = [];
    let i = 0, j = 0;

    while (i < debtors.length && j < creditors.length) {
        const debtor = debtors[i];
        const creditor = creditors[j];

        const amount = Math.min(Math.abs(debtor.bal), creditor.bal);

        transactions.push({ from: debtor.p, to: creditor.p, amount });

        debtor.bal += amount;
        creditor.bal -= amount;

        if (Math.abs(debtor.bal) < 0.01) i++;
        if (creditor.bal < 0.01) j++;
    }

    // Yuvarlama kaynaklÄ± Ã§ok kÃ¼Ã§Ã¼k kalÄ±ntÄ±larÄ± temizle
    const cleanedBalances = {};
    Object.entries(balances).forEach(([p, bal]) => {
        cleanedBalances[p] = Math.abs(bal) < 0.005 ? 0 : bal;
    });

    return {
        persons,
        totalShared: totalSharedCost,
        sharePerPerson,
        transactions,
        balances: cleanedBalances,
        dataWarnings,
        currency: targetCurrency
    };
}

// YENÄ° FONKSÄ°YON: RAPOR AKORDÄ°YON Ä°Ã‡ERÄ°ÄžÄ°

            function renderReportContent() {
                const allTrips = [...new Set(state.exp.map(x => x.trip).filter(Boolean).concat(state.res.map(x => x.trip).filter(Boolean)))].sort();
                let selectedTrip = state.selectedReportTrip;

                if (!allTrips.includes(selectedTrip)) {
                    selectedTrip = allTrips[0] || 'Genel';
                    state.selectedReportTrip = selectedTrip;
                }

                const tripExpenses = getTripExpenses(selectedTrip);

                const tripOptions = allTrips.map(t => `<option value="${esc(t)}" ${selectedTrip === t ? 'selected' : ''}>${esc(t)}</option>`).join('');

                const reportCur = state.reportCurrency;
                const currencyOptions = AVAILABLE_CURRENCIES.map(c =>
                    `<option value="${c}" ${c === reportCur ? 'selected' : ''}>${c}</option>`
                ).join('');


                if (!tripExpenses.length) {
                    return `
                <div class="space-y-4 pt-3">
                  <!-- SEYAHAT SEÃ‡Ä°MÄ° -->
                  <div>
                     <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Raporlanacak Seyahat SeÃ§imi</label>
                     <div class="relative">
                       <select
                       data-act="set-report-trip"
                       class="w-full bg-slate-950/50 border border-slate-700/70 rounded-lg px-3 py-2 text-xs text-slate-100 outline-none focus:border-white cursor-pointer backdrop-blur-sm">

                         ${tripOptions}
                       </select>
                     </div>
                  </div>
                  <div class="text-center py-6 bg-slate-900/50 border border-slate-700 rounded-xl text-slate-400 text-sm">
                      <div class="mb-2 text-2xl">ðŸ“</div>
                      SeÃ§ilen seyahat iÃ§in harcama kaydÄ± bulunmamaktadÄ±r.
                  </div>
              </div>
                `;
                }

                let totalInReportCur = 0;
                tripExpenses.forEach(x => {
                    totalInReportCur += convertToBase(x.amt, x.cur, reportCur);
                });

                const totalsByCurrency = {};
                tripExpenses.forEach(x => {
                    const cur = x.cur || BASE_CURRENCY;
                    const amt = Number(x.amt) || 0;
                    totalsByCurrency[cur] = (totalsByCurrency[cur] || 0) + amt;
                });
                const originalSummary = Object.entries(totalsByCurrency)
                    .sort((a, b) => b[1] - a[1])
                    .map(([cur, amt]) => `<span class="bg-violet-700/50 px-3 py-1 rounded-full text-sm font-bold">${fmtNum(amt)} <span class="text-xs font-normal">${cur}</span></span>`)
                    .join('');

                const categoryDataReport = {};
                tripExpenses.forEach(x => {
                    const cat = x.cat || 'other';
                    const amtInReportCur = convertToBase(x.amt, x.cur, reportCur);
                    categoryDataReport[cat] = (categoryDataReport[cat] || 0) + amtInReportCur;
                });

                const topCategories = Object.entries(categoryDataReport)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 3)
                    .map(([catId, amt], index) => {
                        const catInfo = CATS[catId] || CATS.other;
                        return `
                <div class="flex items-center justify-between p-3 rounded-lg border border-slate-700/50 bg-slate-800/50">
                      <span class="text-sm font-medium text-slate-200 flex items-center gap-2">
                          ${catInfo.i} ${esc(catInfo.l)}
                      </span>
                      <span class="font-bold text-white">${fmtNum(amt)} ${reportCur}</span>
                  </div>
                `;
                    }).join('');

                const cityPlaceTotals = {};
                tripExpenses.forEach(x => {
                    const key = `${x.city} / ${x.place}`;
                    const amtInReportCur = convertToBase(x.amt, x.cur, reportCur);
                    cityPlaceTotals[key] = (cityPlaceTotals[key] || 0) + amtInReportCur;
                });
                const topLocations = Object.entries(cityPlaceTotals)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 3)
                    .map(([key, amt], index) => {
                        const [city, place] = key.split(' / ');
                        return `
                  <div class="flex items-center justify-between p-3 rounded-lg border border-slate-700/50 bg-slate-800/50">
                      <span class="text-sm font-medium text-slate-200">
                          <span class="font-bold text-white">${esc(place)}</span> <span class="text-slate-400">(${esc(city)})</span>
                      </span>
                      <span class="font-bold text-white">${fmtNum(amt)} ${reportCur}</span> 
                  </div>
              `;
                    }).join('');

                const allImages = tripExpenses
                    .flatMap(x => x.imgs || [])
                    .filter(Boolean);

                const uniqueImages = [...new Set(allImages)].slice(0, 10);

                const imagePreview = uniqueImages.length > 0 ? `
          <div class="grid grid-cols-5 gap-2">
              ${uniqueImages.map(img => `
                  <div class="aspect-square rounded-lg overflow-hidden border border-slate-700 bg-slate-800">
                      <img src="${img}" data-act="lb" class="w-full h-full object-cover cursor-zoom-in hover:scale-110 transition duration-300">
                  </div>
              `).join('')}
          </div>
      ` : '<p class="text-sm text-slate-500 italic">Bu seyahatte eklenmiÅŸ fotoÄŸraf bulunmamaktadÄ±r.</p>';

                const notesForTrip = state.criticalNotes
                    .filter(n => n.trip === selectedTrip)
                    .map(n => `<li class="text-sm text-slate-300 list-disc ml-4">${esc(n.note)}</li>`).join('');

                // BORÃ‡ HESAPLAMA VE HTML OLUÅžTURMA
                const debtInfo = calculateDebts(selectedTrip);
                let debtHtml = '';

                if (debtInfo && debtInfo.transactions.length > 0) {
                    const debtRows = debtInfo.transactions.map(t => `
                <div class="flex justify-between items-center bg-slate-700/50 p-2 rounded text-xs border border-slate-600/50">
                    <span class="text-red-400 font-bold w-1/3 truncate">${esc(t.from)}</span>
                    <span class="text-slate-500 text-center w-8">âž¡ï¸</span>
                    <span class="text-emerald-400 font-bold w-1/3 truncate text-right">${esc(t.to)}</span>
                    <span class="font-bold text-white w-1/4 text-right">${fmtNum(t.amount)} ${debtInfo.currency}</span>
                </div>
             `).join('');

const warnHtml = (debtInfo.dataWarnings && debtInfo.dataWarnings.length)
                    ? `
                <div class="mt-2 text-[11px] bg-amber-900/20 border border-amber-700/40 rounded p-2">
                    <div class="font-bold text-amber-300 mb-1">Veri UyarÄ±larÄ±</div>
                    <div class="text-slate-200">BazÄ± kalemlerde â€œÃ–deyenâ€ bilgisi eksik/uyumsuz. Bu raporda sistem geÃ§ici olarak ilk kiÅŸiyi varsayarak hesapladÄ±. LÃ¼tfen ilgili kaydÄ± dÃ¼zenleyip doÄŸru kiÅŸiyi seÃ§in.</div>
                    <ul class="mt-2 space-y-1">
                        ${debtInfo.dataWarnings.slice(0, 12).map(w => {
                            const meta = w.meta || {};
                            const label = (meta.kind === 'expense')
                                ? `Harcama: ${esc(meta.place || '')}${meta.city ? ' (' + esc(meta.city) + ')' : ''}`
                                : `Rezervasyon: ${esc(meta.name || '')}${meta.location ? ' (' + esc(meta.location) + ')' : ''}`;
                            return `<li class="text-amber-100">â€¢ ${label}</li>`;
                        }).join('')}
                    </ul>
                </div>
                    `
                    : '';

                    debtHtml = `
            <!-- BorÃ§ DaÄŸÄ±lÄ±mÄ± (YENÄ°) -->
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
                <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                   ðŸ‘¥ BorÃ§ / Alacak Durumu (HesaplaÅŸma)
                </h4>
                <div class="space-y-2">
                    <div class="text-[10px] text-slate-400 mb-2 p-2 bg-slate-900/50 rounded border border-slate-800">
                        <div class="flex justify-between"><span>Toplam Ortak Harcama:</span> <span class="text-slate-200 font-mono">${fmtNum(debtInfo.totalShared)} ${debtInfo.currency}</span></div>
                        <div class="flex justify-between"><span>KiÅŸi BaÅŸÄ± DÃ¼ÅŸen Pay:</span> <span class="text-slate-200 font-mono">${fmtNum(debtInfo.sharePerPerson)} ${debtInfo.currency}</span></div>
                    </div>
                    ${debtRows}
                    ${warnHtml}
                </div>
            </div>
             `;
                } else if (debtInfo) {
                    // HesaplaÅŸÄ±lacak bir durum yoksa ama seyahat 'kiÅŸili' ise yine de gÃ¶sterebiliriz veya boÅŸ geÃ§ebiliriz.
                    // BoÅŸ geÃ§elim.
                }

                return `
          <div class="space-y-4 pt-3">
              
              <!-- SEYAHAT SEÃ‡Ä°MÄ° VE RAPOR PARA BÄ°RÄ°MÄ° (YANYANA) -->
              <div class="grid grid-cols-2 gap-3">
                  <div>
                     <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Seyahat</label>
                     <div class="relative">
                       <select data-act="set-report-trip" class="w-full bg-slate-950/50 border border-white/30 rounded-lg py-2 px-3 pr-8 text-sm text-white outline-none focus:border-white appearance-none cursor-pointer backdrop-blur-sm">
                         ${tripOptions}
                       </select>
                       <div class="absolute right-3 top-2.5 text-white pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
                     </div>
                  </div>
                  <!-- YENÄ°: RAPOR PARA BÄ°RÄ°MÄ° SEÃ‡Ä°MÄ° -->
                  <div>
                     <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Rapor Para Birimi</label>
                     <div class="relative">
                       <select data-act="set-report-currency" class="w-full bg-slate-950/50 border border-white/30 rounded-lg py-2 px-3 pr-8 text-sm text-white outline-none focus:border-white appearance-none cursor-pointer backdrop-blur-sm">
                         ${currencyOptions}
                       </select>
                       <div class="absolute right-3 top-2.5 text-white pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
                     </div>
                  </div>
              </div>


              <div class="bg-gradient-to-r from-blue-900/40 to-indigo-900/40 border border-blue-700/50 rounded-xl p-4">
                  <h3 class="text-lg font-bold text-white mb-2">${selectedTrip} Seyahat Ã–zeti</h3>
                  <div class="text-[10px] text-slate-400">Toplam Harcama: <span class="font-bold text-white">${fmtNum(totalInReportCur)} ${reportCur}</span>'a dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸtÃ¼r. (${tripExpenses.length} kayÄ±t)</div>
              </div>
              <div class="flex items-center gap-2 text-[11px] text-slate-200">
                <span>Bu seyahatin detaylÄ± harcama dÃ¶kÃ¼mÃ¼nÃ¼ PDF olarak</span>
                <button
                  type="button"
                  data-act="export-pdf" data-auth="required"
                  class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-slate-100 text-slate-900 font-semibold text-[11px] shadow-sm hover:bg-white transition"
                >
                  ${ICONS.report.replace('w-4 h-4', 'w-3.5 h-3.5')}
                  <span>buradan indirebilirsiniz</span>
                </button>
              </div>

              <!-- BORÃ‡ / HESAPLAÅžMA BÃ–LÃœMÃœ (En Ã¼ste yakÄ±n) -->
              ${debtHtml}

              <!-- 1. Toplam Harcama (Orijinal Kurlar) -->
              <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
                  <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                     ${ICONS.wallet.replace('w-4 h-4', 'w-4 h-4')} Orijinal Para Birimi BazÄ±nda Toplam Harcama
                  </h4>
                  <div class="flex flex-wrap gap-2">
                      ${originalSummary || '<span class="text-slate-500">Harcama Yok</span>'}
                  </div>
              </div>

              <!-- 2. En Ã‡ok Harcama YapÄ±lan 3 Kategori -->
              <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
                  <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                     ${ICONS.chart.replace('w-4 h-4', 'w-4 h-4')} En Ã‡ok Harcanan Kategoriler (${reportCur})
                  </h4>
                  <div class="space-y-2">
                    ${topCategories || '<p class="text-sm text-slate-500 italic">Kategori harcamasÄ± bulunamadÄ±.</p>'}
                  </div>
              </div>

              <!-- 3. En Ã‡ok Para BÄ±rakÄ±lan 3 Åžehir/Mekan -->
              <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
                  <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                     ${ICONS.location.replace('w-4 h-4', 'w-4 h-4')} En Ã‡ok Para BÄ±rakÄ±lan 3 Mekan (${reportCur})
                  </h4>
                  <div class="space-y-2">
                    ${topLocations || '<p class="text-sm text-slate-500 italic">Mekan harcamasÄ± bulunamadÄ±.</p>'}
                  </div>
              </div>

              <!-- 5. Notlar -->
              <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
                  <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                     ${ICONS.key.replace('w-4 h-4', 'w-4 h-4')} Kritik Seyahat NotlarÄ±
                  </h4>
                  <ul class="list-none space-y-1 p-0 m-0">
                      ${notesForTrip || '<p class="text-sm text-slate-500 italic">Bu seyahat iÃ§in kritik not bulunmamaktadÄ±r.</p>'}
                  </ul>
              </div>

              <!-- 4. FotoÄŸraf Ã–nizlemesi -->
              <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
                  <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                     ðŸ“¸ Eklenen FotoÄŸraflar (Ä°lk 10)
                  </h4>
                  ${imagePreview}
              </div>
          </div>
      `;
            }

            // YENÄ° FONKSÄ°YON: Rota PlanlayÄ±cÄ± Ä°Ã§eriÄŸini OluÅŸtur (MEKAN BAZLI)
            function renderRoutePlanner() {
                const selectedTrip = state.routeTrip || state.tripFilter;

                if (!selectedTrip || selectedTrip === "") {
                    return `
              <div class="text-center py-4 bg-slate-900/50 rounded-lg text-sm text-slate-500">
                  LÃ¼tfen yukarÄ±dan bir seyahat seÃ§in.
              </div>
          `;
                }

                const routeData = getRouteUrl(selectedTrip);

                if (routeData.error) {
                    return `
              <div class="text-center py-4 bg-red-900/30 border border-red-800 rounded-lg text-sm text-red-300">
                  ${routeData.error}
              </div>
          `;
                }

                const pointsList = routeData.points.map((point, index) => {
                    let icon = 'ðŸ“';
                    if (index === 0) icon = 'ðŸ›«';
                    else if (index === routeData.points.length - 1) icon = 'ðŸ';

                    const [place, city] = point.split(',').map(s => s.trim());

                    return `
              <li class="flex items-start gap-2 text-sm text-slate-300 border-l border-slate-700/50 ml-3 pl-3 py-1 -my-1">
                  <span class="w-5 flex-shrink-0 text-center -ml-5 pt-1">${icon}</span> 
                  <div>
                      <div class="font-bold text-white">${esc(place)}</div>
                      <div class="text-[10px] text-slate-500">${esc(city)}</div>
                  </div>
              </li>
          `;
                }).join('');

                return `
          <div class="bg-slate-900/50 border border-slate-700 rounded-lg p-3 space-y-3">
              <h4 class="text-sm font-bold text-slate-300">OluÅŸturulan Rota SÄ±rasÄ± (Mekan BazlÄ±):</h4>
              <ul class="list-none space-y-1 p-0 m-0 max-h-40 overflow-y-auto scrl">
                  ${pointsList}
              </ul>
              
              <a href="${routeData.url}" target="_blank" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg text-sm font-bold transition w-full">
                 ${ICONS.globe.replace('w-4 h-4', 'w-4 h-4')} Rota HaritasÄ±nÄ± AÃ§ (Google Maps)
              </a>
          </div>
      `;
            }

            // YENÄ° FONKSÄ°YON: RAPOR HTML OLUÅžTURUCU
function buildReportHtml(data) {
    const {
        trip,
        reportCurrency,
        generatedAt,
        summary,
        expenses = [],
        reservations = [],
        scope = 'all',
        dateFrom = '',
        dateTo = '',
        debts = null,
        tripMeta = {},
        ratesInfo = null
    } = data || {};

    const fmt = (n) => new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Number(n) || 0);
    const escStr = (s) => String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');

    const scopeLabel = (s) => {
        if (s === 'individual') return 'Bireysel';
        if (s === 'shared') return 'Ortak';
        return 'TÃ¼mÃ¼';
    };

    const badge = (text, tone) => {
        const map = {
            slate: 'background:#f1f5f9;color:#334155;border:1px solid #e2e8f0;',
            ind: 'background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;',
            shared: 'background:#f0fdf4;color:#166534;border:1px solid #bbf7d0;',
            ok: 'background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;',
            warn: 'background:#fefce8;color:#854d0e;border:1px solid #fef08a;'
        };
        const style = map[tone] || map.slate;
        return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:700;line-height:16px;${style}">${escStr(text)}</span>`;
    };

    const hasReportAmounts = expenses.some(e => typeof e.amtReport === 'number') || reservations.some(r => typeof r.costReport === 'number');

    const style = `
        <style>
            :root{
                --ink:#0f172a;
                --muted:#64748b;
                --line:#e2e8f0;
                --bg:#f8fafc;
                --card:#ffffff;
                --shadow:0 10px 25px rgba(2,6,23,0.08);
            }
            *{box-sizing:border-box;}
            body{
                margin:0;
                font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                background: radial-gradient(1200px 600px at 20% 0%, #e0f2fe 0%, rgba(224,242,254,0) 60%),
                            radial-gradient(1200px 600px at 80% 20%, #ede9fe 0%, rgba(237,233,254,0) 60%),
                            var(--bg);
                color:var(--ink);
                padding:24px;
            }
            .container{
                max-width: 920px;
                margin:0 auto;
                background:var(--card);
                border:1px solid var(--line);
                border-radius:16px;
                box-shadow:var(--shadow);
                overflow:hidden;
            }
            .topbar{
                padding:22px 24px;
                background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 60%, #8b5cf6 100%);
                color:white;
            }
            .title{
                display:flex;
                align-items:flex-end;
                justify-content:space-between;
                gap:16px;
                flex-wrap:wrap;
            }
            .title h1{
                margin:0;
                font-size:22px;
                letter-spacing:-0.02em;
                line-height:1.2;
                font-weight:800;
            }
            .chips{
                display:flex;
                gap:8px;
                flex-wrap:wrap;
                justify-content:flex-end;
            }
            .chip{
                display:inline-flex;
                align-items:center;
                gap:6px;
                padding:6px 10px;
                border-radius:999px;
                background:rgba(255,255,255,0.16);
                border:1px solid rgba(255,255,255,0.26);
                font-size:11px;
                font-weight:700;
                white-space:nowrap;
            }
            .meta{
                margin-top:10px;
                font-size:12px;
                color:rgba(255,255,255,0.9);
            }
            .meta small{color:rgba(255,255,255,0.75);font-weight:600;}
            .content{padding:18px 24px 26px 24px;}
            .grid{
                display:grid;
                grid-template-columns: repeat(4, 1fr);
                gap:12px;
                margin-top:-26px;
            }
            .kpi{
                background:#ffffff;
                border:1px solid var(--line);
                border-radius:14px;
                padding:12px 12px;
                box-shadow:0 6px 18px rgba(2,6,23,0.06);
            }
            .kpi .l{
                font-size:10px;
                letter-spacing:0.12em;
                text-transform:uppercase;
                color:var(--muted);
                font-weight:800;
                margin-bottom:6px;
            }
            .kpi .v{
                font-size:16px;
                font-weight:900;
                color:var(--ink);
                line-height:1.2;
            }
            .kpi .s{
                margin-top:6px;
                font-size:11px;
                color:var(--muted);
            }
            .section{
                margin-top:18px;
                padding-top:6px;
            }
            .section h2{
                margin:18px 0 10px 0;
                font-size:15px;
                font-weight:900;
                color:#0b1220;
                letter-spacing:-0.01em;
                display:flex;
                gap:10px;
                align-items:center;
            }
            .section h2 .dot{
                width:10px;height:10px;border-radius:999px;
                background:linear-gradient(135deg, #0ea5e9, #8b5cf6);
                box-shadow:0 0 0 4px rgba(14,165,233,0.14);
            }
            .panel{
                border:1px solid var(--line);
                border-radius:14px;
                padding:14px;
                background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            }
            .hint{
                font-size:12px;color:var(--muted);
                margin:0;
            }
            table{
                width:100%;
                border-collapse:separate;
                border-spacing:0;
                font-size:12px;
                margin-top:10px;
                border:1px solid var(--line);
                border-radius:12px;
                overflow:hidden;
                background:white;
            }
            th, td{
                padding:10px 10px;
                border-bottom:1px solid var(--line);
                vertical-align:top;
            }
            th{
                text-align:left;
                background:#f8fafc;
                color:#475569;
                font-weight:800;
                font-size:11px;
                letter-spacing:0.08em;
                text-transform:uppercase;
            }
            tr:last-child td{border-bottom:none;}
            .amt{
                text-align:right;
                font-weight:900;
                white-space:nowrap;
            }
            .sub{
                display:block;
                margin-top:4px;
                font-size:10px;
                color:var(--muted);
                font-weight:600;
            }
            .rowmeta{
                display:flex;
                gap:8px;
                margin-top:6px;
                flex-wrap:wrap;
            }
            .noteBox{
                margin-top:10px;
                border-radius:14px;
                border:1px dashed #cbd5e1;
                padding:12px 12px;
                background:#ffffff;
            }
            .noteBox ul{
                margin:6px 0 0 18px;
                padding:0;
                color:#334155;
                font-size:12px;
                line-height:1.6;
            }
            .footer{
                margin-top:18px;
                padding:14px 24px;
                border-top:1px solid var(--line);
                font-size:11px;
                color:var(--muted);
                display:flex;
                justify-content:space-between;
                flex-wrap:wrap;
                gap:8px;
            }
            @media (max-width: 820px){
                body{padding:12px;}
                .content{padding:14px;}
                .grid{grid-template-columns: repeat(2, 1fr); margin-top:12px;}
            }
            @media print{
                body{background:#fff;padding:0;}
                .container{box-shadow:none;border:none;border-radius:0;}
                .topbar{border-radius:0;}
                .grid{margin-top:0;}
                a{color:inherit;text-decoration:none;}
            }
        </style>
    `;

    const debtsSection = (() => {
        if (scope === 'individual') {
            return `
                <div class="panel">
                    <p class="hint">
                        ${badge('Bilgi', 'slate')}
                        Bu rapor kapsamÄ± <b>Bireysel</b> olduÄŸu iÃ§in â€œkim-kime ne kadar verecekâ€ hesabÄ± Ã¼retilmez.
                    </p>
                </div>
            `;
        }

        if (!debts || !debts.transactions || !Array.isArray(debts.transactions)) {
            return `
                <div class="panel">
                    <p class="hint">
                        ${badge('Bilgi', 'slate')}
                        HesaplaÅŸma bilgisi oluÅŸturulamadÄ±. (Seyahatte <b>katÄ±lÄ±mcÄ± listesi</b> yok veya <b>ortak kayÄ±t</b> bulunmuyor.)
                    </p>
                </div>
            `;
        }

        const tx = debts.transactions || [];
        const cur = debts.currency || reportCurrency;

        const txTable = tx.length
            ? `
                <table>
                    <thead>
                        <tr>
                            <th>Ã–deyen (BorÃ§lu)</th>
                            <th>AlacaklÄ±</th>
                            <th class="amt">Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tx.map(t => `
                            <tr>
                                <td><b>${escStr(t.from)}</b></td>
                                <td>${escStr(t.to)}</td>
                                <td class="amt">${fmt(t.amount)} ${escStr(cur)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `
            : `<p class="hint">${badge('Tamam', 'ok')} HesaplaÅŸma gerekmiyor: herkes payÄ±nÄ± dengelemiÅŸ gÃ¶rÃ¼nÃ¼yor.</p>`;

        const balRows = debts.balances ? Object.entries(debts.balances).map(([p, bal]) => ({ p, bal })) : [];
        const balTable = balRows.length ? `
            <table>
                <thead>
                    <tr>
                        <th>KiÅŸi</th>
                        <th class="amt">Net Bakiye</th>
                    </tr>
                </thead>
                <tbody>
                    ${balRows.map(x => `
                        <tr>
                            <td>${escStr(x.p)}</td>
                            <td class="amt">${fmt(x.bal)} ${escStr(cur)}<span class="sub">${x.bal > 0.01 ? 'AlacaklÄ±' : (x.bal < -0.01 ? 'BorÃ§lu' : 'Dengede')}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : '';

        // Veri uyarÄ±larÄ± (eski / eksik kayÄ±tlar)
        const warnings = (debts && debts.dataWarnings) ? debts.dataWarnings : [];
        const warnHtml = warnings.length ? `
            <div class="panel" style="border-color:#f59e0b;">
                <p class="hint">
                    ${badge('UyarÄ±', 'warn')}
                    AÅŸaÄŸÄ±daki kalemlerde â€œÃ–deyenâ€ bilgisi eksik/uyumsuz gÃ¶rÃ¼nÃ¼yor. Bu raporda sistem <b>geÃ§ici olarak</b> ilk kiÅŸiyi varsayarak hesapladÄ±. LÃ¼tfen ilgili kaydÄ± dÃ¼zenleyip doÄŸru kiÅŸiyi seÃ§in.
                </p>
                <ul style="margin:8px 0 0 18px; color:#0f172a;">
                    ${warnings.slice(0, 25).map(w => {
                        const meta = w.meta || {};
                        const label = meta.kind === 'expense'
                            ? `Harcama: ${escStr(meta.place || '')}${meta.city ? ' (' + escStr(meta.city) + ')' : ''}`
                            : `Rezervasyon: ${escStr(meta.name || '')}${meta.location ? ' (' + escStr(meta.location) + ')' : ''}`;
                        return `<li style="margin:4px 0;">${label}</li>`;
                    }).join('')}
                </ul>
            </div>
        ` : '';

        return `
            <div class="panel">
                <p class="hint">
                    ${badge('HesaplaÅŸma', 'ok')}
                    Bu bÃ¶lÃ¼m <b>ortak</b> harcama/rezervasyonlar iÃ§in otomatik hesaplanÄ±r.
                    <span class="sub">Toplam daÄŸÄ±tÄ±lan ortak tutar: <b>${fmt(debts.totalShared || 0)} ${escStr(cur)}</b> Â· KiÅŸi baÅŸÄ± pay: <b>${fmt(debts.sharePerPerson || 0)} ${escStr(cur)}</b></span>
                </p>
                ${txTable}
                    ${warnHtml}
                ${balTable ? `<div style="margin-top:12px">${balTable}</div>` : ''}
            </div>
        `;
    })();

    const expRows = expenses.length
        ? `
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Detay</th>
                        <th>Ã–deyen</th>
                        <th class="amt">Tutar</th>
                    </tr>
                </thead>
                <tbody>
                    ${expenses.map(x => `
                        <tr>
                            <td style="width:140px">
                                <b>${escStr(x.date || '')}</b>
                                ${x.time ? `<span class="sub">${escStr(x.time)}</span>` : ''}
                            </td>
                            <td>
                                <b>${escStr(x.cat || '')}</b>${x.place ? ` Â· ${escStr(x.place)}` : ''}
                                ${x.city ? `<span class="sub">${escStr(x.city)}${x.country ? ' / ' + escStr(x.country) : ''}</span>` : ''}
                                ${x.note ? `<span class="sub">Not: ${escStr(x.note)}</span>` : ''}
                                <div class="rowmeta">
                                    ${badge(x.isIndividual ? 'Bireysel' : 'Ortak', x.isIndividual ? 'ind' : 'shared')}
                                </div>
                            </td>
                            <td style="width:140px">${escStr(x.payer || '-')}</td>
                            <td class="amt" style="width:160px">
                                ${fmt(x.amt)} ${escStr(x.cur)}
                                ${typeof x.amtReport === 'number' ? `<span class="sub">â‰ˆ ${fmt(x.amtReport)} ${escStr(reportCurrency)}</span>` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `
        : `<div class="panel"><p class="hint">${badge('Bilgi', 'slate')} Harcama kaydÄ± bulunmamaktadÄ±r.</p></div>`;

    const resRows = reservations.length
        ? `
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Rezervasyon</th>
                        <th>Ã–deyen</th>
                        <th class="amt">Maliyet</th>
                    </tr>
                </thead>
                <tbody>
                    ${reservations.map(r => `
                        <tr>
                            <td style="width:140px">
                                <b>${escStr(r.startDate || '')}</b>
                                ${r.endDate ? `<span class="sub">â†’ ${escStr(r.endDate)}</span>` : ''}
                            </td>
                            <td>
                                <b>${escStr(r.name || '')}</b>
                                ${r.type ? `<span class="sub">Tip: ${escStr(r.type)}${r.location ? ' Â· ' + escStr(r.location) : ''}</span>` : ''}
                                ${r.code ? `<span class="sub">Kod: ${escStr(r.code)}</span>` : ''}
                                ${r.notes ? `<span class="sub">Not: ${escStr(r.notes)}</span>` : ''}
                                <div class="rowmeta">
                                    ${badge(r.isIndividual ? 'Bireysel' : 'Ortak', r.isIndividual ? 'ind' : 'shared')}
                                    ${r.isSettled ? badge('Ã–dendi', 'ok') : ''}
                                </div>
                            </td>
                            <td style="width:140px">${escStr(r.payer || '-')}</td>
                            <td class="amt" style="width:160px">
                                ${fmt(r.cost)} ${escStr(r.cur)}
                                ${typeof r.costReport === 'number' ? `<span class="sub">â‰ˆ ${fmt(r.costReport)} ${escStr(reportCurrency)}</span>` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `
        : `<div class="panel"><p class="hint">${badge('Bilgi', 'slate')} Rezervasyon kaydÄ± bulunmamaktadÄ±r.</p></div>`;

    const notes = (() => {
        const notesArr = [];

        notesArr.push(`<b>Kapsam:</b> Bu rapor <b>${escStr(scopeLabel(scope))}</b> kayÄ±tlarÄ± temel alÄ±narak Ã¼retilmiÅŸtir.`);

        if (dateFrom || dateTo) {
            notesArr.push(`<b>Tarih AralÄ±ÄŸÄ±:</b> KayÄ±tlardan tÃ¼retilen aralÄ±k: <b>${escStr(dateFrom || '-')}</b> â€“ <b>${escStr(dateTo || '-')}</b>.`);
        }

        if (tripMeta && (tripMeta.startDate || tripMeta.endDate)) {
            notesArr.push(`<b>Seyahat SÃ¼resi:</b> GÃ¼nlÃ¼k ortalama hesaplanÄ±rken seyahat baÅŸlangÄ±Ã§/bitiÅŸ tarihleri (tanÄ±mlÄ±ysa) esas alÄ±nÄ±r: <b>${escStr(tripMeta.startDate || '-')}</b> â€“ <b>${escStr(tripMeta.endDate || '-')}</b>.`);
        }

        notesArr.push(`<b>Toplam Maliyet:</b> Harcamalar + rezervasyon maliyetleri toplamÄ±dÄ±r.`);

        notesArr.push(`<b>Kim-kime ne kadar verecek:</b> Sadece <b>ortak</b> kalemlerden hesaplanÄ±r. â€œÃ–dendiâ€ iÅŸaretli ortak rezervasyonlar <b>hesaplaÅŸmaya dahil edilmez</b> (ancak toplam maliyete dahil olabilir).`);

        if (tripMeta && tripMeta.persons) {
            notesArr.push(`<b>KatÄ±lÄ±mcÄ±lar:</b> ${escStr(tripMeta.persons)}. Ortak kalemler bu listedeki kiÅŸi sayÄ±sÄ±na gÃ¶re <b>eÅŸit</b> bÃ¶lÃ¼nÃ¼r.`);
        } else {
            notesArr.push(`<b>KatÄ±lÄ±mcÄ±lar:</b> HesaplaÅŸma iÃ§in seyahatte kiÅŸi listesi (virgÃ¼lle) tanÄ±mlanmalÄ±dÄ±r.`);
        }

        notesArr.push(`<b>Ã–deyen alanÄ±:</b> Ortak kalemlerde â€œÃ–deyenâ€ seÃ§imi zorunludur; boÅŸ bÄ±rakÄ±lÄ±rsa sistem kaydetmeye izin vermez.`);
        notesArr.push(`<b>Veri uyarÄ±larÄ±:</b> EÄŸer raporda â€œVeri UyarÄ±larÄ±â€ bÃ¶lÃ¼mÃ¼ oluÅŸursa, eski kayÄ±tlarda â€œÃ–deyenâ€ eksik/uyumsuz olabilir; ilgili kaydÄ± dÃ¼zenleyip doÄŸru kiÅŸiyi seÃ§meniz gerekir.`);

        if (ratesInfo && ratesInfo.updatedAt) {
            const rs = ratesInfo.rates || {};
            const parts = Object.keys(rs).slice(0, 6).map(k => `${k}: ${fmt(rs[k])}`).join(' | ');
            notesArr.push(`<b>Kur dÃ¶nÃ¼ÅŸÃ¼mÃ¼:</b> DÃ¶nÃ¼ÅŸÃ¼mler uygulamadaki kur tablosuna gÃ¶re yapÄ±lÄ±r. Kur gÃ¼ncellenme zamanÄ±: <b>${escStr(ratesInfo.updatedAt)}</b>. ${parts ? `(${escStr(parts)})` : ''}`);
        } else if (hasReportAmounts) {
            notesArr.push(`<b>Kur dÃ¶nÃ¼ÅŸÃ¼mÃ¼:</b> â€œâ‰ˆ ${escStr(reportCurrency)}â€ satÄ±rlarÄ± uygulamadaki kur tablosuna gÃ¶re hesaplanÄ±r (anlÄ±k kur olmayabilir).`);
        }

        notesArr.push(`<b>Yuvarlama:</b> Tutarlar 2 ondalÄ±k basamakla gÃ¶sterildiÄŸi iÃ§in Ã§ok kÃ¼Ã§Ã¼k (Â±0,01) farklar oluÅŸabilir.`);

        return `
            <div class="noteBox">
                <p class="hint" style="margin:0">${badge('Notlar', 'warn')} Bu raporu doÄŸru yorumlamak iÃ§in:</p>
                <ul>${notesArr.map(n => `<li>${n}</li>`).join('')}</ul>
            </div>
        `;
    })();

    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>${escStr(trip)} - Seyahat Raporu</title>
            ${style}
        </head>
        <body>
            <div class="container">
                <div class="topbar">
                    <div class="title">
                        <h1>${escStr(trip)} Â· Seyahat Raporu</h1>
                        <div class="chips">
                            <span class="chip">Para Birimi: <b>${escStr(reportCurrency)}</b></span>
                            <span class="chip">Kapsam: <b>${escStr(scopeLabel(scope))}</b></span>
                            ${dateFrom || dateTo ? `<span class="chip">AralÄ±k: <b>${escStr(dateFrom || '-')}</b> â€“ <b>${escStr(dateTo || '-')}</b></span>` : ''}
                        </div>
                    </div>
                    <div class="meta">
                        OluÅŸturulma: <b>${new Date(generatedAt).toLocaleString('tr-TR')}</b>
                        <small> Â· Harcama: ${Number(summary?.expenseCount || expenses.length)} Â· Rezervasyon: ${Number(summary?.reservationCount || reservations.length)}</small>
                    </div>
                </div>

                <div class="content">
                    <div class="grid">
                        <div class="kpi">
                            <div class="l">Toplam</div>
                            <div class="v">${fmt(summary?.totalReport || 0)} ${escStr(reportCurrency)}</div>
                            <div class="s">Harcama + Rezervasyon</div>
                        </div>
                        <div class="kpi">
                            <div class="l">GÃ¼nlÃ¼k Ortalama</div>
                            <div class="v">${fmt(summary?.dailyAvg || 0)} ${escStr(reportCurrency)}</div>
                            <div class="s">${Number(summary?.dayCount || 0)} gÃ¼n</div>
                        </div>
                        <div class="kpi">
                            <div class="l">Ortak</div>
                            <div class="v">${fmt(summary?.sharedTotal || 0)} ${escStr(reportCurrency)}</div>
                            <div class="s">Kapsam iÃ§i</div>
                        </div>
                        <div class="kpi">
                            <div class="l">Bireysel</div>
                            <div class="v">${fmt(summary?.indivTotal || 0)} ${escStr(reportCurrency)}</div>
                            <div class="s">Kapsam iÃ§i</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2><span class="dot"></span>HesaplaÅŸma Â· Kim kime ne kadar verecek</h2>
                        ${debtsSection}
                    </div>

                    <div class="section">
                        <h2><span class="dot"></span>GÃ¼nlÃ¼k Harcama DÃ¶kÃ¼mÃ¼ (${expenses.length})</h2>
                        ${expRows}
                    </div>

                    <div class="section">
                        <h2><span class="dot"></span>Rezervasyon Ã–zeti (${reservations.length})</h2>
                        ${resRows}
                    </div>

                    ${notes}

                </div>

                <div class="footer">
                    <span>Rapor Ã¼retimi: Seyahat CÃ¼zdanÄ±</span>
                    <span>Bu Ã§Ä±ktÄ± HTML tabanlÄ±dÄ±r; tarayÄ±cÄ±dan â€œYazdÄ±r â†’ PDFâ€ ile PDF alabilirsiniz.</span>
                </div>
            </div>
        </body>
        </html>
    `;
}

// YENÄ° FONKSÄ°YON: Ã–ZET SAYFASI
            function renderSummary() {
                const baseCur = state.baseCurrency;
                const today = new Date().toISOString().slice(0, 10);
                let todayTotal = 0;
                let allTimeTotal = 0;
                const indFilter = state.indFilter || '';

                // Harcama kayÄ±tlarÄ± (bireysel/ortak filtresine gÃ¶re)
                const filteredExpForSum = state.exp.filter(x => {
                    if (indFilter === 'individual' && x.isIndividual !== true) return false;
                    if (indFilter === 'shared' && x.isIndividual !== false) return false;
                    return true;
                });

                filteredExpForSum.forEach(x => {
                    allTimeTotal += convertToBase(x.amt, x.cur, baseCur);
                });

                // BugÃ¼nÃ¼n harcamalarÄ± (sadece fiili harcamalar, bireysel/ortak filtresine gÃ¶re)
                const todayExpenses = filteredExpForSum.filter(x => x.date === today);
                todayExpenses.forEach(x => {
                    todayTotal += convertToBase(x.amt, x.cur, baseCur);
                });

                // Rezervasyon maliyetleri (toplam harcamaya dahil, bireysel/ortak filtresine gÃ¶re)
                state.res.forEach(r => {
                    if (!r.cost) return;
                    if (indFilter === 'individual' && r.isIndividual !== true) return;
                    if (indFilter === 'shared' && r.isIndividual !== false) return;
                    allTimeTotal += convertToBase(r.cost, r.cur || baseCur, baseCur);
                });

                // YAKLAÅžAN REZERVASYONLAR
                const now = new Date();
                const nextReservation = state.res
                    .filter(r => !r.completed && new Date(r.startDate) >= now)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate))[0];

                const nextChecklistItem = state.chk.items
                    .filter(i => !i.done && i.date && new Date(i.date) >= now)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))[0];

                let nextPlan = null;
                if (nextReservation && nextChecklistItem) {
                    nextPlan = new Date(nextReservation.startDate) < new Date(nextChecklistItem.date) ?
                        { type: 'res', item: nextReservation } :
                        { type: 'chk', item: nextChecklistItem };
                } else if (nextReservation) {
                    nextPlan = { type: 'res', item: nextReservation };
                } else if (nextChecklistItem) {
                    nextPlan = { type: 'chk', item: nextChecklistItem };
                }

                // Rezervasyon tipini TÃ¼rkÃ§eye Ã§eviren yardÄ±mcÄ± fonksiyon
                const formatResType = (type) => {
                    if (!type) return '';
                    switch (type) {
                        case 'flight': return 'UÃ§uÅŸ';
                        case 'hotel': return 'Otel';
                        case 'car': return 'AraÃ§';
                        case 'train': return 'Tren';
                        case 'bus': return 'OtobÃ¼s';
                        default: return type;
                    }
                };


                let resText = 'YaklaÅŸan Plan Yok';
                if (nextPlan) {
                    const item = nextPlan.item;
                    const isRes = nextPlan.type === 'res';
                    const date = isRes ? item.startDate : item.date;
                    const diff = new Date(date).getTime() - new Date().getTime();
                    const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    const name = isRes
                        ? `${esc(formatResType(item.type))}: ${esc(item.name)}`
                        : `${esc(item.val)} (${esc(item.cat)})`;


                    if (daysLeft < 7) {
                        resText = `Ã‡ok YakÄ±n! ${fmtDate(date)}: ${name}`;
                    } else {
                        resText = `${fmtDate(date)}: ${name}`;
                    }
                }

                // Son 3 Harcama
                const latestExpenses = [...state.exp]
                    .sort((a, b) => (b.date || '').localeCompare(a.date) || (b.id.localeCompare(a.id)))
                    .slice(0, 3);

                const currencyOptions = AVAILABLE_CURRENCIES.map(c =>
                    `<option value="${c}" ${c === baseCur ? 'selected' : ''}>${c}</option>`
                ).join('');


                return `
        <div class="space-y-4 pb-24">
            
            <!-- 1. GENEL HARCAMA VE KUR BAÅžLIÄžI (HEADER) -->
            <div class="relative overflow-hidden rounded-2xl border border-cyan-400/40 bg-cyan-400/50 backdrop-blur-xl shadow-[0_0_40px_rgba(34,211,238,0.25)]">
                <div class="absolute -right-10 -top-10 w-40 h-40 rounded-full bg-cyan-300/50 blur-3xl"></div>
                <div class="absolute -left-16 -bottom-16 w-56 h-56 rounded-full bg-sky-500/35 blur-3xl"></div>
                
                <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-4 p-4">
                    <div>
                        <div class="text-[10px] uppercase tracking-[0.25em] text-slate-900/70 font-bold mb-1 flex items-center gap-1">
                            ${ICONS.calculate} TÃœM SEYAHATLER TOPLAMI
                        </div>
                        
                        <div class="text-3xl font-extrabold text-slate-900 leading-tight mt-1">
                            ${fmtNum(allTimeTotal)} 
                            <span class="text-lg font-semibold">${baseCur}</span>
                        </div>
                        
                        <div class="mt-2 inline-flex items-center gap-2 rounded-md bg-white/45 px-2 py-1 text-[9px] text-slate-900/80">
                            ${ICONS.refresh.replace('w-4 h-4', 'w-3 h-3')}
                            <span>Kur: USD ${fmtNum(EXCHANGE_RATES.USD)} | EUR ${fmtNum(EXCHANGE_RATES.EUR)} (${rateLastUpdated})</span>
                        </div>
                    </div>
                    
                    
                    <div class="flex flex-col gap-2 w-full sm:w-auto">
                        <div class="flex flex-row gap-3">
                            <div class="flex flex-col gap-1 w-[120px] sm:w-auto">
                                <label class="text-[10px] text-slate-900/80 font-bold uppercase ml-1">
                                    Ã–zet Para Birimi
                                </label>
                                <div class="relative">
                                    <select
                                        data-act="set-base-currency"
                                        class="w-full rounded-xl border border-slate-300/70 bg-white/70 px-3 py-1.5 text-[11px] font-semibold text-slate-900 shadow-sm outline-none focus:ring-2 focus:ring-cyan-400/80 appearance-none">
                                        ${currencyOptions}
                                    </select>
                                    <div class="pointer-events-none absolute right-3 top-2.5 text-slate-700/70">
                                        ${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col gap-1 w-[140px] sm:w-auto">
                                <label class="text-[10px] text-slate-900/80 font-bold uppercase ml-1">
                                    Harcama KapsamÄ±
                                </label>
                                <div class="relative">
                                    <select
                                        data-act="flt-ind"
                                        class="w-full rounded-xl border border-slate-300/70 bg-white/70 px-3 py-1.5 text-[11px] font-semibold text-slate-900 shadow-sm outline-none focus:ring-2 focus:ring-cyan-400/80 appearance-none">
                                        ${INDIVIDUAL_FILTERS.map(f => `<option value="${f.id}" ${state.indFilter === f.id ? 'selected' : ''}>${esc(f.l)}</option>`).join('')}
                                    </select>
                                    <div class="pointer-events-none absolute right-3 top-2.5 text-slate-700/70">
                                        ${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
</div></div>
               
<!-- 2. BUGÃœNÃœN HARCAMASI ve YAKLAÅžAN PLAN KartlarÄ± (Yanyana 2 Box) -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                
                      <!-- BUGÃœNÃœN HARCAMASI -->
			<div class="relative overflow-hidden rounded-xl border border-emerald-400/40 bg-emerald-500/10 backdrop-blur-xl shadow-[0_0_30px_rgba(16,185,129,0.45)] h-36 p-4">
                    <div class="flex items-center gap-2 text-sm text-white/80 font-semibold mb-2">
                        ${ICONS.calculate.replace('w-4 h-4', 'w-4 h-4')} BUGÃœNÃœN HARCAMASI
                    </div>
                    <div class="text-3xl font-extrabold text-white leading-none mt-2">
                        ${fmtNum(todayTotal)}
                    </div>
                    <div class="text-sm font-medium text-white/70">${baseCur}</div>
                    
                    <div class="text-[10px] text-white/50 mt-3">
                        ${todayExpenses.length} kayÄ±t
                    </div>
                </div>

          
                <!-- YAKLAÅžAN REZERVASYON -->
		<div class="relative overflow-hidden rounded-xl border border-violet-400/40 bg-violet-500/10 backdrop-blur-xl shadow-[0_0_30px_rgba(139,92,246,0.45)] h-36 flex flex-col justify-between p-4">
                    <div class="flex items-center gap-2 text-sm text-white/80 font-semibold mb-2">
                         ${ICONS.calendar.replace('w-4 h-4', 'w-4 h-4')} YAKLAÅžAN PLAN
                    </div>
                    <div>
                        <div class="text-lg font-bold text-white line-clamp-2 leading-tight">
                            ${resText.split(':').slice(1).join(':').trim() || resText}
                        </div>
                        <div class="text-xs font-medium ${nextPlan && Math.ceil((new Date(nextPlan.item.date || nextPlan.item.startDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)) < 7 ? 'text-yellow-300' : 'text-white/70'} mt-1">
                            ${nextPlan ? `${Math.ceil((new Date(nextPlan.item.date || nextPlan.item.startDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24))} GÃ¼n KaldÄ±` : 'Mevcut DeÄŸil'}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Son 3 Harcama Listesi -->
            <h3 class="text-lg font-bold text-white mt-6 mb-3 flex items-center gap-2">
                ${ICONS.wallet.replace('w-4 h-4', 'w-4 h-4')} Son 3 Harcama
            </h3>
            <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl overflow-hidden divide-y divide-slate-700/50">
                ${latestExpenses.length > 0 ? latestExpenses.map(x => {
                    const catInfo = CATS[x.cat] || CATS.other;
                    const estimatedBaseCur = convertToBase(x.amt, x.cur, baseCur);

                    return `
                        <div data-act="detail" data-id="${x.id}" class="p-3 flex justify-between items-center hover:bg-slate-700/50 cursor-pointer transition">
                            <!-- Sol: Mekan / Kategori -->
                            <div class="flex-1 min-w-0 pr-3">
                                <div class="text-sm font-bold text-white line-clamp-1">${esc(x.place)}</div>
                                <div class="text-[10px] text-slate-400 mt-0.5 flex items-center gap-1">
                                    <span class="font-medium">${esc(catInfo.l)}</span> Â· ${fmtDate(x.date)}
                                </div>
                            </div>
                            <!-- SaÄŸ: Tutar / Base Cur KarÅŸÄ±lÄ±ÄŸÄ± -->
                            <div class="text-right flex-shrink-0">
                                <div class="text-sm font-bold text-slate-200">${fmtNum(x.amt)} <span class="text-xs font-medium">${x.cur}</span></div>
                                
                            </div>
                        </div>
                    `;
                }).join('') : `
                    <div class="text-center py-6 text-slate-500 text-sm">
                        HenÃ¼z harcama kaydÄ± bulunmamaktadÄ±r.
                    </div>
                `}
            </div>
        </div>
      `;
            }

            function renderHeader() {
                const timeInfo = formatTime(state.targetTimezone);
                const loc = state.location;
                const isReady = loc && loc.lat && loc.lon;
                const locationName = state.locationLoading ? 'AlÄ±nÄ±yor...' : state.locationName;
                const locIcon = isReady ? ICONS.location.replace('w-4 h-4', 'w-4 h-4') : ICONS.compass.replace('w-4 h-4', 'w-4 h-4');

                return `
      <div class="glass-panel rounded-xl p-3 mb-4 flex flex-col md:flex-row items-center justify-between shadow-lg gap-3 bg-slate-900/80">
        <div class="flex items-center gap-3 w-full md:w-auto">
           <div class="relative w-10 h-10 flex items-center justify-center shrink-0">
              <!-- Daha sofistike logo renkleri -->
              <div class="absolute inset-0 bg-gradient-to-br from-indigo-700 to-purple-600 rounded-lg rotate-6 opacity-40"></div>
              <div class="absolute inset-0 bg-gradient-to-tl from-blue-500 to-indigo-400 rounded-lg -rotate-3 opacity-90 shadow-xl"></div>
              <div class="relative text-white drop-shadow-md">${ICONS.wallet}</div>
           </div>
           <div>
              <h1 class="text-lg font-bold text-white tracking-tight">
                 Seyahat CÃ¼zdanÄ±
                 <span class="ml-2 text-xs font-semibold text-emerald-300">
                   ${locationName && locationName !== 'Bilinmiyor' ? 'Â· ' + locationName : ''}
                 </span>
              </h1>
              <div class="flex items-center gap-1 text-xs text-slate-400">
                 <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Takip & Planlama
              </div>
           </div>
        </div>
        
        <div class="flex items-center gap-2 w-full md:w-auto justify-end mt-2 md:mt-0 relative">
            <!-- GÄ°RÄ°Åž Ä°KONU -->
           <button
             id="auth-btn-login-toggle"
             data-act="auth-open"
             class="flex items-center justify-center w-8 h-8 rounded-full border border-slate-600 bg-slate-800/70 hover:bg-slate-700 transition"
             title="GiriÅŸ yap / Ã§Ä±kÄ±ÅŸ yap">
             <span class="text-[11px]">ðŸ‘¤</span>
           </button>
           <!-- KullanÄ±cÄ± menÃ¼sÃ¼ (sadece giriÅŸ yapÄ±ldÄ±ÄŸÄ±nda kullanÄ±lÄ±r) -->
           <div id="auth-user-menu" class="hidden absolute right-0 top--5 z-40">
             <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-lg px-3 py-2 min-w-[180px]">
               <div id="auth-user-email" class="text-[11px] text-slate-300 mb-2 break-all">
                 Oturum aÃ§Ä±lmadÄ±
               </div>
               <button
                 type="button"
                 data-act="auth-logout"
                 class="w-full text-[11px] px-2 py-1 rounded-lg bg-red-500 text-white hover:bg-red-600">
                 Ã‡Ä±kÄ±ÅŸ yap
               </button>
             </div>
           </div>

           <!-- KONUM BÄ°LGÄ°SÄ° Ä°KONU -->
           <button data-act="get-location" class="flex items-center bg-slate-800/80 hover:bg-slate-700/80 transition rounded-lg p-1 border border-slate-700 justify-center cursor-pointer min-w-10" title="${locationName}">
               <span class="text-xs text-slate-400 mr-1">${locIcon}</span>
               <span class="text-[9px] text-white/80 font-bold hidden sm:inline-block">${isReady ? 'Konum OK' : 'Konum Al'}</span>
           </button>

           <!-- YEREL SAAT GÃ–STERÄ°MÄ° (TÄ±klanabilir) -->
           <button data-act="open-tz-modal" class="flex items-center bg-slate-800/80 hover:bg-slate-700/80 transition rounded-lg p-1 border border-slate-700 min-w-[100px] justify-center cursor-pointer">
              <span class="text-xs text-slate-400 mr-2">${ICONS.clock.replace('w-4 h-4', 'w-3.5 h-3.5')}</span>
              <div id="local-time-container">
                  <div id="local-time" class="text-sm font-bold text-white leading-none">${state.currentTime}

          

        </div>
                  <div class="text-[9px] text-slate-500 leading-none">${timeInfo.zoneName.replace(' (VarsayÄ±lan)', '').replace('Europe/Istanbul', 'Ä°stanbul')}</div>
              </div>
           </button>
           <!-- /YEREL SAAT GÃ–STERÄ°MÄ° -->
           
           ${state.tab === 'exp' ? `
             <button data-act="clean-all-exp" class="bg-gradient-to-r from-red-600/30 to-rose-700/30 hover:from-red-600 hover:to-rose-700 text-rose-400 hover:text-white border border-rose-500/20 px-2 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 whitespace-nowrap shadow-lg shadow-rose-900/20">
               ${ICONS.trash.replace('w-4 h-4', 'w-3.5 h-3.5')} <span class="hidden sm:inline">TÃ¼mÃ¼nÃ¼ Sil</span>
             </button>
             <button data-act="open-chart" class="bg-slate-800/70 hover:bg-slate-700/90 border border-slate-600/60 rounded-lg p-1.5 flex items-center justify-center transition" title="Harcama GrafiÄŸi">
               ${ICONS.chart.replace('w-4 h-4', 'w-3.5 h-3.5')}
             </button>
           ` : ''}
           
           ${state.tab === 'chk' ? `
             <button data-act="reset-chk" class="bg-gradient-to-r from-red-600/30 to-rose-700/30 hover:from-red-600 hover:to-rose-700 text-rose-400 hover:text-white border border-rose-500/20 px-2 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 whitespace-nowrap shadow-lg shadow-rose-900/20">
               ${ICONS.trash.replace('w-4 h-4', 'w-3.5 h-3.5')} <span class="hidden sm:inline">Listeyi SÄ±fÄ±rla</span>
             </button>
           ` : ''}
           
        </div>
      </div>
    `;
            }

            function renderDashboardHeader(visibleExp) {
                const baseCur = state.baseCurrency;
                let totalInHeaderCur = 0;
                const totalsByCurrency = {};
                const isFiltered = !!state.tripFilter;

                // SeÃ§ili seyahatin para birimini belirle (tek para birimi kullanÄ±lÄ±yorsa)
                let headerCur = baseCur;
                if (isFiltered) {
                    const tripExps = visibleExp.filter(x => (x.trip || '') === state.tripFilter);
                    const tripRes = state.res.filter(r => (r.trip || '') === state.tripFilter && r.cost);
                    const tripCurrencies = [...new Set(
                        tripExps.map(x => x.cur || baseCur).concat(
                            tripRes.map(r => r.cur || baseCur)
                        )
                    )];
                    if (tripCurrencies.length === 1) {
                        headerCur = tripCurrencies[0];
                    }
                }

                const indFilter = state.indFilter || '';

                // ToplamÄ± ve para birimi bazÄ±nda daÄŸÄ±lÄ±mÄ± hesapla (harcamalar)
                visibleExp.forEach(x => {
                    if (indFilter === 'individual' && x.isIndividual !== true) return;
                    if (indFilter === 'shared' && x.isIndividual !== false) return;

                    const cur = x.cur || headerCur;
                    const amt = Number(x.amt) || 0;

                    totalInHeaderCur += convertToBase(amt, cur, headerCur);
                    totalsByCurrency[cur] = (totalsByCurrency[cur] || 0) + amt;
                });

                // SeÃ§ili seyahat ve bireysel/ortak filtresine gÃ¶re rezervasyon maliyetlerini ekle
                const resForHeader = state.res.filter(r => {
                    if (isFiltered && (r.trip || '') !== state.tripFilter) return false;
                    if (!r.cost) return false;
                    if (indFilter === 'individual' && r.isIndividual !== true) return false;
                    if (indFilter === 'shared' && r.isIndividual !== false) return false;
                    return true;
                });

                resForHeader.forEach(r => {
                    const cur = r.cur || headerCur;
                    const amt = Number(r.cost) || 0;

                    totalInHeaderCur += convertToBase(amt, cur, headerCur);
                    totalsByCurrency[cur] = (totalsByCurrency[cur] || 0) + amt;
                });

                const headerText = isFiltered
                    ? `${esc(state.tripFilter)} Seyahati ToplamÄ±`
                    : `SeÃ§ili Seyahat Harcamalar ToplamÄ±`;

                const multiCurrencySummary = Object.entries(totalsByCurrency)
                    .filter(([cur]) => cur !== headerCur)
                    .sort((a, b) => b[1] - a[1])
                    .map(([cur, amt]) => `${fmtNum(amt)} ${cur}`)
                    .join(' Â· ');

                const subtitleText = multiCurrencySummary
                    ? `(${multiCurrencySummary}) Â· ${visibleExp.length} Ä°ÅŸlem`
                    : `${visibleExp.length} Ä°ÅŸlem`;

                const rateInfo = `USD: ${fmtNum(EXCHANGE_RATES.USD)} | EUR: ${fmtNum(EXCHANGE_RATES.EUR)} (${rateLastUpdated})`;

                const trips = [...new Set(state.exp.map(x => x.trip).filter(t => t))].sort();

                return `
      <!-- TOPLAM HARCAMA ALANI -->
      <div class="relative overflow-hidden rounded-2xl border border-cyan-400/40 bg-cyan-500/10 backdrop-blur-xl shadow-[0_0_35px_rgba(34,211,238,0.55)] p-4 group">
        <!-- Turkuaz cam arka plan baloncuklarÄ± -->
        <div class="absolute -right-10 -top-10 w-40 h-40 bg-cyan-400/40 blur-3xl group-hover:bg-cyan-300/45 transition duration-700"></div>
        <div class="absolute -left-16 -bottom-16 w-56 h-56 bg-sky-500/30 blur-3xl"></div>

        <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-3">
          <!-- Sol taraf: Toplam bilgi -->
          <div>
            <div class="text-[10px] uppercase tracking-[0.25em] text-white/80 font-bold mb-1 flex items-center gap-1">
              ${ICONS.calculate} ${headerText}
            </div>

            <div class="text-3xl font-extrabold text-white leading-tight mt-1">
              ${fmtNum(totalInHeaderCur)} <span class="text-lg font-semibold">${headerCur}</span>
            </div>

            <div class="text-xs text-white/70 mt-2 font-medium">
              ${subtitleText}
            </div>

            <div class="mt-2 inline-flex items-center gap-2 rounded-md bg-black/20 px-2 py-1 text-[10px] text-white/80">
              ${ICONS.refresh.replace('w-4 h-4', 'w-3 h-3')}
              <span>Dinamik Kurlar: ${rateInfo}</span>
            </div>
          </div>

          <!-- SaÄŸ taraf: Seyahat filtresi -->
          <div class="flex flex-col gap-1 w-full md:w-auto md:min-w-[160px] max-w-[200px]">
            <label class="text-[10px] text-white/80 font-bold uppercase ml-1">
              Seyahat SeÃ§imi
            </label>
            <div class="relative">
              <select
                data-act="flt-trip"
                class="w-full rounded-xl border border-cyan-400/60 bg-slate-950/40 px-3 py-1.5 text-[11px] font-semibold text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-400/80 appearance-none cursor-pointer backdrop-blur-sm">
                <option value="">TÃ¼m Seyahatler</option>
                ${trips.map(t => `
                  <option value="${esc(t)}" ${state.tripFilter === t ? 'selected' : ''}>${esc(t)}</option>
                `).join('')}
              </select>
              <div class="pointer-events-none absolute right-3 top-2.5 text-white/80">
                ${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
            }


            function renderTabs() {
                const t = state.tab;

                // Ãœst menÃ¼ butonlarÄ±nÄ±n temel ve aktif/pasif stilleri
                const btnBaseCls = "menu-btn-base border transition-all duration-200";
                const activeBtnCls = "bg-cyan-500/20 border-cyan-400 text-cyan-50 shadow-[0_0_25px_rgba(34,211,238,0.55)]";
                const passiveBtnCls = "bg-transparent border-transparent text-slate-400 hover:bg-slate-800/60 hover:text-slate-100";

                // Ä°kon kutusu (gradient burada veriliyor)
                const iconBaseCls = "menu-btn-icon-box bg-gradient-to-br shadow-lg shadow-black/30";

                const labelActiveCls = "text-[9px] font-extrabold uppercase leading-none text-cyan-50 mt-1";
                const labelPassiveCls = "text-[9px] font-extrabold uppercase leading-none text-slate-400 mt-1";

                const tabs = [
                    {
                        id: 'sum',
                        label: 'Ã–ZET',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" /><path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" /></svg>`,
                        color: MENU_ICON_COLORS.sum
                    },
                    {
                        id: 'exp',
                        label: 'HARCAMA',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M4.5 3.75a3 3 0 00-3 3v.75h21v-.75a3 3 0 00-3-3h-15z" /><path fill-rule="evenodd" d="M22.5 9.75h-21v7.5a3 3 0 003 3h15a3 3 0 003-3v-7.5zm-18 3.75a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6a.75.75 0 01-.75-.75zm.75 2.25a.75.75 0 000 1.5h3a.75.75 0 000-1.5h-3z" clip-rule="evenodd" /></svg>`,
                        color: MENU_ICON_COLORS.exp
                    },
                    {
                        id: 'chk',
                        label: 'CHECK LIST',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M2.625 6.75a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875 0A.75.75 0 018.25 6h12a.75.75 0 010 1.5h-12a.75.75 0 01-.75-.75zM2.625 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zM7.5 12a.75.75 0 01.75-.75h12a.75.75 0 010 1.5h-12A.75.75 0 017.5 12zm-4.875 5.25a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875 0a.75.75 0 01.75-.75h12a.75.75 0 010 1.5h-12a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>`,
                        color: MENU_ICON_COLORS.chk
                    },
                    {
                        id: 'other',
                        label: 'DÄ°ÄžER',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h2.25a3 3 0 013 3v2.25a3 3 0 01-3 3H6a3 3 0 01-3-3V6zm9.75 0a3 3 0 013-3H18a3 3 0 013 3v2.25a3 3 0 01-3 3h-2.25a3 3 0 01-3-3V6zM3 15.75a3 3 0 013-3h2.25a3 3 0 013 3V18a3 3 0 01-3 3H6a3 3 0 01-3-3v-2.25zm9.75 0a3 3 0 013-3H18a3 3 0 013 3V18a3 3 0 01-3 3h-2.25a3 3 0 01-3-3v-2.25z" clip-rule="evenodd" /></svg>`,
                        color: MENU_ICON_COLORS.other
                    },
                ];

                return `
      <div class="glass-panel p-1 rounded-xl mb-4 flex gap-1 overflow-x-auto scrl">
        ${tabs.map(tab => {
                    const isActive = t === tab.id;
                    const btnCls = isActive ? activeBtnCls : passiveBtnCls;
                    // YENÄ°: Pasifken de rengi gÃ¶ster ama soft ve biraz soluk olsun
                    const iconGradient = isActive ? tab.color : tab.color + ' opacity-40 saturate-[0.6]';

                    // YENÄ°: Ä°kon her zaman beyaz olsun (renkli zemin Ã¼zerinde)
                    const iconTextCls = 'text-white drop-shadow-sm';

                    const labelCls = isActive ? labelActiveCls : labelPassiveCls;

                    return `
                <button data-act="tab" data-val="${tab.id}" class="${btnBaseCls} ${btnCls}">
                    <div class="${iconBaseCls} ${iconGradient} ${iconTextCls}">
                        ${tab.icon.replace('w-4 h-4', 'w-5 h-5')}
                    </div>
                    <span class="${labelCls}">${tab.label}</span>
                </button>
            `;
                }).join('')}
      </div>
    `;
            }


            function renderFilters() {
                return `
      <div class="flex flex-col sm:flex-row gap-2 mb-3">
         
         <div class="relative flex-1 min-w-[150px]">
            <span class="absolute left-3 top-2.5 text-slate-500 w-4 h-4">${ICONS.search}</span>
            <input data-act="search" value="${esc(state.search)}" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 pl-9 pr-3 text-sm text-slate-200 outline-none focus:border-blue-500 transition" placeholder="Ara...">
         </div>

         ${state.tab === 'exp' ? `
           <div class="relative w-full sm:w-32 flex-shrink-0">
              <select data-act="flt-cat" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-3 text-sm text-slate-300 outline-none appearance-none cursor-pointer">
                <option value="">Kategori</option>
                ${Object.values(CATS).map(c => `<option value="${c.id}" ${state.catFilter === c.id ? 'selected' : ''}>${esc(c.l)}</option>`).join('')}
              </select>
              <div class="absolute right-3 top-2.5 text-slate-500 pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
           </div>

           <div class="flex gap-2 w-full sm:w-auto">
             <div class="relative flex-1 min-w-[50%] sm:w-32">
                <select data-act="flt-type" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-3 text-sm text-slate-300 outline-none appearance-none cursor-pointer">
                  <option value="">Ã–deme Tipi</option>
                  ${EXPENSE_TYPES.map(t => `<option value="${t.id}" ${state.typeFilter === t.id ? 'selected' : ''}>${esc(t.l)}</option>`).join('')}
                </select>
                <div class="absolute right-3 top-2.5 text-slate-500 pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
             </div>

             <div class="relative flex-1 min-w-[50%] sm:w-40">
                <select data-act="flt-ind" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-3 text-sm text-slate-300 outline-none appearance-none cursor-pointer">
                  ${INDIVIDUAL_FILTERS.map(f => `<option value="${f.id}" ${state.indFilter === f.id ? 'selected' : ''}>${esc(f.l)}</option>`).join('')}
                </select>
                <div class="absolute right-3 top-2.5 text-slate-500 pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
             </div>
           </div>
           
         ` : ''}
      </div>
    `;
            }

            function renderExpenseList(exp) {
                if (!exp.length) return `<div class="text-center py-8 text-slate-500 text-sm border border-dashed border-slate-800 rounded-xl">KayÄ±t bulunamadÄ±.</div>`;

                const grp = {}; exp.forEach(x => { const c = x.city || 'Genel'; if (!grp[c]) grp[c] = []; grp[c].push(x) });

                return `<div class="space-y-3 pb-24">${Object.keys(grp).sort().map(city => {
                    const lst = grp[city].sort((a, b) => (b.date || '').localeCompare(a.date) || (b.id.localeCompare(a.id)));
                    const expd = state.expandedCities[city];

                    let sumInBase = 0;
                    lst.forEach(x => {
                        sumInBase += convertToBase(x.amt, x.cur, state.baseCurrency);
                    });
                    const sumTxt = fmtNum(sumInBase) + ' ' + state.baseCurrency;

                    const cityColor = getCityColor(city);

                    return `
        <div class="bg-slate-800/40 border border-slate-700/50 rounded-2xl overflow-hidden relative group">
          
          <div class="relative w-full">
              <button data-act="tog-city" data-val="${esc(city)}" data-city-name="${esc(city)}" class="w-full flex items-center p-3 hover:bg-slate-800 transition relative text-left">
                <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-600/70" style="background-color:${cityColor}"></div>
                
                <div class="pl-3 flex-1 min-w-0 pr-16">
                  <div class="font-bold text-sm text-slate-200">${esc(city)}</div>
                  <div class="text-[10px] text-slate-500 mt-0.5">${lst.length} harcama Â· Toplam: <span class="text-slate-300 font-bold">${sumTxt}</span></div>
                </div>
              </button>
              
              <!-- Silme butonu artÄ±k wrapper iÃ§inde ve toggle butonundan baÄŸÄ±msÄ±z -->
              <button data-act="del-city" type="button" data-val="${esc(city)}" class="absolute right-4 top-1/2 -translate-y-1/2 p-2 text-slate-600 hover:text-red-400 hover:bg-slate-700 rounded-full transition z-20">
                  ${ICONS.trash.replace('w-4 h-4', 'w-3.5 h-3.5')}
              </button>
          </div>
          
          <div class="bg-slate-100 border-t border-slate-300 ${expd ? 'rounded-b-2xl' : ''}">
            ${expd ? lst.map((x, index) => {
                        const catInfo = CATS[x.cat] || CATS.other;
                        const typeInfo = EXPENSE_TYPES.find(t => t.id === x.type) || EXPENSE_TYPES[0];
                        const isLast = index === lst.length - 1;
                        const separatorClass = isLast ? '' : 'border-b border-slate-200';

                        return `
                <div data-act="detail" data-id="${x.id}" class="p-3 pl-6 flex justify-between items-center hover:bg-slate-200 cursor-pointer transition border-l-[3px] border-transparent hover:border-slate-400 ${separatorClass}">
                  
                   <div class="flex-1 min-w-0 pr-2">
                       <div class="text-sm font-bold text-slate-900 line-clamp-1">${esc(x.place)}</div>
                       <div class="text-[10px] text-slate-600 line-clamp-1">${esc(x.trip || 'Genel')} Â· ${fmtDate(x.date)}</div>
                   </div>

                   <div class="flex-shrink-0 w-32 text-[10px] pr-2 text-right">
                       <div class="flex items-center gap-1.5 justify-end">
                           <span class="text-xs text-slate-700">${catInfo.i}</span>
                           <span class="text-slate-700 font-medium">${esc(catInfo.l)}</span>
                       </div>
                       <div class="flex items-center justify-end gap-1.5 mt-0.5">
                           <span class="text-[9px] text-slate-500 mr-1">${esc(typeInfo.l)}</span>
                           <span class="text-slate-600 font-medium">(${x.isIndividual ? 'Bireysel' : 'Ortak'}${!x.isIndividual && x.payer ? ` Â· <span class="text-emerald-600 font-bold">${esc(x.payer)}</span>` : ''})</span>
                       </div>
                   </div>

                   <div class="text-right flex-shrink-0 w-16">
                      <div class="text-sm font-bold text-slate-900">${fmtNum(x.amt)}</div>
                      <div class="text-[10px] text-slate-600">${x.cur}</div>
                   </div>
                </div>`;
                    }).join('') : ''}
          </div>
        </div>`;
                }).join('')}</div>`;
            }

            function renderChecklist() {
                const done = state.chk.items.filter(i => i.done).length, total = state.chk.items.length;
                const pct = total ? Math.round((done * 100) / total) : 0;

                const sortedCats = [...state.chk.cats].sort((a, b) => {
                    if (a.id === 'otr') return 1;
                    if (b.id === 'otr') return -1;
                    return a.l.localeCompare(b.l);
                });

                return `
      <div class="relative overflow-hidden bg-gradient-to-r from-emerald-900/40 to-teal-900/40 border border-emerald-500/20 rounded-xl p-4 mb-4">
        <div class="flex justify-between items-end mb-2">
          <div><div class="text-[9px] font-bold text-emerald-400 uppercase">HazÄ±rlÄ±k Durumu</div><div class="text-sm text-emerald-100/80">${done} / ${total} tamamlandÄ±</div></div>
          <div class="text-xl font-bold text-white">${pct}%</div>
        </div>
        <div class="h-2 bg-slate-900/50 rounded-full overflow-hidden"><div class="h-full bg-emerald-500 transition-all duration-700" style="width:${pct}%"></div></div>
      </div>

      <!-- Yeni Kategori Ekleme Paneli -->
      <div class="mb-4 bg-slate-800/30 border border-slate-700/50 rounded-xl p-3 space-y-3">
        <h4 class="text-sm font-bold text-slate-300">Yeni Kategori Ekle</h4>
        <div class="flex gap-2">
            <input id="new-cat-name" placeholder="Kategori AdÄ± (Ã–rn: Plaj Malzemeleri)" class="flex-1 bg-slate-950/50 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-slate-200">
            <input id="new-cat-icon" placeholder="Emoji (ðŸ–ï¸)" class="w-16 text-center bg-slate-950/50 border border-slate-700 rounded-lg px-1 py-2 text-sm outline-none focus:border-blue-500 text-slate-200">
            <button data-act="add-cat" class="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-500 transition">${ICONS.plus.replace('w-4 h-4', 'w-3.5 h-3.5')}</button>
        </div>
      </div>


      <div class="pb-24 space-y-3">
        ${sortedCats.map(c => {
                    // Ä°temleri tarihe gÃ¶re sÄ±rala
                    const its = state.chk.items.filter(i => i.cat === c.id)
                        .sort((a, b) => {
                            const dateA = new Date(a.date || '3000-01-01'); // Tarihsizler en sona
                            const dateB = new Date(b.date || '3000-01-01');
                            if (dateA < dateB) return -1;
                            if (dateA > dateB) return 1;
                            return 0;
                        });

                    const isOpen = state.openChkCats[c.id];

                    return `
            <div class="bg-slate-800/30 border border-slate-700/50 rounded-xl overflow-hidden">
              
              <!-- KATEGORÄ° BAÅžLIÄžI VE AYARLAR -->
              <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-slate-800/50 transition">
                <div data-act="tog-chk-cat" data-val="${c.id}" class="flex items-center gap-3 flex-1 min-w-0 p-1 -m-1 focus:outline-none rounded-md cursor-pointer">
                   <div class="bg-slate-800 w-8 h-8 rounded flex items-center justify-center border border-slate-700">${c.i}</div>
                   <div>
                       <div class="flex items-center gap-2">
                           <div class="text-sm font-bold text-slate-200">${esc(c.l)}</div>
                           <div class="text-slate-600 transform transition ${isOpen ? 'rotate-180' : ''}">${ICONS.down}</div>
                       </div>
                       <div class="text-xs text-slate-500">${its.filter(i => i.done).length}/${its.length}</div>
                   </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button data-act="del-chk-cat-confirm" data-id="${c.id}" class="text-slate-600 hover:text-red-400 transition p-2 rounded-full hover:bg-slate-800/50 flex-shrink-0 z-10">
                        ${ICONS.trash.replace('w-4 h-4', 'w-3.5 h-3.5')}
                    </button>
                </div>
              </div>
              
              ${isOpen ? `
              
              <!-- MADDE EKLEME KUTUSU (TARÄ°HSÄ°Z) -->
<div class="p-3 pt-0 border-t border-slate-700/50 mt-2"> 
  <div class="flex gap-2 p-2 bg-slate-900/50 rounded-lg border border-slate-800">
    <input
      id="new-chk-item-${c.id}"
      data-cat-id="${c.id}"
      placeholder="Yeni madde (virgÃ¼lle birden fazla)"
      class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-xs w-full outline-none text-slate-200 placeholder-slate-600"
    >
    <button
      data-act="add-chk-single"
      data-cat-id="${c.id}"
      class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded-lg text-xs font-bold"
    >
      Ekle
    </button>
  </div>
</div>


              <!-- MEVCUT MADDELER -->
              <div class="bg-slate-900/30 border-t border-slate-700/50 p-2 space-y-1" data-cat-id="${c.id}">
                 ${its.map(i => `<div data-id="${i.id}" data-cat="${i.cat}" class="flex items-center gap-3 p-2 hover:bg-slate-800/30 rounded-lg group">
                     <input type="checkbox" data-act="chk" data-id="${i.id}" ${i.done ? 'checked' : ''} class="custom-checkbox w-4 h-4 rounded border-slate-600 bg-slate-800">
                     <span class="flex-1 text-sm text-slate-300 ${i.done ? 'line-through opacity-50' : ''}">${esc(i.val)}</span>
                     <span class="text-[10px] text-slate-500 font-mono flex-shrink-0">${i.date ? fmtDate(i.date) : ''}</span>
                     <button data-act="del-chk" data-id="${i.id}" class="text-slate-600 hover:text-rose-400 opacity-50 group-hover:opacity-100 transition p-1 -m-1">${ICONS.x.replace('w-4 h-4', 'w-3.5 h-3.5')}</button>
                  </div>`).join('')}
              </div>` : ''}
            </div>`;
                }).join('')}
      </div>
    `;
            }

            // YENÄ° FONKSÄ°YON: DÄ°ÄžER SEKME Ä°Ã‡ERÄ°ÄžÄ°

            function renderOtherTab() {
                const loc = state.location || {};
                const hasLoc = !!(loc.lat && loc.lng);

                const googleMapsBase = hasLoc
                    ? `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`
                    : 'https://www.google.com/maps';

                const nearbyTouristUrl = hasLoc ? `${googleMapsBase}+tourist+attractions` : googleMapsBase;
                const nearbyCafeUrl = hasLoc ? `${googleMapsBase}+cafes+restaurants` : googleMapsBase;
                const nearbyHotelUrl = hasLoc ? `${googleMapsBase}+hotels` : googleMapsBase;
                const nearbyHospitalUrl = hasLoc ? `${googleMapsBase}+hospitals` : googleMapsBase;
                const nearbyPharmacyUrl = hasLoc ? `${googleMapsBase}+pharmacies` : googleMapsBase;
                const nearbyPoliceUrl = hasLoc ? `${googleMapsBase}+police+stations` : googleMapsBase;

                const allTrips = getDistinctTripsAll().sort();
                const tripsWithSpending = allTrips;
                const allTripsForNotes = allTrips;

                let selectedTripForNotes = state.selectedNoteTrip || allTripsForNotes[0] || 'Genel';
                if (!allTripsForNotes.includes(selectedTripForNotes) && allTripsForNotes.length > 0) {
                    selectedTripForNotes = allTripsForNotes[0];
                }
                state.selectedNoteTrip = selectedTripForNotes;

                const notesForTrip = state.criticalNotes.filter(n => n.trip === selectedTripForNotes);

                const dataExport = JSON.stringify({
                    exp: state.exp,
                    trips: state.trips,
                    criticalNotes: state.criticalNotes,
                    res: state.res,
                    baseCur: state.baseCurrency
                }, null, 2);

                const helperCard = (href, emoji, label) => {
                    return `
    <a
      href="${href}"
      class="group relative flex flex-col items-center justify-center rounded-3xl border border-slate-700/70 bg-slate-900/70 px-3 py-4 shadow-lg hover:bg-slate-800/80 hover:border-slate-500 transition">
      <div class="mb-2 text-2xl">
        ${emoji}
      </div>
      <div class="text-[11px] font-semibold text-slate-100 text-center leading-tight">
        ${label}
      </div>
    </a>
  `;
                };

                return `
   <div class="grid grid-cols-3 gap-3">
   <!-- YENÄ°: SEYAHAT YÃ–NETÄ°MÄ° BUTONU -->
   <button data-act="open-trip-mgmt" class="group relative flex flex-col items-center justify-center rounded-3xl border border-emerald-700/70 bg-emerald-900/40 px-3 py-4 shadow-lg hover:bg-emerald-800/60 hover:border-emerald-500 transition">
       <div class="mb-2 text-2xl">ðŸ§³</div>
       <div class="text-[11px] font-semibold text-emerald-100 text-center leading-tight">Seyahat YÃ¶netimi</div>
   </button>

  ${helperCard('#helper-reservations', 'ðŸ“‘', 'Rezervasyonlar')}
  ${helperCard('#helper-flights', 'âœˆï¸', 'UÃ§uÅŸlar')}
  ${helperCard('#helper-report', 'ðŸ“Š', 'Rapor')}
  ${helperCard('#helper-route', 'ðŸ—ºï¸', 'Rota')}
  ${helperCard('#helper-critical', 'ðŸ“', 'Notlar')}
  ${helperCard('#helper-places', 'ðŸ“', 'YakÄ±n Yerler')}
  ${helperCard('#helper-health', 'âš•ï¸', 'SaÄŸlÄ±k')}
  ${helperCard('#helper-transport', 'ðŸšŒ', 'UlaÅŸÄ±m')}
  ${helperCard('#helper-data', 'ðŸ’¾', 'Veri / Yedek')}
  ${helperCard('#helper-help', 'â“', 'YardÄ±m')}
</div>

      <!-- REZERVASYONLAR POPUP -->
      <div id="helper-reservations" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">Rezervasyonlar</h3>
          <div class="space-y-4">
            <div class="w-full flex justify-between items-center pb-3">
              <h4 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                ${ICONS.reserve.replace('w-4 h-4', 'w-4 h-4')} Rezervasyonlar
              </h4>
              <button
                type="button"
                data-act="new-res"
                class="bg-blue-600 hover:bg-blue-500 text-xs font-bold transition px-3 py-1 rounded-lg flex items-center justify-center gap-1">
                ${ICONS.plus.replace('w-4 h-4', 'w-3.5 h-3.5')} Ekle
              </button>
            </div>
            ${renderReservationList()}
          </div>
        </div>
      </div>

      <!-- UÃ‡UÅžLAR POPUP -->
      <div id="helper-flights" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">UÃ§uÅŸlar</h3>
          <div class="space-y-4">
            <p class="text-xs text-slate-400 mb-3">
              UÃ§uÅŸlarÄ± aramak ve canlÄ± takip etmek iÃ§in aÅŸaÄŸÄ±daki servisleri kullanabilirsiniz.
            </p>
            <div class="grid grid-cols-2 gap-3">
              <a
                href="https://www.google.com/flights"
                target="_blank"
                class="bg-slate-900/70 border border-slate-700/70 rounded-xl px-3 py-3 flex flex-col items-center justify-center hover:bg-slate-800/80 hover:border-slate-500 transition shadow-sm">
                <div class="text-xl mb-1">âœˆï¸</div>
                <span class="text-xs font-bold text-white/90 text-center leading-tight">
                  Google Flights
                </span>
              </a>
              <a
                href="https://www.flightradar24.com/"
                target="_blank"
                class="bg-slate-900/70 border border-slate-700/70 rounded-xl px-3 py-3 flex flex-col items-center justify-center hover:bg-slate-800/80 hover:border-slate-500 transition shadow-sm">
                <div class="text-xl mb-1">ðŸ“¡</div>
                <span class="text-xs font-bold text-white/90 text-center leading-tight">
                  CanlÄ± UÃ§uÅŸ Takibi
                </span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- RAPOR POPUP -->
      <div id="helper-report" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">Seyahat Ã–zet Raporu</h3>
          ${renderReportContent()}
        </div>
      </div>

      <!-- ROTA POPUP -->
      <div id="helper-route" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">Yol GÃ¼zergahÄ± HaritasÄ±</h3>
          <div class="space-y-3">
            <p class="text-xs text-slate-400">
              Harcama kayÄ±tlarÄ±ndaki ÅŸehir ve mekan bilgilerine gÃ¶re Google Haritalar iÃ§in hÄ±zlÄ± rota baÄŸlantÄ±sÄ± oluÅŸturur.
            </p>
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">HarcamalarÄ± Olan Seyahati SeÃ§</label>
              <div class="relative">
                <select id="route-trip-select" data-act="set-route-trip"
                  class="w-full bg-slate-950/50 border border-slate-700/70 rounded-lg px-3 py-2 text-xs text-slate-100 outline-none focus:border-white cursor-pointer backdrop-blur-sm">
                  <option value="">-- Seyahat SeÃ§in --</option>
                  ${tripsWithSpending.map(t => `<option value="${esc(t)}" ${esc(state.routeTrip || '') === t ? 'selected' : ''}>${esc(t)}</option>`).join('')}
                </select>
              
              </div>
            </div>
            <div id="route-output-box">
              ${renderRoutePlanner()}
            </div>
          </div>
        </div>
      </div>

      <!-- NOTLAR POPUP -->
      <div id="helper-critical" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">Kritik Bilgiler (Notlar)</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Seyahat SeÃ§imi</label>
              <div class="relative">
                <select data-act="set-note-trip"
                  <select
  data-act="set-report-trip"
  class="w-full bg-slate-950/50 border border-slate-700/70 rounded-lg px-3 py-2 text-xs text-slate-100 outline-none focus:border-white cursor-pointer backdrop-blur-sm">

                  ${allTripsForNotes.map(t => `<option value="${esc(t)}" ${t === selectedTripForNotes ? 'selected' : ''}>${esc(t)}</option>`).join('')}
                </select>
                </div>
              </div>
            </div>
            <div>
              <h4 class="text-sm font-bold text-slate-300 mb-2">Yeni Not Ekle (${esc(selectedTripForNotes)})</h4>
              <div class="flex gap-2">
                <textarea id="new-note-input-other" data-act="update-new-note"
                  class="flex-1 bg-slate-950/60 border border-slate-700/70 rounded-lg px-3 py-2 text-xs text-slate-100 outline-none focus:border-teal-400 placeholder-slate-500"
                  placeholder="Ã–nemli not, hatÄ±rlatma veya kritik bilgi...">${esc(state.newCriticalNote || '')}</textarea>
                <button data-act="add-note"
                  class="w-10 h-10 flex items-center justify-center rounded-lg bg-teal-600 hover:bg-teal-500 text-white shadow-lg transition">
                  ${ICONS.plus.replace('w-4 h-4', 'w-4 h-4')}
                </button>
              </div>
            </div>
            <div>
              <h4 class="text-sm font-bold text-slate-300 mb-2">Mevcut Notlar (${esc(selectedTripForNotes)})</h4>
              <div class="space-y-2 max-h-48 overflow-y-auto scrl">
                ${notesForTrip.length
                        ? notesForTrip.map(note => `
                        <div class="bg-slate-700/70 border border-slate-600/60 rounded-lg px-3 py-2 text-sm text-slate-200 flex justify-between items-start gap-3">
                          <span class="flex-1 whitespace-pre-wrap">${esc(note.note)}</span>
                          <button data-act="del-note" data-val="${note.id}" class="text-slate-400 hover:text-red-400 p-1 -m-1">
                            ${ICONS.x.replace('w-4 h-4', 'w-3.5 h-3.5')}
                          </button>
                        </div>
                      `).join('')
                        : '<p class="text-sm text-slate-500 italic">Bu seyahat iÃ§in kritik not bulunmamaktadÄ±r.</p>'
                    }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- YAKIN YERLER POPUP -->
      <div id="helper-places" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">YakÄ±ndaki Yerler</h3>
          <div class="space-y-3">
            <p class="text-xs text-slate-400">Konumunuza gÃ¶re gezilecek yerler, kafeler ve oteller iÃ§in kÄ±sayollar.</p>
            <div class="grid grid-cols-3 gap-3 pt-1">
              <a href="${nearbyTouristUrl}" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.mapPin.replace('w-4 h-4', 'w-6 h-6')}
                <span class="text-[11px] font-bold text-white/90 text-center leading-tight">Gezilecek Yerler</span>
              </a>
              <a href="${nearbyCafeUrl}" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.restaurant.replace('w-4 h-4', 'w-6 h-6')}
                <span class="text-[11px] font-bold text-white/90 text-center leading-tight">Cafe & Restoran</span>
              </a>
              <a href="${nearbyHotelUrl}" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.bed.replace('w-4 h-4', 'w-6 h-6')}
                <span class="text-[11px] font-bold text-white/90 text-center leading-tight">Otel / Konaklama</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- SAÄžLIK POPUP -->
      <div id="helper-health" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">SaÄŸlÄ±k ve GÃ¼venlik</h3>
          <div class="space-y-3">
            <p class="text-xs text-slate-400">Konumunuza gÃ¶re saÄŸlÄ±k ve gÃ¼venlik kÄ±sayollarÄ±.</p>
            <div class="grid grid-cols-3 gap-3 pt-1">
              <a href="${nearbyHospitalUrl}" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.hospital.replace('w-4 h-4', 'w-6 h-6')}
                <span class="text-[11px] font-bold text-white/90 text-center leading-tight">Hastane</span>
              </a>
              <a href="${nearbyPharmacyUrl}" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.pharmacy.replace('w-4 h-4', 'w-6 h-6')}
                <span class="text-[11px] font-bold text-white/90 text-center leading-tight">Eczane</span>
              </a>
              <a href="${nearbyPoliceUrl}" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.police.replace('w-4 h-4', 'w-6 h-6')}
                <span class="text-[11px] font-bold text-white/90 text-center leading-tight">Polis / GÃ¼venlik</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- ULAÅžIM POPUP -->
      <div id="helper-transport" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">UlaÅŸÄ±m ve Haritalar</h3>
          <div class="space-y-3">
            <p class="text-xs text-slate-400">Toplu taÅŸÄ±ma ve harita uygulamalarÄ±na hÄ±zlÄ± eriÅŸim.</p>
            <div class="grid grid-cols-3 gap-3 pt-1">
              <a href="https://maps.google.com/maps?output=classic" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.mapPin.replace('w-4 h-4', 'w-6 h-6')}
                <div class="text-[10px] font-bold text-white text-center leading-tight">Google Haritalar</div>
              </a>
              <a href="https://moovitapp.com/" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                <div class="text-xl mb-1">ðŸšŒ</div>
                <div class="text-[10px] font-bold text-white text-center leading-tight">Moovit</div>
              </a>
              <a href="https://www.uber.com/" target="_blank" class="flex flex-col items-center justify-center gap-1 bg-slate-700/60 border border-slate-700/50 rounded-xl px-2 py-3 hover:bg-slate-700 transition shadow-sm">
                ${ICONS.taxi.replace('w-4 h-4', 'w-6 h-6')}
                <div class="text-[10px] font-bold text-white text-center leading-tight">Uber / Taksi</div>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- VERÄ° / YEDEK POPUP -->
      <div id="helper-data" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">Veri YÃ¶netimi (Yedekleme / YÃ¼kleme)</h3>
          <div class="space-y-3">
            <p class="text-sm text-slate-400 mb-1">
              TÃ¼m uygulama verilerinizi JSON formatÄ±nda dÄ±ÅŸa aktarabilir veya geri yÃ¼kleyebilirsiniz.
            </p>
            <textarea id="io-txt" class="w-full h-48 bg-black/50 border border-slate-700/70 rounded-lg px-3 py-2 text-xs text-slate-100 font-mono outline-none focus:border-teal-400 placeholder-slate-500"
              placeholder="Veri yedeÄŸi burada gÃ¶rÃ¼necek veya buraya yapÄ±ÅŸtÄ±rarak iÃ§e aktarabilirsiniz.">${esc(dataExport)}</textarea>
            <div class="flex flex-col sm:flex-row gap-3 pt-1">
              <button data-act="copy-json" class="flex-1 bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-200 py-2.5 rounded-lg font-medium text-sm">
                Kopyala
              </button>
              <button data-act="imp" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded-lg font-bold text-sm">
                YÃ¼kle
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- SEYAHAT YÃ–NETÄ°MÄ° POPUP -->
      <div id="helper-trips" class="helper-modal">
        <div class="helper-modal-inner relative">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">Seyahat YÃ¶netimi</h3>
          
          <div class="space-y-3">
             <div class="text-xs text-slate-400 mb-2">
                 KayÄ±tlÄ± seyahatlerinizi buradan dÃ¼zenleyebilir, kiÅŸi isimlerini gÃ¼ncelleyebilirsiniz.
             </div>
             
             <div class="space-y-2 max-h-[60vh] overflow-y-auto scrl pr-1">
                 ${state.trips.sort((a, b) => b.startDate.localeCompare(a.startDate)).map(t => `
                   <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-3 flex items-center justify-between group hover:bg-slate-800 transition">
                       <div class="flex-1 min-w-0 mr-3">
                           <div class="font-bold text-slate-200 text-sm truncate">${esc(t.name)}</div>
                           <div class="text-xs text-slate-500 mt-1 truncate">${esc(t.persons || 'KiÅŸi eklenmemiÅŸ')}</div>
                           <div class="text-[10px] text-slate-600 font-mono mt-0.5">${fmtDate(t.startDate)} ${t.endDate ? '- ' + fmtDate(t.endDate) : ''}</div>
                       </div>
                       <button data-act="edit-trip-detail" data-id="${t.id}" class="bg-slate-700 hover:bg-blue-600 text-slate-300 hover:text-white p-2 rounded-lg transition shadow-sm">
                           ${ICONS.edit.replace('w-4 h-4', 'w-4 h-4')}
                       </button>
                   </div>
                 `).join('')}
                 
                 ${!state.trips.length ? '<div class="text-center text-slate-500 text-sm py-8 border border-dashed border-slate-700 rounded-lg">HenÃ¼z seyahat kaydÄ± yok.</div>' : ''}
             </div>
             
             <button data-act="new-trip" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-500/30 transition flex items-center justify-center gap-2">
                 ${ICONS.plus.replace('w-4 h-4', 'w-5 h-5')} Yeni Seyahat Ekle
             </button>
          </div>
        </div>
      </div>

    </div>
      <!-- YARDIM / KULLANIM KILAVUZU POPUP -->
      <div id="helper-help" class="helper-modal">
        <div class="helper-modal-inner relative" style="max-width: 32rem; max-height: 85vh;">
          <a href="#other-root" class="helper-modal-close text-slate-400 hover:text-white">
            ${ICONS.x}
          </a>
          <h3 class="font-bold text-white mb-4 text-center text-base sm:text-lg">
            ðŸ“– KullanÄ±m KÄ±lavuzu
          </h3>

          <div class="space-y-6 overflow-y-auto max-h-[70vh] pr-2 scrl">
            
            <!-- 1. UYGULAMA TANITIMI -->
            <div class="bg-gradient-to-br from-blue-900/40 to-slate-800/40 rounded-xl border border-blue-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ </span>
                  <h4 class="font-bold text-white text-sm">1. Uygulama TanÄ±tÄ±mÄ±</h4>
                </div>

                <p class="text-xs text-slate-300 leading-relaxed">
                  Bu uygulama; seyahat harcamalarÄ±nÄ±zÄ±, rezervasyonlarÄ±nÄ±zÄ± ve kimin kime ne kadar borcu olduÄŸunu tek bir yerden takip etmenizi saÄŸlar.
                  <br/><br/>
                  <strong class="text-white">4 Ana Sekme:</strong>
                  <span class="text-cyan-300">Ã–zet</span> (genel bakÄ±ÅŸ), 
                  <span class="text-emerald-300">Harcamalar</span> (kayÄ±tlar), 
                  <span class="text-amber-300">Kontrol Listesi</span> (yapÄ±lacaklar), 
                  <span class="text-purple-300">DiÄŸer</span> (yardÄ±mcÄ± araÃ§lar)
                </p>
              </div>
            </div>

            <!-- 2. SEYAHAT YÃ–NETÄ°MÄ° -->
            <div class="bg-gradient-to-br from-emerald-900/40 to-slate-800/40 rounded-xl border border-emerald-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ§³</span>
                  <h4 class="font-bold text-white text-sm">2. Seyahat OluÅŸturma</h4>
                </div>

                <p class="text-xs text-slate-300 leading-relaxed">
                  Harcama veya rezervasyon eklerken <strong class="text-emerald-300">"+ Yeni Seyahat OluÅŸtur"</strong> seÃ§eneÄŸini kullanÄ±n.
                  <br/><br/>
                  <strong class="text-white">Ã–nemli:</strong> Seyahate katÄ±lacak kiÅŸileri <span class="text-amber-300">(Ã–rn: Ali, Veli, AyÅŸe)</span> virgÃ¼lle ayÄ±rarak yazÄ±n. 
                  Bu sayede <strong class="text-cyan-300">BorÃ§ Hesaplama</strong> Ã¶zelliÄŸi Ã§alÄ±ÅŸacaktÄ±r.
                </p>
              </div>
            </div>

            <!-- 3. HARCAMA EKLEME -->
            <div class="bg-gradient-to-br from-cyan-900/40 to-slate-800/40 rounded-xl border border-cyan-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ’°</span>
                  <h4 class="font-bold text-white text-sm">3. Harcama Ekleme</h4>
                </div>

                <p class="text-xs text-slate-300 leading-relaxed">
                  <strong class="text-cyan-300">+</strong> butonuna tÄ±klayarak yeni harcama ekleyin.
                  <br/><br/>
                  â€¢ <strong class="text-white">Seyahat:</strong> Hangi seyahate ait olduÄŸunu seÃ§in<br/>
                  â€¢ <strong class="text-white">Tutar:</strong> Harcama miktarÄ±nÄ± ve para birimini girin<br/>
                  â€¢ <strong class="text-white">Kategori:</strong> Yemek, ulaÅŸÄ±m, konaklama vb. seÃ§in<br/>
                  â€¢ <strong class="text-white">FotoÄŸraf:</strong> FiÅŸ/fatura fotoÄŸrafÄ± ekleyebilirsiniz
                </p>
              </div>
            </div>

            <!-- 4. BÄ°REYSEL / ORTAK SEÃ‡Ä°MÄ° -->
            <div class="bg-gradient-to-br from-purple-900/40 to-slate-800/40 rounded-xl border border-purple-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ‘¥</span>
                  <h4 class="font-bold text-white text-sm">4. Bireysel / Ortak Harcama</h4>
                </div>

                <p class="text-xs text-slate-300 leading-relaxed">
                  <strong class="text-purple-300">Ortak:</strong> TÃ¼m katÄ±lÄ±mcÄ±lar arasÄ±nda eÅŸit bÃ¶lÃ¼nÃ¼r. Kimin Ã¶dediÄŸini seÃ§in.
                  <br/>
                  <strong class="text-blue-300">Bireysel:</strong> Sadece sizi ilgilendirir, hesaplamaya dahil edilmez.
                  <br/><br/>
                  <span class="text-amber-300 italic">ðŸ’¡ Ä°pucu: Ortak seÃ§tiÄŸinizde "Harcayan" alanÄ± gÃ¶rÃ¼nÃ¼r ve Ã¶demeyi yapan kiÅŸiyi seÃ§ebilirsiniz.</span>
                </p>
              </div>
            </div>

            <!-- 5. BORÃ‡ DAÄžILIMI -->
            <div class="bg-gradient-to-br from-rose-900/40 to-slate-800/40 rounded-xl border border-rose-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ“Š</span>
                  <h4 class="font-bold text-white text-sm">5. BorÃ§ DaÄŸÄ±lÄ±mÄ± Raporu</h4>
                </div>

                <p class="text-xs text-slate-300 leading-relaxed">
                  <strong class="text-white">DiÄŸer â†’ Rapor</strong> menÃ¼sÃ¼nden bir seyahat seÃ§tiÄŸinizde:
                  <br/><br/>
                  â€¢ Toplam harcama Ã¶zeti gÃ¶rÃ¼ntÃ¼lenir<br/>
                  â€¢ <strong class="text-emerald-300">Kimin kime ne kadar Ã¶demesi gerektiÄŸi</strong> otomatik hesaplanÄ±r<br/>
                  â€¢ PDF olarak dÄ±ÅŸa aktarabilirsiniz
                </p>
              </div>
            </div>

            <!-- 6. REZERVASYONLAR -->
            <div class="bg-gradient-to-br from-amber-900/40 to-slate-800/40 rounded-xl border border-amber-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">âœˆï¸</span>
                  <h4 class="font-bold text-white text-sm">6. Rezervasyonlar</h4>
                </div>

                <p class="text-xs text-slate-300 leading-relaxed">
                  UÃ§ak, otel veya aktivite rezervasyonlarÄ±nÄ±zÄ± ekleyin.
                  <br/><br/>
                  â€¢ <strong class="text-white">Seyahat:</strong> Ä°lgili seyahati seÃ§meyi unutmayÄ±n<br/>
                  â€¢ <strong class="text-white">Onay Kodu:</strong> Rezervasyon numarasÄ±nÄ± kaydedin<br/>
                  â€¢ Ortak Ã¶denen rezervasyonlar iÃ§in <strong class="text-purple-300">"Ortak"</strong> seÃ§ip Ã¶deyeni belirtin
                </p>
              </div>
            </div>

            <!-- 7. VERÄ° YEDEKLEMÄ° -->
            <div class="bg-gradient-to-br from-slate-700/40 to-slate-800/40 rounded-xl border border-slate-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ’¾</span>
                  <h4 class="font-bold text-white text-sm">7. GiriÅŸ ve Yedekleme</h4>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 mb-3 border border-slate-700">
                  <div class="flex items-center justify-center gap-4">
                    <div class="text-center">
                      <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mb-1 mx-auto border border-red-500/50">
                        <span class="text-xl">G</span>
                      </div>
                      <span class="text-[10px] text-slate-400">Google GiriÅŸ</span>
                    </div>
                    <div class="text-2xl text-slate-600">â†’</div>
                    <div class="text-center">
                      <div class="w-12 h-12 bg-emerald-500/20 rounded-full flex items-center justify-center mb-1 mx-auto border border-emerald-500/50">
                        <span class="text-xl">â˜ï¸</span>
                      </div>
                      <span class="text-[10px] text-slate-400">Bulut Senkron</span>
                    </div>
                  </div>
                </div>
                <p class="text-xs text-slate-300 leading-relaxed">
                  Verileriniz tarayÄ±cÄ±nÄ±zda saklanÄ±r. KaybolmamasÄ± iÃ§in:
                  <br/><br/>
                  â€¢ SaÄŸ Ã¼stten <strong class="text-red-400">Google ile GiriÅŸ</strong> yapÄ±n (otomatik senkronizasyon)<br/>
                  â€¢ Veya <strong class="text-white">DiÄŸer â†’ Veri YÃ¶netimi</strong>'nden manuel yedek alÄ±n
                </p>
              </div>
            </div>

            <!-- 8. Ä°PUÃ‡LARI -->
            <div class="bg-gradient-to-br from-teal-900/40 to-slate-800/40 rounded-xl border border-teal-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ’¡</span>
                  <h4 class="font-bold text-white text-sm">8. HÄ±zlÄ± Ä°puÃ§larÄ±</h4>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 mb-3 border border-slate-700">
                  <div class="grid grid-cols-3 gap-3 text-center">
                    <div>
                      <div class="w-10 h-10 bg-amber-500/30 rounded-full flex items-center justify-center mb-1 mx-auto border border-amber-500/50">
                        <span class="text-lg">âš¡</span>
                      </div>
                      <span class="text-[10px] text-slate-300">HÄ±zlÄ± Ekle</span>
                    </div>
                    <div>
                      <div class="w-10 h-10 bg-cyan-500/30 rounded-full flex items-center justify-center mb-1 mx-auto border border-cyan-500/50">
                        <span class="text-lg">+</span>
                      </div>
                      <span class="text-[10px] text-slate-300">Yeni KayÄ±t</span>
                    </div>
                    <div>
                      <div class="w-10 h-10 bg-purple-500/30 rounded-full flex items-center justify-center mb-1 mx-auto border border-purple-500/50">
                        <span class="text-lg">ðŸ“Š</span>
                      </div>
                      <span class="text-[10px] text-slate-300">Grafik</span>
                    </div>
                  </div>
                </div>
                <p class="text-xs text-slate-300 leading-relaxed">
                  â€¢ <strong class="text-amber-300">âš¡ HÄ±zlÄ± Ekle:</strong> Seyahat, kategori ve tutar ile anÄ±nda harcama ekleyin<br/>
                  â€¢ <strong class="text-white">Ã–zet ekranÄ±:</strong> YaklaÅŸan seyahatler ve bakiyenizi gÃ¶rÃ¼n<br/>
                  â€¢ <strong class="text-white">Åžehir gruplarÄ±:</strong> HarcamalarÄ± ÅŸehirlere gÃ¶re filtreleyin
                </p>
              </div>
            </div>

            <!-- 9. GOOGLE TAKVÄ°M -->
            <div class="bg-gradient-to-br from-indigo-900/40 to-slate-800/40 rounded-xl border border-indigo-500/30 overflow-hidden">
              <div class="p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ðŸ“…</span>
                  <h4 class="font-bold text-white text-sm">9. Google Takvim Entegrasyonu</h4>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 mb-3 border border-slate-700">
                     <p class="text-xs text-white leading-relaxed mb-2">
                        RezervasyonlarÄ±nÄ±zÄ± telefon takviminize ve Google Takvim'e kolayca iÅŸleyebilirsiniz.
                     </p>
                    <ul class="text-[10px] text-slate-300 space-y-2 list-disc pl-4">
                        <li><strong>Otomatik Ekleme:</strong> Rezervasyon formunu doldururken en alttaki <span class="text-white">"Google Takvim'e Ekle"</span> kutucuÄŸunu iÅŸaretleyin. KaydettiÄŸiniz an takvim aÃ§Ä±lÄ±r.</li>
                        <li><strong>Sonradan Ekleme:</strong> Herhangi bir rezervasyonun detayÄ±na girip <span class="text-white">"Google Takvim'e Ekle"</span> butonunu kullanabilirsiniz.</li>
                    </ul>
                </div>
                <p class="text-xs text-slate-400 italic">
                  Not: Bu Ã¶zellik tarayÄ±cÄ± Ã¼zerinden Ã§alÄ±ÅŸÄ±r ve herhangi bir uygulama izni gerektirmez.
                </p>
              </div>
            </div>

          </div>
        </div>
      </div>

  `;
            }


            function renderForm() {
                const f = state.form;
                const trips = getDistinctTripsAll().sort();

                // KayÄ±tlÄ± seyahatler (state.trips) Ã¼zerinden kiÅŸi listesini alabilmek kurgusu
                const currentTripObj = (state.trips || []).find(t => t.name === f.trip);
                const tripPersons = currentTripObj ? currentTripObj.persons.split(',').map(p => p.trim()).filter(Boolean) : [];

                const imagesCount = f.imgs ? f.imgs.length : 0;
                const isImageLimitReached = imagesCount >= MAX_IMAGES;

                const isFuelActive = f.cat === 'fuel';

                // Yeni: Seyahat bazlÄ± varsayÄ±lan para birimi
                if (!f.id) {
                    const tripName = (f.trip || state.tripFilter || '').trim();
                    if (tripName) {
                        const tripExps = state.exp.filter(x => (x.trip || '') === tripName && x.cur);
                        const tripCurrencies = [...new Set(tripExps.map(x => x.cur || BASE_CURRENCY))];
                        if (tripCurrencies.length === 1) {
                            f.cur = tripCurrencies[0];
                        }
                    }
                }

                // Dinamik Payer (Harcayan) Listesi HTML
                let payerHtml = '';
                if (!f.isIndividual && tripPersons.length > 0) {
                    const payerOptions = tripPersons.map(p => `<option value="${esc(p)}" ${f.payer === p ? 'selected' : ''}>${esc(p)}</option>`).join('');
                    payerHtml = `
                 <div class="animate-[fadeIn_0.3s]">
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">HarcamayÄ± Yapan</label>
                    <div class="relative">
                       <select id="i-payer" required class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500 appearance-none cursor-pointer">
                          <option value="">-- SeÃ§iniz --</option>
                          ${payerOptions}
                       </select>
                       <div class="absolute right-3 top-3.5 text-slate-400 pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
                    </div>
                 </div>
                 `;
                }

                return `
      <div class="form-modal-overlay">
        <div class="bg-slate-900 w-full max-w-lg md:rounded-xl rounded-t-xl form-content-box p-4 border border-slate-800 shadow-2xl self-start mt-0 md:mt-4 mb-4">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-slate-900 pt-1 pb-3 z-10 border-b border-slate-800 -mx-4 px-4">
            <h2 class="font-bold text-lg text-white">${f.id ? 'HarcamayÄ± DÃ¼zenle' : 'Yeni KayÄ±t'}</h2>
            <button data-act="cancel" class="text-slate-400 hover:text-white transition">${ICONS.x}</button>
          </div>
          
          <div class="space-y-3">
            
            <!-- SEYAHAT SEÃ‡Ä°MÄ° (YENÄ°) -->
            <div>
                 <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Seyahat</label>
                 <div class="flex gap-2">
                     <div class="relative flex-1">
                       <input id="i-trip" list="dl-trip" 
                              class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500 transition" 
                              placeholder="Seyahat SeÃ§ veya Yaz" value="${esc(f.trip)}" autocomplete="off">
                       <datalist id="dl-trip">${trips.map(t => `<option value="${esc(t)}">`).join('')}</datalist>
                       <span class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400 text-xs">â–¼</span>
                     </div>
                     <button type="button" data-act="new-trip" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 text-emerald-400 hover:text-emerald-300 rounded-lg px-3 flex items-center justify-center transition" title="Yeni Seyahat OluÅŸtur">
                        ${ICONS.plus.replace('w-4 h-4', 'w-5 h-5')}
                     </button>
                 </div>
            </div>

            <!-- BÄ°REYSEL / ORTAK HARCAMA SEÃ‡Ä°MÄ° -->
            <div class="flex items-center justify-between p-3 bg-slate-800/50 border border-slate-700 rounded-lg">
                <div class="flex flex-col">
                    <label for="i-isIndividual" class="text-sm font-bold text-slate-200 cursor-pointer">
                        Bireysel Harcama
                    </label>
                    <span class="text-[10px] text-slate-500">Ä°ÅŸaretliyse ortak hesaba dahil edilmez</span>
                </div>
                <input type="checkbox" id="i-isIndividual" ${f.isIndividual ? 'checked' : ''} class="custom-checkbox w-5 h-5 rounded border-slate-600 bg-slate-700 focus:ring-blue-500" onchange="document.getElementById('payer-wrapper').style.display = this.checked ? 'none' : 'block'">
            </div>

            <!-- KATEGORÄ° SEÃ‡Ä°MÄ° (YUKARI TAÅžINDI) -->
            <div class="mb-3">
               <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Kategori</label>
               <div class="flex gap-2 overflow-x-auto pb-2 scrl">
                 ${Object.values(CATS).map(c => `
                   <button type="button" data-act="set-cat" data-val="${c.id}" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-lg border transition ${f.cat === c.id ? 'bg-blue-600/20 border-blue-500 text-white shadow-lg shadow-blue-500/20' : 'bg-slate-800 border-slate-700 text-slate-500 hover:border-slate-500'}">
                     <span class="text-xl mb-1">${c.i}</span><span class="text-[9px] font-bold">${esc(c.l)}</span>
                   </button>`).join('')}
               </div>
            </div>

            <!-- HARCAMAYI YAPAN (PAYER) - DÄ°NAMÄ°K -->
            <div id="payer-wrapper" style="display: ${f.isIndividual ? 'none' : 'block'}">
                ${payerHtml}
            </div>

            <div class="grid grid-cols-2 gap-3">
               <div>
                 <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Åžehir</label>
                 <input id="i-city" list="dl-city" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500" placeholder="Åžehir" value="${esc(f.city)}">
                 <datalist id="dl-city">${[...new Set(state.exp.map(x => x.city))].sort().map(c => `<option value="${esc(c)}">`).join('')}</datalist>
               </div>
               <div>
                 <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Mekan</label>
                 <input id="i-place" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500" placeholder="Mekan AdÄ± (Restoran, MÃ¼ze, Ä°stasyon)" value="${esc(f.place)}">
               </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
               <div class="col-span-1 relative">
                  <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Toplam Tutar</label>
                  <input id="i-amt" type="text" inputmode="decimal" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none focus:border-blue-500 font-mono" placeholder="0.00" value="${esc(f.amt)}">
                  <select id="i-cur" class="absolute right-1 top-[28px] bottom-1 bg-slate-700 text-slate-200 rounded-md text-xs px-2 outline-none border-l border-slate-600 cursor-pointer">
                     ${AVAILABLE_CURRENCIES.map(c => `<option value="${c}" ${f.cur === c ? 'selected' : ''}>${c}</option>`).join('')}
                  </select>
               </div>
               <div class="col-span-1 flex flex-col">
                  <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">KiÅŸi SayÄ±sÄ±</label>
                  <div class="flex items-center bg-slate-800 border border-slate-700 rounded-lg px-3 flex-1">
                      <span class="text-slate-500 text-xs mr-2">KiÅŸi:</span>
                      <input id="i-ppl" type="number" inputmode="numeric" min="1" class="w-full bg-transparent text-sm text-slate-200 outline-none text-center" value="${f.ppl}">
                  </div>
               </div>
            </div>
            
           <!-- TARÄ°H VE Ã–DEME TÄ°PÄ° ALANLARI -->
<div class="grid grid-cols-2 gap-3 items-start">
  <!-- TARÄ°H -->
  <div class="flex flex-col">
    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">
      Tarih
    </label>
    <div class="flex items-center bg-slate-800 border border-slate-700 rounded-lg px-3 h-10">
      <input
        id="i-date"
        type="date"
        class="w-full bg-transparent border-none outline-none text-sm text-slate-200"
      >
    </div>
  </div>

  <!-- Ã–DEME TÄ°PÄ° -->
  <div class="flex flex-col">
    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">
      Ã–deme Tipi
    </label>
    <div class="relative">
      <select
        id="i-type"
        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 pr-8 h-10 text-sm text-slate-200 outline-none appearance-none cursor-pointer"
      >
        ${EXPENSE_TYPES.map(t => `<option value="${t.id}" ${f.type === t.id ? 'selected' : ''}>${esc(t.l)}</option>`).join('')}
      </select>
      <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-xs text-slate-400">
        ${ICONS.down.replace('w-4 h-4', 'w-3 h-3')}
      </div>
    </div>
  </div>
</div>




            <textarea id="i-desc" rows="2" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 outline-none resize-none" placeholder="Not ekle...">${esc(f.desc)}</textarea>

            <!-- FOTOÄžRAF EKLEME ALANI -->
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-3">
                  <label class="cursor-pointer bg-slate-800 ${isImageLimitReached ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-700'} border border-slate-700 text-slate-300 text-xs px-4 py-3 rounded-lg transition flex-1 text-center">
                      ${isImageLimitReached ? `Maksimum ${MAX_IMAGES} FotoÄŸrafa UlaÅŸÄ±ldÄ±` : `+ FotoÄŸraf Ekle (${imagesCount}/${MAX_IMAGES})`}
                      <input type="file" data-act="img-upload" id="i-img" hidden accept="image/*" multiple ${isImageLimitReached ? 'disabled' : ''}>
                  </label>
              </div>
              
              <!-- Mevcut FotoÄŸraf Ã–nizlemeleri -->
              ${imagesCount > 0 ? `
              <div class="flex gap-2 overflow-x-auto pb-2">
                ${f.imgs.map((s, i) => `
                  <div class="relative w-16 h-16 rounded-lg overflow-hidden border border-slate-700 flex-shrink-0 group">
                    <img src="${s}" data-act="lb" class="w-full h-full object-cover cursor-zoom-in hover:scale-110 transition duration-300">
                    <button type="button" data-act="del-img" data-val="${i}" class="absolute inset-0 bg-black/50 text-white flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">X</button>
                  </div>
                `).join('')}
              </div>` : ''}
            </div>
            <!-- FOTOÄžRAF EKLEME ALANI BÄ°TÄ°Åž -->

            <button type="button" data-act="save" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-blue-500/30 transition">Kaydet</button>
          </div>
        </div>
      </div>`;
            }

            function renderModal(type) {
                if (type === 'tz-select') {
                    const currentTZ = state.targetTimezone;
                    const sortedTzs = [...TIMEZONES].sort((a, b) => a.id.localeCompare(b.id));

                    return `
        <div class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" data-act="close-mod" data-val="tzSelectOverlay">
          <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-800 p-5 shadow-2xl relative">
            <button data-act="close-mod" data-val="tzSelect" class="absolute top-3 right-3 text-slate-500 hover:text-white">${ICONS.x}</button>
            <h3 class="font-bold text-white mb-4 text-center">Seyahat Saat Dilimini SeÃ§</h3>
            
            <div class="h-64 overflow-y-auto scrl space-y-2">
              ${sortedTzs.map(tz => `
                <div data-act="select-tz" data-val="${tz.id}" class="flex justify-between items-center p-3 rounded-lg cursor-pointer transition ${currentTZ === tz.id ? 'bg-blue-600/20 text-blue-300 border border-blue-600' : 'bg-slate-800 border border-slate-700 hover:bg-slate-700/50 text-slate-200'}">
                   <div class="font-medium text-sm">${esc(tz.name)}</div>
                   <div class="text-xs font-mono">${formatTime(tz.id).time}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
                }

                if (type === 'detail') {
                    const x = state.exp.find(e => e.id === state.selExp); if (!x) return '';
                    const cat = CATS[x.cat] || CATS.other;
                    const typeInfo = EXPENSE_TYPES.find(t => t.id === x.type) || EXPENSE_TYPES[0];
                    const ppl = parseInt(x.ppl) || 1;
                    const perP = x.amt / ppl;
                    const allTrips = [...new Set(state.exp.map(z => z.trip).filter(Boolean))].sort();

                    const mapQuery = encodeURIComponent(`${x.place}, ${x.city}`);
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;

                    const badgeCls = 'flex items-center gap-1.5 bg-white/10 px-2 py-0.5 rounded-full border border-white/20 backdrop-blur-md text-white text-xs font-bold shadow-sm';

                    const pplBadge = `
        <div class="flex items-center gap-1.5 ${badgeCls} text-white/80 text-xs font-bold shadow-sm">
           ${ICONS.person.replace('w-4 h-4', 'w-3 h-3')} <span class="ml-1">${ppl} KiÅŸi</span>
        </div>
      `;

                    const isFuelActive = x.cat === 'fuel';
                    const startKm = Number(x.startKm) || 0;
                    const endKm = Number(x.endKm) || 0;
                    const distance = endKm > startKm ? endKm - startKm : 0;
                    const fuelAmount = Number(x.fuelAmount) || 0;

                    const consumption = distance > 0 && fuelAmount > 0 ? ((fuelAmount / distance) * 100).toFixed(2) : '-';

                    const fuelInfo = isFuelActive ? `
        <div class="bg-red-900/40 rounded-lg p-3 border border-red-700/50 space-y-2">
            <div class="text-xs font-bold text-red-400 uppercase flex items-center gap-2">
                ${CATS.fuel.i} YAKIT BÄ°LGÄ°LERÄ° VE TÃœKETÄ°M
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm text-slate-200 border-b border-red-700/50 pb-2">
                <div>
                    <div class="text-[10px] text-slate-500 uppercase">BaÅŸlangÄ±Ã§ Km</div>
                    <div class="font-medium">${esc(x.startKm)} Km</div>
                </div>
                <div>
                    <div class="text-[10px] text-slate-500 uppercase">BitiÅŸ Km</div>
                    <div class="font-medium">${esc(x.endKm)} Km</div>
                </div>
                <div class="col-span-2">
                    <div class="text-[10px] text-slate-500 uppercase">Kat Edilen Mesafe</div>
                    <div class="font-bold text-lg text-white">${distance} Km</div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-sm text-slate-200 pt-2">
                <div>
                    <div class="text-[10px] text-slate-500 uppercase">AlÄ±nan Miktar</div>
                    <div class="font-medium">${esc(x.fuelAmount)} L</div>
                </div>
                <div>
                    <div class="text-[10px] text-slate-500 uppercase">Ortalama TÃ¼ketim</div>
                    <div class="font-medium">${consumption} L/100 Km</div>
                </div>
            </div>
        </div>
      ` : '';

                    const estimatedBaseCur = convertToBase(x.amt, x.cur, state.baseCurrency);

                    const tripMoveSection = isFuelActive ? '' : `
               <!-- SEYAHATE TAÅžIMA (KOMPAKT + SEÃ‡Ä°M) -->
               <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                 <div class="flex items-center gap-2 mb-2">
                   <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                   <span class="text-xs text-slate-200">Seyahati GÃ¼ncelle / TaÅŸÄ±</span>
                 </div>

                 <div class="space-y-2">
                   ${allTrips.length ? `
                   <div>
                     <label class="block text-[11px] text-slate-400 mb-1">Mevcut seyahatlerden seÃ§</label>
                     <select id="move-trip-select"
                             class="w-full bg-slate-900/70 border border-slate-700/70 rounded-lg px-2 py-1.5 text-xs text-slate-100 outline-none focus:border-blue-400">
                        <option value="">Seyahat seÃ§ (opsiyonel)</option>
                        ${allTrips.map(t => `<option value="${esc(t)}" ${t === (x.trip || '') ? 'selected' : ''}>${esc(t)}</option>`).join('')}
                        <option value="__new__">+ Yeni seyahat adÄ± gireceÄŸim</option>
                     </select>
                   </div>
                   ` : ``}

                   <div class="flex gap-2 items-center">
                     <input id="move-trip-inp"
                            placeholder="Yeni seyahat adÄ± yaz veya yukarÄ±dan seÃ§"
                            class="flex-1 bg-slate-900/70 border border-slate-700/70 rounded-lg px-2 py-1.5 text-xs outline-none text-slate-300 placeholder-slate-600"
                            list="dl-all-trips">
                     <datalist id="dl-all-trips">${allTrips.map(t => `<option value="${esc(t)}">`).join('')}</datalist>
                     <button data-act="move-trip"
                             class="bg-blue-600/80 hover:bg-blue-500 text-xs font-semibold text-white px-3 py-1.5 rounded-lg border border-blue-400/70 hover:text-white transition whitespace-nowrap">
                       TaÅŸÄ±
                     </button>
                   </div>

                   <p class="text-[10px] text-slate-500 mt-1 italic">
                     Mevcut Seyahat: <span class="text-slate-200">${esc(x.trip || 'Genel')}</span>
                   </p>
                 </div>
               </div>
      `;


                    return `
        <div class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-start justify-center p-0 md:p-4 animate-[fadeIn_0.2s] mt-4" data-act="close-mod" data-val="overlay">
          <div class="bg-slate-900 w-full max-w-md md:rounded-xl rounded-t-xl overflow-hidden shadow-2xl relative border border-slate-800" data-act="noop">
             
             <!-- SABÄ°T GRADIENT BAÅžLIK -->
             <div class="relative p-4 pb-10 overflow-hidden fixed-gradient-header">
                <div class="absolute inset-0 backdrop-blur-[2px]"></div>
                
                <div class="relative z-10 flex justify-between items-start mb-2">
                  <div class="flex items-center gap-2">
                     <!-- KATEGORÄ° -->
                     <div class="${badgeCls}">
                        <span>${cat.i}</span><span class="text-xs font-bold uppercase">${esc(cat.l)}</span>
                     </div>
                     <!-- KÄ°ÅžÄ° SAYISI -->
                     ${pplBadge}
                  </div>
                  <button data-act="close-mod" data-val="detail" class="bg-black/20 hover:bg-black/40 text-white rounded-full p-1.5 transition backdrop-blur-md">${ICONS.x}</button>
                </div>

                <div class="relative z-10 mt-1">
                   <h2 class="text-xl font-bold text-white mb-1 leading-tight drop-shadow-md">${esc(x.place)}</h2>
                   
                   <div class="flex items-center gap-2 text-white/80 text-xs font-medium">
                      <span class="bg-black/20 px-2 py-0.5 rounded-full text-[10px]">${esc(x.city)}</span>
                      <span class="w-1 h-1 rounded-full bg-white/60"></span>
                      <span>${fmtDate(x.date)}</span>
                   </div>
                   
                   <div class="relative z-10 mt-4 flex justify-between items-end">
                       <div class="inline-block">
                           <div class="text-[10px] text-white/80 font-medium">Seyahat / KiÅŸi BaÅŸÄ±</div>
                           <div class="text-sm font-bold text-white">${esc(x.trip || 'Genel')} / ${fmtNum(perP)} ${x.cur}</div>
                       </div>
                       <div class="text-right inline-block">
                           <div class="text-[10px] text-white/80">Toplam Tutar (${x.cur})</div>
                           <div class="text-2xl font-bold text-white tracking-tight text-center">${fmtNum(x.amt)} <span class="text-sm font-medium opacity-70">${x.cur}</span></div>
                           
                           <!-- HARCAMA TÄ°PÄ° VE BÄ°REYSEL/ORTAK BÄ°LGÄ°SÄ° -->
                           <div class="text-[10px] text-white/70 mt-1">Ã–deme: ${esc(typeInfo.l)} (${x.isIndividual ? 'Bireysel' : 'Ortak'})</div>
                           ${!x.isIndividual && x.payer ? `<div class="text-[10px] text-emerald-300 mt-0.5 font-bold">Harcayan: ${esc(x.payer)}</div>` : ''}
                       </div>
                   </div>
                </div>
             </div>

             <!-- Body -->
             <div class="bg-slate-900 p-4 space-y-3 overflow-y-auto max-h-[70vh]">
               
               <!-- YAKIT BÄ°LGÄ°LERÄ° -->
               ${fuelInfo}

               <!-- SEYAHATE TAÅžIMA (KOMPAKT) -->
               ${tripMoveSection}
               
               <!-- GOOGLE MAPS LÄ°NKÄ° -->
               <button data-act="open-map" data-val="${mapUrl}" class="flex items-center justify-center gap-2 bg-slate-800/30 hover:bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 transition cursor-pointer w-full">
                  ${ICONS.mapPin.replace('w-4 h-4', 'w-4 h-4')}
                  <span class="text-sm font-medium text-blue-400 hover:text-blue-300">Haritada GÃ¶ster: ${esc(x.place)}</span>
               </button>

               <div class="bg-slate-800/30 rounded-lg p-3 border border-slate-700/50 min-h-[50px]">
                 <div class="text-xs font-bold text-slate-500 mb-1 uppercase">Notlar</div>
                 <p class="text-sm text-slate-300 whitespace-pre-wrap leading-relaxed">${esc(x.desc) || '<span class="italic text-slate-600">Not eklenmemiÅŸ.</span>'}</p>
               </div>

               ${x.imgs && x.imgs.length ? `
               <div>
                  <div class="text-xs font-bold text-slate-500 mb-2 uppercase">FotoÄŸraflar (${x.imgs.length})</div>
                  <div class="grid grid-cols-3 gap-2">
                    ${x.imgs.map(img => `<div class="aspect-square rounded-lg overflow-hidden border border-slate-700 bg-slate-800"><img src="${img}" data-act="lb" class="w-full h-full object-cover cursor-zoom-in hover:scale-110 transition duration-300"></div>`).join('')}
                  </div>
               </div>` : ''}

               <div class="flex gap-3 pt-2">
                 <button data-act="del-exp-detail" class="flex-1 py-2.5 rounded-lg font-bold text-sm bg-gradient-to-r from-red-600/10 to-rose-700/10 text-red-400 border border-red-500/20 hover:from-red-600 hover:to-rose-700 hover:text-white transition flex items-center justify-center gap-1.5">
                   ${ICONS.trash.replace('w-4 h-4', 'w-3.5 h-3.5')} Sil
                 </button>
                 <button data-act="edit" class="flex-1 py-2.5 rounded-lg font-bold text-sm bg-slate-800 text-slate-200 border border-slate-700 hover:bg-slate-700 transition flex items-center justify-center gap-1.5">
                   ${ICONS.edit.replace('w-4 h-4', 'w-3.5 h-3.5')} DÃ¼zenle
                 </button>
               </div>
             </div>
          </div>
        </div>`;
                }

                // YENÄ° REZERVASYON FORMU MODALI
                if (type === 'res-form') {
                    return renderResForm();
                }

                // YENÄ° REZERVASYON DETAY MODALI
                if (type === 'res-detail') {
                    return renderResDetailModal();
                }


                if (type === 'chart') {
                    const ds = getChartDataset();
                    const tripText = (ds.trips && ds.trips.length)
                        ? ds.trips.join(', ')
                        : (state.tripFilter || 'TÃ¼m Seyahatler');
                    const totalText = ds.total ? fmtNum(ds.total) + ' ' + (ds.currency || '') : '0';

                    return `
        <div class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4" data-act="close-mod" data-val="chartOverlay">
          <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-800 shadow-2xl relative overflow-hidden" data-act="noop">
            <button data-act="close-mod" data-val="chart" class="absolute top-3 right-3 text-slate-500 hover:text-white">
              ${ICONS.x}
            </button>
            <div class="p-4 border-b border-slate-800">
              <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                ${ICONS.chart.replace('w-4 h-4', 'w-4 h-4')}
                <span>Harcama GrafiÄŸi (${ds.currency})</span>
              </h3>
              <p class="text-[11px] text-slate-400 mt-1">
                Grafik, **yalnÄ±zca** seÃ§ili (${ds.currency}) para birimi Ã¼zerinden filtrelenmiÅŸ harcamalarÄ± gÃ¶sterir.
              </p>
              <p class="text-[11px] text-slate-400 mt-1">
                Seyahat: <span class="text-slate-200">${tripText}</span>
              </p>
            </div>
            <div class="p-4 space-y-3">
              <div class="h-56 relative">
                <canvas id="exp-chart"></canvas>
              </div>
              <div class="flex items-center justify-between text-xs text-slate-300">
                <span>Toplam</span>
                <span class="font-semibold text-white">${totalText}</span>
              </div>
              ${ds.currencies && ds.currencies.length > 1 ? `
              <p class="text-[11px] text-slate-500">
                FarklÄ± bir para birimi Ã¼zerinden daÄŸÄ±lÄ±m gÃ¶rmek iÃ§in filtreyi deÄŸiÅŸtirin:
              </p>
              <div class="relative w-full">
                 <select data-act="set-chart-currency" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-3 pr-8 text-sm text-white outline-none focus:border-white appearance-none cursor-pointer backdrop-blur-sm">
                   ${ds.currencies.map(c => `<option value="${c}" ${state.chartCurrency === c ? 'selected' : ''}>${c}</option>`).join('')}
                 </select>
                 <div class="absolute right-3 top-2.5 text-white pointer-events-none">${ICONS.down.replace('w-4 h-4', 'w-3.5 h-3.5')}</div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
                }

                return '';
            }


            function renderQuickExpensePanel() {
                const baseCur = state.baseCurrency || BASE_CURRENCY;
                const q = state.quickExp || { trip: '', cat: 'food', amt: '', cur: baseCur };
                const allTrips = getDistinctTripsAll();
                const tripOptions = allTrips.map(t => `<option value="${esc(t)}">`).join('');
                const autoCur = getCurrencyForTrip(q.trip || '');
                const cur = (q.cur && q.cur.trim()) || autoCur || baseCur;

                const catDefs = [
                    { id: 'food', label: 'Cafe', icon: CATS.food.i },
                    { id: 'shopping', label: 'Market', icon: CATS.shopping.i },
                    { id: 'transport', label: 'UlaÅŸÄ±m', icon: CATS.transport.i },
                    { id: 'other', label: 'DiÄŸer', icon: CATS.other.i },
                ];

                const catButtons = catDefs.map(c => {
                    const active = q.cat ? q.cat === c.id : c.id === 'food';
                    const baseCls = "px-2.5 py-1.5 rounded-full text-xs font-medium flex items-center gap-1.5 border backdrop-blur";
                    const cls = active
                        ? baseCls + " bg-amber-500 text-white border-amber-300 shadow"
                        : baseCls + " bg-slate-900/60 text-slate-200 border-slate-600 hover:bg-slate-800";
                    return `<button type="button" data-act="quick-set-cat" data-val="${c.id}" class="${cls}">
                      <span>${c.icon}</span><span>${c.label}</span>
                  </button>`;
                }).join('');

                return `
        <div class="fixed inset-x-0 bottom-0 z-40 px-4 pb-4">
          <div class="mx-auto max-w-md rounded-2xl border border-slate-700/70 bg-slate-900/95 shadow-2xl backdrop-blur-xl p-4 space-y-3">
            <div class="flex items-center justify-between">
              <div class="text-xs font-semibold uppercase tracking-wide text-amber-300">HÄ±zlÄ± Harcama</div>
              <button type="button" data-act="open-quick-exp" class="text-slate-400 hover:text-white text-xs">Kapat</button>
            </div>
            <div class="space-y-2">
              <div>
                <label class="block text-[10px] text-slate-400 mb-1">Seyahat</label>
                <div class="relative">
                  <input id="q-trip" list="dl-all-trips-quick"
                         class="w-full bg-slate-950/60 border border-slate-700 rounded-xl px-3 py-1.5 text-xs text-slate-100 placeholder-slate-500 outline-none focus:border-amber-400"
                         placeholder="Seyahat adÄ± yaz veya seÃ§"
                         value="${esc(q.trip || '')}">
                  <datalist id="dl-all-trips-quick">${tripOptions}</datalist>
                </div>
              </div>
              <div class="flex flex-wrap gap-2">
                ${catButtons}
              </div>
              <div class="flex items-end gap-3">
                <div class="flex-1">
                  <label class="block text-[10px] text-slate-400 mb-1">Tutar</label>
                  <input id="q-amt" type="number" min="0" step="0.01"
                         class="w-full bg-slate-950/60 border border-slate-700 rounded-xl px-3 py-1.5 text-xs text-slate-100 placeholder-slate-500 outline-none focus:border-amber-400"
                         placeholder="0,00">
                </div>
                <div class="w-[72px]">
                  <label class="block text-[10px] text-slate-400 mb-1">Para Birimi</label>
                  <div class="bg-slate-900/80 border border-slate-700 rounded-xl px-2 py-1.5 text-xs text-slate-100 text-center">
                    <span id="q-cur">${cur}</span>
                  </div>
                </div>
              </div>
              <button type="button" data-act="save-quick-exp"
                      class="w-full mt-1 inline-flex items-center justify-center gap-2 rounded-xl bg-amber-500 hover:bg-amber-400 active:bg-amber-600 text-xs font-semibold text-slate-900 py-2 shadow-lg shadow-amber-500/40">
                ${ICONS.wallet.replace('w-4 h-4', 'w-4 h-4')} HÄ±zlÄ± Kaydet
              </button>
            </div>
          </div>
        </div>`;
            }

            function renderApp() {
                try {
                    const root = document.getElementById('app-root');

                    const exp = state.exp.filter(x => {
                        if (state.tab === 'exp') {
                            if (state.tripFilter && x.trip !== state.tripFilter) return false;
                            if (state.catFilter && x.cat !== state.catFilter) return false;
                            if (state.typeFilter && x.type !== state.typeFilter) return false;
                            if (state.indFilter === 'individual' && x.isIndividual !== true) return false;
                            if (state.indFilter === 'shared' && x.isIndividual !== false) return false;

                            if (state.search) { const q = state.search.toLowerCase(); return (x.city || '').toLowerCase().includes(q) || (x.place || '').toLowerCase().includes(q); }
                        }
                        return true;
                    });

                    state._visibleExp = exp;

                    let h = renderHeader();
                    if (state.err) h += `<div class="bg-rose-500/20 text-rose-200 p-3 rounded-lg mb-4 border border-rose-500/30 text-sm flex items-center gap-2 font-bold">${ICONS.info} ${state.err}</div>`;

                    if (state.view === 'list') {
                        h += renderTabs();

                        if (state.tab === 'sum') {
                            h += renderSummary();
                        } else if (state.tab === 'exp') {
                            h += `<div class="mb-4">${renderDashboardHeader(exp)}</div>`;
                            h += renderFilters();
                            h += renderExpenseList(exp);
                        } else if (state.tab === 'chk') {
                            h += renderChecklist();
                        } else if (state.tab === 'other') {
                            h += renderOtherTab();
                        }

                        // YalnÄ±zca Harcamalar sekmesindeyken + ve HÄ±zlÄ± Ekle butonlarÄ±nÄ± gÃ¶ster
                        if (state.tab === 'exp') {
                            h += `
              <div class="fixed bottom-6 right-6 z-40 flex items-center gap-3">
                <button data-act="open-quick-exp"
                        class="w-11 h-11 bg-amber-500 hover:bg-amber-400 active:bg-amber-600 rounded-full shadow-2xl shadow-amber-500/40 flex items-center justify-center transition transform hover:scale-105 active:scale-95 border border-white/10">
                  ${ICONS.wallet.replace('w-4 h-4', 'w-5 h-5')}
                </button>
                <button data-act="new"
                        class="w-12 h-12 bg-cyan-600 hover:bg-cyan-500 active:bg-cyan-700 rounded-full shadow-2xl shadow-cyan-600/40 flex items-center justify-center transition transform hover:scale-105 active:scale-95 border border-white/10">
                  ${ICONS.plus.replace('w-4 h-4', 'w-5 h-5')}
                </button>
              </div>`;
                        }

                        if (state.quickExpOpen) {
                            h += renderQuickExpensePanel();
                        }

                    } else {
                        h += renderForm();
                    }

                    if (state.modals.tzSelect) h += renderModal('tz-select');
                    if (state.modals.detail) h += renderModal('detail');
                    if (state.modals.chart) h += renderModal('chart');

                    // YENÄ° MODALLAR
                    if (state.modals.resForm) h += renderModal('res-form');
                    if (state.modals.resDetail) h += renderModal('res-detail');
                    if (state.modals.tripForm) h += renderTripForm(); // Trip Formu Eklendi

                    if (state.lightbox) h += `<div class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-2 backdrop-blur-xl" data-act="close-lb"><img src="${state.lightbox}" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl"></div>`;

                    root.innerHTML = h;
                    if (state.modals.chart) {
                        setTimeout(renderExpenseChart, 0);
                    }
                    // Login ikonunu auth durumuna gÃ¶re her render sonrasÄ± gÃ¼ncelle
                    if (typeof updateAuthUi === 'function') {
                        updateAuthUi();
                    }

                    // Form alanlarÄ±nÄ±n deÄŸerini manuel olarak ayarlama
                    if (state.view === 'form' && state.form.date) {
                        const dateInput = document.getElementById('i-date');
                        if (dateInput) dateInput.value = state.form.date;
                    }
                    if (state.view === 'form' && state.form.type) {
                        const typeSelect = document.getElementById('i-type');
                        if (typeSelect) typeSelect.value = state.form.type;
                    }

                    // Rezervasyon Formu alanlarÄ±nÄ±n deÄŸerini manuel olarak ayarlama
                    if (state.modals.resForm && state.resForm.startDate) {
                        const startDateInput = document.getElementById('i-res-start-date');
                        if (startDateInput) startDateInput.value = state.resForm.startDate;
                    }
                    if (state.modals.resForm && state.resForm.endDate) {
                        const endDateInput = document.getElementById('i-res-end-date');
                        if (endDateInput) endDateInput.value = state.resForm.endDate;
                    }

                } catch (e) {
                    console.error(e);
                    const root = document.getElementById('app-root');
                    if (root) {
                        const msg = (e && e.message) ? e.message : String(e || 'Bilinmeyen hata');
                        root.innerHTML = '<div class="p-4 text-sm text-red-300 bg-slate-900">Uygulama hata verdi: ' + msg + '</div>';
                    }
                }
            }

            // YENÄ°: CHANGE/INPUT EVENT LISTENER (Trip Select Box Ä°Ã§in)
            // 'input' event'i datalist seÃ§imlerinde daha tutarlÄ±dÄ±r
            document.addEventListener('input', e => {
                // Harcama Formu Trip SeÃ§imi
                if (e.target.id === 'i-trip') {
                    if (e.target.value === '__new__') {
                        state.tripForm = getEmptyTripForm();
                        state.modals.tripForm = true;
                        e.target.value = '';
                        renderApp();
                    } else {
                        // Trip seÃ§ildi
                        state.form.trip = e.target.value;
                        // Seyahat'in kiÅŸi bilgisi var mÄ± kontrol et
                        const tripObj = state.trips.find(t => t.name === state.form.trip);
                        if (tripObj && tripObj.persons) {
                            state.form.isIndividual = false; // Ortak harcamaya Ã§evir ki Payer alanÄ± gÃ¶rÃ¼nsÃ¼n
                        }
                        renderApp();
                    }
                }

                // Rezervasyon Formu Trip SeÃ§imi
                if (e.target.id === 'i-res-trip') {
                    if (e.target.value === '__new__') {
                        // Ã–nce mevcut form deÄŸerlerini kaydet
                        const nameInput = document.getElementById('i-res-name');
                        if (nameInput) state.resForm.name = nameInput.value;
                        const locInput = document.getElementById('i-res-location');
                        if (locInput) state.resForm.location = locInput.value;
                        const codeInput = document.getElementById('i-res-code');
                        if (codeInput) state.resForm.code = codeInput.value;
                        const costInput = document.getElementById('i-res-cost');
                        if (costInput) state.resForm.cost = costInput.value;
                        const notesInput = document.getElementById('i-res-notes');
                        if (notesInput) state.resForm.notes = notesInput.value;

                        state.tripForm = getEmptyTripForm();
                        state.modals.tripForm = true;
                        e.target.value = '';
                        renderApp();
                    } else {
                        // Ã–nce mevcut form deÄŸerlerini kaydet
                        const nameInput = document.getElementById('i-res-name');
                        if (nameInput) state.resForm.name = nameInput.value;
                        const locInput = document.getElementById('i-res-location');
                        if (locInput) state.resForm.location = locInput.value;
                        const codeInput = document.getElementById('i-res-code');
                        if (codeInput) state.resForm.code = codeInput.value;
                        const costInput = document.getElementById('i-res-cost');
                        if (costInput) state.resForm.cost = costInput.value;
                        const notesInput = document.getElementById('i-res-notes');
                        if (notesInput) state.resForm.notes = notesInput.value;

                        state.resForm.trip = e.target.value;
                        const tripObj = state.trips.find(t => t.name === state.resForm.trip);
                        if (tripObj && tripObj.persons) {
                            state.resForm.isIndividual = false;
                        }
                        renderApp();
                    }
                }
            });

            // DRAG AND DROP HANDLERS (KaldÄ±rÄ±ldÄ±)
            window.handleDragStart = (e) => { e.preventDefault(); };
            window.handleDragOver = (e) => { e.preventDefault(); };
            window.handleDrop = (e) => { e.preventDefault(); };
            window.handleDragEnd = (e) => { e.preventDefault(); };

            document.addEventListener('click', e => {
                const t = e.target.closest('[data-act]');
                if (!t) {
                    // KullanÄ±cÄ± menÃ¼sÃ¼nÃ¼, ikon ve menÃ¼ dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
                    const userMenu = document.getElementById('auth-user-menu');
                    if (userMenu && !e.target.closest('#auth-user-menu') && !e.target.closest('#auth-btn-login-toggle')) {
                        userMenu.classList.add('hidden');
                    }

                    if (state.view === 'form' && e.target.classList.contains('form-modal-overlay')) {
                        state.view = 'list';
                        state.err = '';
                        renderApp();
                        return;
                    }
                    // Rezervasyon formu kapatma
                    if (state.modals.resForm && e.target.classList.contains('form-modal-overlay')) {
                        state.modals.resForm = false;
                        state.err = '';
                        state.tab = 'other';
                        // TÃ¼m accordion'larÄ± kapat, sadece reservations'u aÃ§
                        state.helpersAccordion = {
                            critical: false,
                            places: false,
                            health: false,
                            transport: false,
                            flightCheck: false,
                            route: false,
                            report: false,
                            data: false,
                            reservations: true
                        };
                        renderApp();
                        setTimeout(() => {
                            const el = document.getElementById('helper-reservations');
                            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                        return;
                    }
                    return;
                }

                const act = t.dataset.act, val = t.dataset.val, id = t.dataset.id;

                // Login gerektiren iÅŸlemler iÃ§in kontrol
                const requiresAuth = t.dataset.auth === 'required';
                if (requiresAuth && !currentUser) {
                    openLoginModal('Bu Ã¶zelliÄŸi kullanmak iÃ§in giriÅŸ yapmanÄ±z gerekir.');
                    return;
                }

                // Auth ile ilgili aksiyonlar
                if (act === 'auth-open') {
                    if (currentUser) {
                        toggleUserMenu();
                    } else {
                        openLoginModal('GeliÅŸmiÅŸ Ã¶zellikler ve PDF dÃ¶kÃ¼mÃ¼ iÃ§in giriÅŸ yapmanÄ±z gerekir.');
                    }
                    return;
                }

                if (act === 'auth-close') {
                    closeLoginModal();
                    return;
                }
                if (act === 'auth-logout') {
                    if (auth) {
                        auth.signOut().catch(err => console.error('Ã‡Ä±kÄ±ÅŸ hatasÄ±', err));
                    }
                    currentUser = null;
                    updateAuthUi();
                    closeLoginModal();
                    toggleUserMenu(true);
                    return;
                }

                // YENÄ°: Generic Modal Kapatma Handler (Navigasyon DÃ¼zeltmesi ile)
                if (act === 'close-mod') {
                    if (val === 'resDetail' || val === 'resDetailOverlay' || val === 'resForm') {
                        state.modals.resDetail = false;
                        state.modals.resForm = false;
                        state.tab = 'other';
                        // TÃ¼m accordion'larÄ± kapat, sadece reservations'u aÃ§
                        state.helpersAccordion = {
                            critical: false,
                            places: false,
                            health: false,
                            transport: false,
                            flightCheck: false,
                            route: false,
                            report: false,
                            data: false,
                            reservations: true
                        };
                        renderApp();
                        setTimeout(() => {
                            const el = document.getElementById('helper-reservations');
                            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                        return;
                    }
                    // DiÄŸer modallar iÃ§in genel kapatma
                    if (val && state.modals[val] !== undefined) {
                        state.modals[val] = false;
                        renderApp();
                        return;
                    }
                    // Overlay kapatma (val ismi modal ismiyle uyuÅŸuyorsa veya Ã¶zel case varsa)
                    if (val === 'tripForm') { state.modals.tripForm = false; renderApp(); return; }
                }

                if (act === 'auth-google') {
                    if (!auth) {
                        initFirebaseAuth();
                    }
                    if (auth && firebase && firebase.auth) {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        // Her giriÅŸte hesap seÃ§me ekranÄ±nÄ± gÃ¶ster
                        provider.setCustomParameters({ prompt: 'select_account' });

                        auth.signInWithPopup(provider)
                            .then((result) => {
                                console.log('Google ile giriÅŸ baÅŸarÄ±lÄ±:', result && result.user);

                                if (result && result.user) {
                                    currentUser = result.user;
                                } else if (auth.currentUser) {
                                    currentUser = auth.currentUser;
                                }

                                updateAuthUi();
                                if (currentUser) {
                                    loadUserDataFromCloud();
                                }

                                // Login modali kapanÄ±r, kullanÄ±cÄ± menÃ¼sÃ¼ varsa gizlenir
                                closeLoginModal();
                                toggleUserMenu(true);
                            })
                            .catch(err => {
                                console.error('Google ile giriÅŸ hatasÄ±', err);
                                alert('Google ile giriÅŸ yapÄ±lamadÄ±: ' + (err && err.message ? err.message : err));
                            });
                    }
                    return;
                }
                if (act === 'auth-email-login' || act === 'auth-email-register') {
                    if (!auth) {
                        initFirebaseAuth();
                    }
                    const emailInput = document.getElementById('auth-email-input');
                    const passInput = document.getElementById('auth-password-input');
                    const email = emailInput ? emailInput.value.trim() : '';
                    const pass = passInput ? passInput.value.trim() : '';

                    if (!email || !pass) {
                        alert('LÃ¼tfen e-posta ve ÅŸifre girin.');
                        return;
                    }

                    const actionPromise = (act === 'auth-email-register')
                        ? auth.createUserWithEmailAndPassword(email, pass)
                        : auth.signInWithEmailAndPassword(email, pass);

                    actionPromise
                        .then(() => {
                            closeLoginModal();
                        })
                        .catch(err => {
                            console.error('E-posta ile giriÅŸ/kayÄ±t hatasÄ±', err);
                            alert('Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + (err && err.message ? err.message : err));
                        });
                    return;
                }


                if (act === 'get-location') {
                    handleGeolocation();
                    return;
                }

                if (act === 'tog-accordion') {
                    const currentStatus = state.helpersAccordion[val];
                    const newAccordionState = {};
                    Object.keys(state.helpersAccordion).forEach(key => {
                        newAccordionState[key] = false;
                    });

                    if (!currentStatus) {
                        newAccordionState[val] = true;
                        if (val === 'report') {
                            const allTrips = [...new Set(state.exp.map(x => x.trip).filter(Boolean).concat(state.res.map(x => x.trip).filter(Boolean)))].sort();
                            if (allTrips.length > 0 && !allTrips.includes(state.selectedReportTrip)) {
                                state.selectedReportTrip = allTrips[0];
                            } else if (allTrips.length === 0) {
                                state.selectedReportTrip = 'Genel';
                            }
                        }
                        if (['places', 'health'].includes(val) && !state.location) {
                            handleGeolocation();
                        }
                    }

                    setState({ helpersAccordion: newAccordionState });
                    return;
                }

                if (act === 'tab') {
                    if (val === 'sum' || val === 'exp' || val === 'chk' || val === 'other') {
                        state.tab = val;
                        state.search = '';
                        if (val === 'other') {
                            handleGeolocation();
                        }
                    }
                    renderApp();
                }
                if (act === 'new') {
                    state.form = getEmptyForm();
                    if (state.tripFilter) {
                        state.form.trip = state.tripFilter;
                        const suggestedCur = getCurrencyForTrip(state.tripFilter);
                        if (suggestedCur) {
                            state.form.cur = suggestedCur;
                        } else {
                            state.form.cur = state.baseCurrency || BASE_CURRENCY;
                        }
                    } else {
                        state.form.cur = state.baseCurrency || BASE_CURRENCY;
                    }
                    state.view = 'form';
                    state.form.isFuel = false;
                    renderApp();
                }

                if (act === 'open-quick-exp') {
                    state.quickExpOpen = !state.quickExpOpen;
                    if (state.quickExpOpen) {
                        const baseCur = state.baseCurrency || BASE_CURRENCY;
                        if (!state.quickExp) {
                            state.quickExp = { trip: '', cat: 'food', amt: '', cur: baseCur };
                        }
                        if (state.tripFilter) {
                            state.quickExp.trip = state.tripFilter;
                            const tcur = getCurrencyForTrip(state.tripFilter);
                            state.quickExp.cur = tcur || baseCur;
                        } else {
                            const tcur = getCurrencyForTrip(state.quickExp.trip || '');
                            state.quickExp.cur = tcur || baseCur;
                        }
                    }
                    state.err = '';
                    renderApp();
                    return;
                }
                if (act === 'quick-set-cat') {
                    state.quickExp = state.quickExp || { trip: '', cat: 'food', amt: '', cur: state.baseCurrency || BASE_CURRENCY };
                    state.quickExp.cat = val || 'food';
                    renderApp();
                    return;
                }
                if (act === 'save-quick-exp') {
                    const tripInput = document.getElementById('q-trip');
                    const amtInput = document.getElementById('q-amt');

                    const tripRaw = tripInput ? tripInput.value.trim() : '';
                    const trip = titleCase(tripRaw);
                    const amt = parseFloat(amtInput ? amtInput.value : '');
                    const cat = (state.quickExp && state.quickExp.cat) || 'other';

                    if (!trip || !amt || isNaN(amt) || amt <= 0) {
                        state.err = 'LÃ¼tfen seyahat ve tutar bilgilerini girin.';
                        renderApp();
                        return;
                    }

                    const cur = getCurrencyForTrip(trip) || state.baseCurrency || BASE_CURRENCY;

                    const now = new Date();
                    const dateStr = now.toISOString().split('T')[0];
                    const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                    const defaultPlaceMap = {
                        food: 'Cafe',
                        shopping: 'Market',
                        transport: 'UlaÅŸÄ±m',
                        other: 'DiÄŸer'
                    };

                    const newExp = {
                        id: genId(),
                        trip,
                        city: 'Genel',
                        place: defaultPlaceMap[cat] || 'HÄ±zlÄ± Harcama',
                        cat,
                        type: EXPENSE_TYPES[0].id,
                        isIndividual: false,
                        amt,
                        cur,
                        date: dateStr,
                        time: timeStr,
                        imgs: [],
                        isFuel: false,
                        startKm: '',
                        endKm: '',
                        fuelAmount: ''
                    };

                    state.exp.push(newExp);
                    state.quickExpOpen = false;
                    state.quickExp = { trip: '', cat, amt: '', cur };
                    save();
                    renderApp();
                    return;
                }
                if (act === 'cancel') {
                    state.view = 'list';
                    state.err = '';
                    renderApp();
                }

                if (act === 'cancel') {
                    state.view = 'list';
                    state.err = '';
                    renderApp();
                }

                if (act === 'new-res') {
                    state.resForm = getEmptyResForm();
                    if (state.tripFilter) state.resForm.trip = state.tripFilter;
                    state.modals.resForm = true;
                    // window.location.hash = '#'; // Helper menÃ¼yÃ¼ KAPATMA (Scroll pozisyonunu koru)
                    renderApp();
                }

                // YENÄ°: Seyahat YÃ¶netimi popup'Ä±ndan yeni seyahat ekleme
                if (act === 'new-trip') {
                    state.tripForm = getEmptyTripForm();
                    state.modals.tripForm = true;
                    // window.location.hash = '#'; // Helper menÃ¼yÃ¼ KAPATMA (Scroll pozisyonunu koru)
                    renderApp();
                }

                if (act === 'cancel-trip') {
                    state.modals.tripForm = false;
                    if (state.tripFilter) state.resForm.trip = state.tripFilter;
                    state.modals.resForm = true;
                    state.err = '';
                    renderApp();
                }

                if (act === 'save-trip') {
                    const name = (document.getElementById('i-trip-name').value || '').trim();
                    if (!name) { alert('Seyahat adÄ± zorunludur.'); return; }

                    const start = document.getElementById('i-trip-start').value;
                    const end = document.getElementById('i-trip-end').value;
                    const persons = document.getElementById('i-trip-persons').value;

                    // DUPLICATE CHECK
                    const isDuplicate = state.trips.some(t =>
                        t.name.toLowerCase() === name.toLowerCase() && t.id !== state.tripForm.id
                    );

                    if (isDuplicate) {
                        alert('Bu isimde baÅŸka bir seyahat zaten var. LÃ¼tfen farklÄ± bir isim seÃ§in.');
                        return;
                    }

                    if (state.tripForm.id) {
                        // EDIT
                        const tripId = state.tripForm.id;
                        const oldName = state.tripForm.name;

                        state.trips = state.trips.map(t => {
                            if (t.id === tripId) {
                                return { ...t, name: titleCase(name), startDate: start, endDate: end, persons: persons };
                            }
                            return t;
                        });

                        const newName = titleCase(name);
                        if (oldName !== newName) {
                            if (confirm(`Seyahat adÄ± "${oldName}" -> "${newName}" olarak deÄŸiÅŸtirildi. Ä°liÅŸkili tÃ¼m harcama ve rezervasyon kayÄ±tlarÄ± da gÃ¼ncellensin mi?`)) {
                                state.exp = state.exp.map(x => x.trip === oldName ? { ...x, trip: newName } : x);
                                state.res = state.res.map(r => r.trip === oldName ? { ...r, trip: newName } : r);
                                state.criticalNotes = state.criticalNotes.map(n => n.trip === oldName ? { ...n, trip: newName } : n);
                            }
                        }

                    } else {
                        // NEW
                        const newTrip = {
                            id: genId(),
                            name: titleCase(name),
                            startDate: start,
                            endDate: end,
                            persons: persons
                        };
                        state.trips.push(newTrip);
                        if (state.view === 'form') {
                            state.form.trip = newTrip.name;
                        }
                    }

                    state.modals.tripForm = false;
                    save();
                    renderApp();
                }

                if (act === 'del-trip') {
                    e.preventDefault();
                    e.stopPropagation();

                    try {
                        // FIX: Type mismatch prevention (String vs Number)
                        const tripIdToDelete = String(id);
                        const tripToDelete = state.trips.find(t => String(t.id) === tripIdToDelete);

                        if (!tripToDelete) {
                            console.warn('Silinecek seyahat bulunamadÄ±:', tripIdToDelete);
                            return;
                        }

                        const tripName = tripToDelete.name;

                        // Ä°liÅŸkili kayÄ±tlarÄ± say
                        const relatedExpCount = state.exp.filter(x => x.trip === tripName).length;
                        const relatedResCount = state.res.filter(r => r.trip === tripName).length;
                        const relatedNotesCount = state.criticalNotes.filter(n => n.trip === tripName).length;

                        let warningMsg = `"${tripName}" seyahatini silmek istediÄŸinize emin misiniz?\n\n`;
                        if (relatedExpCount > 0 || relatedResCount > 0 || relatedNotesCount > 0) {
                            warningMsg += `âš ï¸ DÄ°KKAT: Bu iÅŸlem ile birlikte aÅŸaÄŸÄ±daki kayÄ±tlar da SÄ°LÄ°NECEK:\n`;
                            if (relatedExpCount > 0) warningMsg += `â€¢ ${relatedExpCount} harcama kaydÄ±\n`;
                            if (relatedResCount > 0) warningMsg += `â€¢ ${relatedResCount} rezervasyon\n`;
                            if (relatedNotesCount > 0) warningMsg += `â€¢ ${relatedNotesCount} not\n`;
                            warningMsg += `\nBu iÅŸlem geri alÄ±namaz!`;
                        }

                        if (confirm(warningMsg)) {
                            state.trips = state.trips.filter(t => String(t.id) !== tripIdToDelete);
                            state.exp = state.exp.filter(x => x.trip !== tripName);
                            state.res = state.res.filter(r => r.trip !== tripName);
                            state.criticalNotes = state.criticalNotes.filter(n => n.trip !== tripName);

                            state.modals.tripForm = false;
                            save();
                            renderApp();
                            setTimeout(() => { window.location.hash = 'helper-trips'; }, 50);
                        }
                    } catch (err) {
                        console.error('Seyahat silme hatasÄ±:', err);
                        alert('Seyahat silinirken bir hata oluÅŸtu.');
                    }
                    return;
                }
                if (act === 'cancel-res') {
                    state.modals.resForm = false;
                    state.err = '';
                    state.tab = 'other';
                    // TÃ¼m accordion'larÄ± kapat, sadece reservations'u aÃ§
                    state.helpersAccordion = {
                        critical: false,
                        places: false,
                        health: false,
                        transport: false,
                        flightCheck: false,
                        route: false,
                        report: false,
                        data: false,
                        reservations: true
                    };
                    renderApp();
                    setTimeout(() => {
                        const el = document.getElementById('helper-reservations');
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }

                // Not Ä°ÅŸlemleri
                if (act === 'add-note') {
                    const noteInput = document.getElementById('new-note-input-other') || document.getElementById('new-note-input');
                    const noteText = noteInput ? noteInput.value.trim() : state.newCriticalNote.trim();

                    if (noteText) {
                        state.criticalNotes.push({
                            id: genId(),
                            trip: state.selectedNoteTrip,
                            note: noteText,
                        });
                        state.newCriticalNote = '';
                        if (noteInput) noteInput.value = '';
                        save();
                        renderApp();
                    }
                }
                if (act === 'del-note') {
                    e.stopPropagation(); // GÃ¼venlik: TÄ±klama yayÄ±lÄ±mÄ±nÄ± durdur
                    e.preventDefault(); // VarsayÄ±lan davranÄ±ÅŸÄ± engelle
                    state.criticalNotes = state.criticalNotes.filter(n => n.id !== id);
                    save();
                    renderApp();
                }

                if (act === 'clean-all-exp') {
                    e.preventDefault();
                    e.stopPropagation(); // Event yayÄ±lÄ±mÄ±nÄ± durdur (Gereksiz tÄ±klamalarÄ± engeller)
                    if (confirm('DÄ°KKAT! TÃœM harcama kayÄ±tlarÄ± (TÃ¼m seyahatler, tÃ¼m ÅŸehirler) kalÄ±cÄ± olarak silinecektir. Emin misiniz?')) {
                        state.exp = [];
                        save();
                        renderApp();
                    }
                    return; // Ä°ÅŸlem tamamlandÄ±
                }

                // SEYAHAT YÃ–NETÄ°MÄ° AKSÄ°YONLARI
                if (act === 'open-trip-mgmt') {
                    window.location.hash = 'helper-trips';
                    return;
                }

                if (act === 'edit-trip-detail') {
                    const tripToEdit = state.trips.find(t => t.id === id);
                    if (tripToEdit) {
                        state.tripForm = { ...tripToEdit }; // Formu doldur
                        state.modals.tripForm = true;
                        // Modal hash'ini temizle ki overlay dÃ¼zgÃ¼n gÃ¶rÃ¼nsÃ¼n (opsiyonel)
                        window.location.hash = '';
                        renderApp();
                    }
                }

                // KRÄ°TÄ°K: DETAY MODALINDAN TEK HARCAMAYI SÄ°LME
                if (act === 'del-exp-detail') {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        if (state.selExp && confirm('Bu harcama kaydÄ± kalÄ±cÄ± olarak silinsin mi?')) {
                            const idToDelete = String(state.selExp);
                            state.exp = state.exp.filter(x => String(x.id) !== idToDelete);
                            state.modals.detail = false;
                            save();
                            renderApp();
                        }
                    } catch (err) {
                        console.error('Harcama silme hatasÄ±:', err);
                    }
                    return;
                }

                // KRÄ°TÄ°K: ÅžEHÄ°R BAÅžLIÄžINDAN TÃœM ÅžEHÄ°R HARCAMALARINI SÄ°LME
                if (act === 'del-city') {
                    e.stopPropagation();
                    e.preventDefault();
                    const cityToDelete = val;
                    if (confirm(`"${cityToDelete}" ÅŸehrine ait TÃœM harcama kayÄ±tlarÄ± kalÄ±cÄ± olarak silinecek. Emin misiniz?`)) {
                        state.exp = state.exp.filter(x => x.city !== cityToDelete);
                        delete state.expandedCities[cityToDelete];
                        save();
                        renderApp();
                    }
                    return; // Ä°ÅŸlem tamamlandÄ±
                }

                // Checklist Ä°ÅŸlemleri
                if (act === 'reset-chk') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (confirm('Mevcut liste SÄ°LÄ°NECEK ve varsayÄ±lan listeye dÃ¶nÃ¼lecek. OnaylÄ±yor musun?')) {
                        state.chk.items = DEF_ITEMS.map(i => ({ id: genId(), cat: i.cat, val: i.val, done: false, date: i.date || '' }));
                        state.chk.cats = [...DEF_CATS];
                        state.openChkCats = {}; state.chk.cats.forEach(x => state.openChkCats[x.id] = false);
                        save(); renderApp();
                    }
                    return;
                }

                // KRÄ°TÄ°K: CHECK LIST MADDE SÄ°LME
                if (act === 'del-chk') {
                    e.stopPropagation();
                    e.preventDefault();
                    try {
                        if (id && confirm('Bu maddeyi listeden kaldÄ±rmak istediÄŸinize emin misiniz?')) {
                            const idStr = String(id);
                            state.chk.items = state.chk.items.filter(x => String(x.id) !== idStr);
                            save(); renderApp();
                        }
                    } catch (err) { console.error(err); }
                    return;
                }

                if (act === 'add-chk-single') {
                    const catId = t.dataset.catId;
                    const itemInput = document.getElementById(`new-chk-item-${catId}`);
                    const dateInput = document.getElementById(`new-chk-date-${catId}`); // Tarih inputunu yakala

                    const rawItems = itemInput ? itemInput.value : '';
                    const itemDate = dateInput ? dateInput.value : ''; // Tarihi al

                    if (rawItems && catId) {
                        rawItems.split(',').forEach(part => {
                            const clean = part.trim();
                            if (clean) state.chk.items.push({ id: genId(), cat: catId, val: clean, done: false, date: itemDate }); // Tarihi kaydet
                        });
                        if (itemInput) itemInput.value = '';
                        if (dateInput) dateInput.value = ''; // Tarih alanÄ±nÄ± temizle
                        save(); renderApp();
                    } else {
                        state.err = 'LÃ¼tfen bir madde adÄ± girin.';
                        renderApp();
                    }
                }

                if (act === 'tog-chk-cat') {
                    // del-chk-cat-confirm butonuna basÄ±ldÄ±ÄŸÄ±nda toggle'Ä± engelle
                    if (e.target.closest('[data-act="del-chk-cat-confirm"]')) return;
                    state.openChkCats[val] = !state.openChkCats[val];
                    renderApp();
                }

                if (act === 'add-cat') {
                    const nameInput = document.getElementById('new-cat-name');
                    const iconInput = document.getElementById('new-cat-icon');
                    const name = nameInput.value.trim();
                    const icon = iconInput.value.trim() || 'ðŸ“¦';
                    if (name) {
                        const newId = 'c' + genId().slice(0, 8);
                        const newCat = { id: newId, l: name, i: icon };
                        state.chk.cats.push(newCat);
                        state.openChkCats[newId] = true;
                        nameInput.value = '';
                        iconInput.value = '';
                        save(); renderApp();
                    } else {
                        state.err = 'LÃ¼tfen bir kategori adÄ± girin.';
                        renderApp();
                    }
                }

                if (act === 'del-chk-cat-confirm') {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        if (id && confirm('Bu kategori ve Ä°Ã‡Ä°NDEKÄ° TÃœM MADDELER silinecek. OnaylÄ±yor musun?')) {
                            const catId = String(id);
                            state.chk.cats = state.chk.cats.filter(c => String(c.id) !== catId);
                            state.chk.items = state.chk.items.filter(i => String(i.cat) !== catId);
                            delete state.openChkCats[catId];
                            save();
                            renderApp();
                        }
                    } catch (err) { console.error(err); }
                    return;
                }

                // Harcama Formu Ä°ÅŸlemleri
                if (act === 'set-cat') {
                    state.form.cat = val;
                    const isFuelSelected = (val === 'fuel');
                    state.form.isFuel = isFuelSelected;

                    if (isFuelSelected) {
                        if (!state.form.place) state.form.place = 'AkaryakÄ±t Ä°stasyonu';
                    } else {
                        state.form.startKm = '';
                        state.form.endKm = '';
                        state.form.fuelAmount = '';
                    }
                    renderApp();
                }

                if (act === 'del-img') {
                    e.stopPropagation(); // GÃ¼venlik: TÄ±klama yayÄ±lÄ±mÄ±nÄ± durdur
                    e.preventDefault(); // KRÄ°TÄ°K DÃœZELTME: VarsayÄ±lan davranÄ±ÅŸÄ± engelle
                    state.form.imgs.splice(val, 1);
                    renderApp();
                }

                if (act === 'save') {
                    const f = state.form;

                    const isIndividualInput = document.getElementById('i-isIndividual');
                    f.isIndividual = isIndividualInput ? isIndividualInput.checked : false;

                    // Payer bilgisini al
                    const payerInput = document.getElementById('i-payer');
                    f.payer = (payerInput && !f.isIndividual) ? payerInput.value : '';

                    // Ortak kalemlerde "HarcamayÄ± Yapan" zorunlu
                    if (!f.isIndividual) {
                        if (!payerInput) {
                            state.err = 'Ortak harcamalarda "HarcamayÄ± Yapan" seÃ§ebilmek iÃ§in Ã¶nce ilgili seyahatte kiÅŸi tanÄ±mlayÄ±n.';
                            renderApp();
                            return;
                        }
                        if (!payerInput.value) {
                            state.err = 'Ortak harcamalarda "HarcamayÄ± Yapan" seÃ§imi zorunludur.';
                            renderApp();
                            return;
                        }
                    }

                    const isFuelActive = f.cat === 'fuel';
                    f.isFuel = isFuelActive;

                    if (!f.city || !f.place || !f.amt || !f.cat) {
                        state.err = 'Zorunlu alanlarÄ± doldurunuz (Åžehir, Mekan, Tutar, Kategori).';
                        renderApp();
                        return;
                    }

                    if (isFuelActive && (!f.startKm || !f.endKm || !f.fuelAmount)) {
                        state.err = 'YakÄ±t harcamasÄ± iÃ§in BaÅŸlangÄ±Ã§ Km, BitiÅŸ Km ve YakÄ±t MiktarÄ± alanlarÄ± zorunludur.';
                        renderApp();
                        return;
                    }


                    // Misafir kullanÄ±cÄ± iÃ§in seyahat ve harcama limitleri
                    if (isGuest()) {
                        const newTripName = titleCase(f.trip || '');
                        const isNewRecord = !f.id;

                        // 1) En fazla 2 seyahat
                        if (isNewRecord && guestTripLimitExceeded(newTripName)) {
                            state.err = 'GiriÅŸ yapmadan en fazla 2 seyahat ekleyebilirsiniz. LÃ¼tfen giriÅŸ yapÄ±n veya mevcut seyahatlerden birini kullanÄ±n.';
                            openLoginModal('En fazla 2 seyahat eklemek iÃ§in giriÅŸ yapmanÄ±z gerekir.');
                            renderApp();
                            return;
                        }

                        // 2) Bir seyahat iÃ§in en fazla 3 harcama
                        if (isNewRecord && newTripName && guestExpenseLimitExceeded(newTripName)) {
                            state.err = 'GiriÅŸ yapmadan bir seyahat iÃ§in en fazla 3 harcama ekleyebilirsiniz. LÃ¼tfen giriÅŸ yapÄ±n.';
                            openLoginModal('Bir seyahat iÃ§in 3\'ten fazla harcama eklemek iÃ§in giriÅŸ yapmanÄ±z gerekir.');
                            renderApp();
                            return;
                        }
                    }

                    const rec = { ...f, id: f.id || genId(), city: titleCase(f.city), place: titleCase(f.place), trip: titleCase(f.trip) };

                    if (isFuelActive) {
                        rec.startKm = String(rec.startKm).replace(/[^0-9]/g, '');
                        rec.endKm = String(rec.endKm).replace(/[^0-9]/g, '');
                        rec.fuelAmount = String(rec.fuelAmount).replace(/[^0-9.]/g, '');

                        if (Number(rec.endKm) < Number(rec.startKm)) {
                            state.err = 'BitiÅŸ Kilometresi, BaÅŸlangÄ±Ã§ Kilometresinden kÃ¼Ã§Ã¼k olamaz.';
                            renderApp();
                            return;
                        }
                    } else {
                        rec.startKm = '';
                        rec.endKm = '';
                        rec.fuelAmount = '';
                    }

                    rec.place = titleCase(f.place);

                    if (f.id) state.exp = state.exp.map(x => x.id === f.id ? rec : x); else state.exp = [...state.exp, rec];

                    state.expandedCities[rec.city] = true;
                    save();
                    state.err = '';
                    state.view = 'list';
                    renderApp();
                }

                // Rezervasyon Formu Ä°ÅŸlemleri
                if (act === 'set-res-type') {
                    state.resForm.type = val;
                    renderApp();
                }
                if (act === 'set-res-ind') {
                    state.resForm.isIndividual = (val === 'individual');
                    renderApp();
                }
                if (act === 'save-res') {
                    const f = state.resForm;

                    // KRÄ°TÄ°K DÃœZELTME: Kaydetmeden Ã¶nce tÃ¼m form deÄŸerlerini DOM'dan Ã§ek.
                    // Bu, input eventlerinin tetiklenmeme (Ã¶rn: select) veya gecikme sorunlarÄ±nÄ± Ã§Ã¶zer.
                    // DeÄŸerleri doÄŸrudan formdan alÄ±yoruz.
                    f.name = document.getElementById('i-res-name').value;
                    f.trip = document.getElementById('i-res-trip').value;
                    f.location = document.getElementById('i-res-location').value;
                    f.startDate = document.getElementById('i-res-start-date').value;
                    f.endDate = document.getElementById('i-res-end-date').value;
                    if (!f.endDate) { f.endDate = f.startDate; }
                    f.code = document.getElementById('i-res-code').value;
                    f.cost = document.getElementById('i-res-cost').value;
                    f.cur = document.getElementById('i-res-cur').value;
                    f.notes = document.getElementById('i-res-notes').value;

                    // Payer ve Settled bilgisini al
                    const payerInput = document.getElementById('i-res-payer');
                    f.payer = (payerInput && !f.isIndividual) ? payerInput.value : '';

                    // Ortak rezervasyonlarda "Ã–deyen" zorunlu
                    if (!f.isIndividual) {
                        if (!payerInput) {
                            state.err = 'Ortak rezervasyonlarda "Ã–deyen" seÃ§ebilmek iÃ§in Ã¶nce ilgili seyahatte kiÅŸi tanÄ±mlayÄ±n.';
                            renderApp();
                            return;
                        }
                        if (!payerInput.value) {
                            state.err = 'Ortak rezervasyonlarda "Ã–deyen" seÃ§imi zorunludur.';
                            renderApp();
                            return;
                        }
                    }

                    const settledInput = document.getElementById('i-res-settled');
                    f.isSettled = settledInput ? settledInput.checked : false;

                    // Takvime ekle seÃ§eneÄŸini al
                    const calendarInput = document.getElementById('i-res-calendar');
                    f.addToCalendar = calendarInput ? calendarInput.checked : false;



                    // Maliyet alanÄ±nÄ± temizle ve state'e kaydet (input eventinde bu iÅŸlem yapÄ±lmadÄ±ÄŸÄ± iÃ§in)
                    f.cost = f.cost.replace(',', '.').replace(/[^0-9.]/g, '');

                    if (!f.name || !f.location || !f.startDate || !f.trip) {
                        state.err = 'Rezervasyon AdÄ±, Konum, Tarih ve Seyahat alanlarÄ± zorunludur.';
                        renderApp();
                        return;
                    }

                    // Misafir kullanÄ±cÄ± iÃ§in seyahat sayÄ±sÄ± limiti (rezervasyon tarafÄ±)
                    if (isGuest()) {
                        const newTripName = titleCase(f.trip || '');
                        const isNewRecord = !f.id;
                        if (isNewRecord && guestTripLimitExceeded(newTripName)) {
                            state.err = 'GiriÅŸ yapmadan en fazla 2 seyahat ekleyebilirsiniz. LÃ¼tfen giriÅŸ yapÄ±n veya mevcut seyahatlerden birini kullanÄ±n.';
                            openLoginModal('En fazla 2 seyahat eklemek iÃ§in giriÅŸ yapmanÄ±z gerekir.');
                            renderApp();
                            return;
                        }
                    }

                    const rec = {
                        ...f,
                        id: f.id || genId(),
                        trip: titleCase(f.trip),
                        name: titleCase(f.name),
                        location: titleCase(f.location),
                        cost: f.cost, // TemizlenmiÅŸ hali zaten f.cost'a yazÄ±ldÄ±
                    };

                    if (f.id) state.res = state.res.map(x => x.id === f.id ? rec : x); else state.res = [...state.res, rec];


                    save();

                    // EÄŸer seÃ§enek iÅŸaretliyse Google Takvim'i aÃ§ (Pop-up blocker'a takÄ±lmamasÄ± iÃ§in kullanÄ±cÄ± etkileÅŸimi zincirinde olmalÄ±)
                    if (f.addToCalendar) {
                        try {
                            const calendarUrl = getGoogleCalendarUrl(rec);
                            window.open(calendarUrl, '_blank');
                        } catch (e) {
                            console.error('Takvim aÃ§Ä±lÄ±rken hata:', e);
                        }
                    }



                    state.err = '';
                    state.modals.resForm = false;
                    state.tab = 'other';
                    // TÃ¼m accordion'larÄ± kapat, sadece reservations'u aÃ§
                    state.helpersAccordion = {
                        critical: false,
                        places: false,
                        health: false,
                        transport: false,
                        flightCheck: false,
                        route: false,
                        report: false,
                        data: false,
                        reservations: true
                    };
                    renderApp();
                    // KRÄ°TÄ°K DÃœZELTME: SayfanÄ±n rezervasyonlara dÃ¶nmesini zorla (Hash gÃ¼ncellemesi)
                    setTimeout(() => {
                        window.location.hash = 'helper-reservations';
                        const el = document.getElementById('helper-reservations');
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }

                // Rezervasyon Listesi Ä°ÅŸlemleri
                if (act === 'res-detail') { state.selRes = id; state.modals.resDetail = true; renderApp(); }
                if (act === 'del-res-detail') {
                    e.stopPropagation();
                    e.preventDefault();
                    try {
                        if (state.selRes && confirm('Bu rezervasyon kalÄ±cÄ± olarak silinsin mi?')) {
                            const idToDelete = String(state.selRes);
                            state.res = state.res.filter(x => String(x.id) !== idToDelete);
                            save();
                            state.modals.resDetail = false;
                            state.tab = 'other';
                            // TÃ¼m accordion'larÄ± kapat, sadece reservations'u aÃ§
                            state.helpersAccordion = {
                                critical: false,
                                places: false,
                                health: false,
                                transport: false,
                                flightCheck: false,
                                route: false,
                                report: false,
                                data: false,
                                reservations: true
                            };
                            renderApp();
                            setTimeout(() => {
                                const el = document.getElementById('helper-reservations');
                                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 300);
                        }
                    } catch (err) { console.error(err); }
                    return;
                }
                if (act === 'edit-res') {
                    const r = state.res.find(res => res.id === state.selRes);
                    if (r) {
                        state.resForm = { ...r };
                        state.modals.resDetail = false;
                        state.modals.resForm = true;
                        renderApp();
                    }
                }
                if (act === 'toggle-res-complete') {
                    state.res = state.res.map(r => r.id === state.selRes ? { ...r, completed: !r.completed } : r);
                    save();
                    renderApp(); // Detay modalini gÃ¼ncelle
                }

                // Liste
                if (act === 'tog-city') {
                    // KRÄ°TÄ°K KONTROL: EÄŸer tÄ±klanan element del-city butonu veya iÃ§indeki bir element ise, toggle iÅŸlemini yapma.
                    if (e.target.closest('[data-act="del-city"]')) return;
                    state.expandedCities[val] = !state.expandedCities[val]; renderApp();
                }
                if (act === 'detail') {
                    // Detay modali aÃ§
                    state.selExp = id;
                    state.modals.detail = true;
                    renderApp();
                    return;
                }
                if (act === 'edit') {
                    // Harcama dÃ¼zenleme: seÃ§ili harcamayÄ± forma taÅŸÄ± ve form gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ aÃ§
                    const x = state.exp.find(e => e.id === state.selExp);
                    if (!x) {
                        return;
                    }
                    state.form = { ...x };
                    state.view = 'form';
                    state.modals.detail = false;
                    state.err = '';
                    renderApp();
                    return;
                }


                // Modal YÃ¶netimi
                if (act === 'close-mod') {
                    if (val === 'tzSelect') state.modals.tzSelect = false;
                    else if (val === 'chart') { state.modals.chart = false; setTimeout(renderApp, 100); }
                    else if (val === 'resDetail') { state.modals.resDetail = false; }
                    else state.modals = { detail: false, chart: false, data: false };
                    renderApp();
                }

                // DiÄŸer Aksiyonlar
                if (act === 'open-tz-modal') {
                    state.modals.tzSelect = true;
                    renderApp();
                }
                if (act === 'select-tz') {
                    state.targetTimezone = val;
                    state.modals.tzSelect = false;
                    save();
                    if (timeInterval) clearInterval(timeInterval);
                    startClock();
                    renderApp();
                }

                if (act === 'open-map') {
                    window.open(val, '_blank');
                    return;
                }

                if (act === 'move-trip') {
                    const x = state.exp.find(e => e.id === state.selExp);
                    if (x && !x.isFuel) {
                        const sel = document.getElementById('move-trip-select');
                        const inp = document.getElementById('move-trip-inp');

                        let newT = '';
                        if (sel && sel.value && sel.value !== '__new__') {
                            newT = sel.value.trim();
                        } else if (inp) {
                            newT = titleCase(inp.value.trim());
                        }

                        if (newT && state.selExp) {
                            state.exp = state.exp.map(x => x.id === state.selExp ? { ...x, trip: newT } : x);
                            save();
                            state.modals.detail = false;
                            renderApp();
                        } else {
                            state.err = 'LÃ¼tfen bir seyahat seÃ§in veya yeni bir seyahat adÄ± yazÄ±n.';
                            renderApp();
                        }
                    }
                }

                if (act === 'lb') { state.lightbox = e.target.src; renderApp(); }
                if (act === 'close-lb') { state.lightbox = null; renderApp(); }
                if (act === 'open-chart') { state.modals.chart = true; renderApp(); }

                if (act === 'imp') {
                    try {
                        const dataStr = document.getElementById('io-txt').value;
                        const d = JSON.parse(dataStr);
                        state.exp = d.exp || [];
                        state.chk = d.chk || state.chk;
                        state.criticalNotes = d.notes || [];
                        state.res = d.res || []; // RezervasyonlarÄ± yÃ¼kle
                        state.baseCurrency = d.baseCur || 'TRY';
                        BASE_CURRENCY = state.baseCurrency;
                        save();
                        alert('Veriler BaÅŸarÄ±yla YÃ¼klendi!');
                        state.helpersAccordion.data = false;
                        renderApp();
                    } catch {
                        state.err = 'JSON HatalÄ±. LÃ¼tfen geÃ§erli bir JSON formatÄ± girin.';
                        renderApp();
                    }
                }
                if (act === 'export-pdf') {
                    e.preventDefault();
                    e.stopPropagation();

                    // 1) SeÃ§ili seyahat ve rapor para birimini al
                    const selectedTrip = state.selectedReportTrip;
                    if (!selectedTrip) {
                        alert('Ã–nce rapor ekranÄ±nda bir seyahat seÃ§melisiniz.');
                        return;
                    }

                    const reportCur = state.reportCurrency || state.baseCurrency || BASE_CURRENCY;
                    const scope = state.indFilter || 'all';

                    // 2) Bu seyahate ait harcamalarÄ± al (mevcut helper)
                    const allExpenses = getTripExpenses(selectedTrip) || [];

                    // Bireysel / Ortak filtresini uygula
                    const filteredExpenses = allExpenses.filter(x => {
                        if (scope === 'individual' && x.isIndividual !== true) return false;
                        if (scope === 'shared' && x.isIndividual !== false) return false;
                        return true;
                    });

                    // 3) Bu seyahate ait rezervasyonlarÄ± al
                    const allReservations = (state.res || []).filter(r => {
                        if (!r.trip || r.trip !== selectedTrip) return false;
                        if (isNaN(Number(r.cost)) || Number(r.cost) <= 0) return false;
                        return true;
                    });

                    const filteredReservations = allReservations.filter(r => {
                        if (scope === 'individual' && r.isIndividual !== true) return false;
                        if (scope === 'shared' && r.isIndividual !== false) return false;
                        return true;
                    });

                    // 4) Tarih aralÄ±ÄŸÄ± Ã§Ä±kar (min/max tarih)
                    const allDates = [];
                    filteredExpenses.forEach(x => { if (x.date) allDates.push(x.date); });
                    filteredReservations.forEach(r => {
                        if (r.startDate) allDates.push(r.startDate);
                        if (r.endDate) allDates.push(r.endDate);
                    });
                    allDates.sort();
                    const dateFrom = allDates[0] || '';
                    const dateTo = allDates[allDates.length - 1] || '';

                    // 5) Ã–zet tutarlarÄ± rapor para biriminde hesapla
                    let totalExpReport = 0;
                    filteredExpenses.forEach(x => {
                        const amt = Number(x.amt) || 0;
                        const cur = x.cur || reportCur;
                        totalExpReport += convertToBase(amt, cur, reportCur);
                    });

                    let totalResReport = 0;
                    filteredReservations.forEach(r => {
                        const amt = Number(r.cost) || 0;
                        const cur = r.cur || reportCur;
                        totalResReport += convertToBase(amt, cur, reportCur);
                    });

                    const totalReport = totalExpReport + totalResReport;

                    // GÃ¼n sayÄ±sÄ± (ortalama iÃ§in)
                    let dayCount = 0;
                    if (dateFrom && dateTo) {
                        const d1 = new Date(dateFrom);
                        const d2 = new Date(dateTo);
                        const diff = Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
                        if (diff > 0) dayCount = diff;
                    }
                    const dailyAvg = dayCount > 0 ? totalReport / dayCount : 0;

                    // Bireysel/ortak alt Ã¶zet
                    let indivTotal = 0;
                    let sharedTotal = 0;

                    filteredExpenses.forEach(x => {
                        const amt = convertToBase(Number(x.amt) || 0, x.cur || reportCur, reportCur);
                        if (x.isIndividual) indivTotal += amt; else sharedTotal += amt;
                    });
                    filteredReservations.forEach(r => {
                        // EÄŸer Ã¶denmiÅŸ/settled ise rapora dahil et ama shared toplamÄ±na katma (veya not olarak dÃ¼ÅŸ)
                        // KullanÄ±cÄ± isteÄŸi: "Ã–dendi... genel hesaba eklensin fakat alacak-verecek hesabÄ±na dahil olmasÄ±n."
                        // Burada "sharedTotal" ve "indivTotal" raporun alt Ã¶zeti.
                        // Settled olsa bile harcama yapÄ±lmÄ±ÅŸtÄ±r. Shared total'e eklenebilir.
                        const amt = convertToBase(Number(r.cost) || 0, r.cur || reportCur, reportCur);
                        if (r.isIndividual) indivTotal += amt; else sharedTotal += amt;
                    });

                    // GÃ¼n SayÄ±sÄ± HesabÄ± (Seyahat Tarihlerine GÃ¶re)
                    let finalDayCount = dayCount; // Harcamalardan gelen count fallback
                    const tripObj = state.trips.find(t => t.name === selectedTrip);
                    if (tripObj && tripObj.startDate && tripObj.endDate) {
                        const d1 = new Date(tripObj.startDate);
                        const d2 = new Date(tripObj.endDate);
                        const diff = Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
                        if (diff > 0) finalDayCount = diff;
                    }
                    const finalDailyAvg = finalDayCount > 0 ? totalReport / finalDayCount : 0;

                    // 6) Payload hazÄ±rla
const tripMeta = {
    startDate: (tripObj && tripObj.startDate) ? tripObj.startDate : '',
    endDate: (tripObj && tripObj.endDate) ? tripObj.endDate : '',
    persons: (tripObj && tripObj.persons) ? tripObj.persons : ''
};

const payload = {
    trip: selectedTrip,
    reportCurrency: reportCur,
    scope, // 'all' | 'individual' | 'shared'
    baseCurrency: state.baseCurrency || BASE_CURRENCY,
    generatedAt: new Date().toISOString(),
    dateFrom,
    dateTo,
    tripMeta,
    ratesInfo: {
        updatedAt: (typeof rateLastUpdated !== 'undefined') ? rateLastUpdated : '',
        rates: (typeof EXCHANGE_RATES !== 'undefined') ? EXCHANGE_RATES : {}
    },
    debts: (scope === 'individual') ? null : calculateDebts(selectedTrip, reportCur),
    summary: {
        totalReport,
        totalExpReport,
        totalResReport,
        dayCount: finalDayCount,
        dailyAvg: finalDailyAvg,
        indivTotal,
        sharedTotal,
        expenseCount: filteredExpenses.length,
        reservationCount: filteredReservations.length
    },
    expenses: filteredExpenses.map(x => ({
        id: x.id,
        date: x.date,
        time: x.time || '',
        city: x.city || '',
        country: x.country || '',
        cat: x.cat,
        place: x.place || '',
        note: x.note || '',
        amt: Number(x.amt) || 0,
        cur: x.cur || BASE_CURRENCY,
        amtReport: convertToBase(Number(x.amt) || 0, x.cur || BASE_CURRENCY, reportCur),
        isIndividual: !!x.isIndividual,
        payer: x.payer || ''
    })),
    reservations: filteredReservations.map(r => ({
        id: r.id,
        trip: r.trip,
        type: r.type,
        name: r.name || '',
        location: r.location || '',
        startDate: r.startDate || '',
        endDate: r.endDate || '',
        code: r.code || '',
        cost: Number(r.cost) || 0,
        cur: r.cur || BASE_CURRENCY,
        costReport: convertToBase(Number(r.cost) || 0, r.cur || BASE_CURRENCY, reportCur),
        completed: !!r.completed,
        isIndividual: !!r.isIndividual,
        notes: r.notes || '',
        payer: r.payer || '',
        isSettled: !!r.isSettled
    })),
};


                    // 7) HTML raporu oluÅŸtur ve yeni sekmede aÃ§
                    const html = buildReportHtml(payload);
                    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                }

                if (act === 'copy-json') {
                    const textarea = document.getElementById('io-txt');
                    textarea.select();
                    document.execCommand('copy');
                    const originalText = textarea.value;
                    textarea.value = "JSON kopyalandÄ±!";
                    setTimeout(() => textarea.value = originalText, 1000);
                }
            });

            document.addEventListener('change', e => {
                const t = e.target;

                if (t.dataset.act === 'set-base-currency') {
                    state.baseCurrency = t.value;
                    BASE_CURRENCY = t.value;
                    save();
                    renderApp();
                }

                if (t.dataset.act === 'chk') {
                    const i = state.chk.items.find(x => x.id === t.dataset.id);
                    if (i) { i.done = t.checked; save(); renderApp(); }
                }
                if (t.dataset.act === 'flt-trip') {
                    state.tripFilter = t.value;
                    // Seyahat deÄŸiÅŸince grafik para birimini sÄ±fÄ±rla;
                    // bir sonrakinde getChartDataset seÃ§ili seyahatin para birimine gÃ¶re belirlesin
                    state.chartCurrency = '';
                    renderApp();
                }

                if (t.dataset.act === 'flt-cat') { state.catFilter = t.value; renderApp(); }
                if (t.dataset.act === 'flt-type') { state.typeFilter = t.value; renderApp(); }
                if (t.dataset.act === 'flt-ind') { state.indFilter = t.value; renderApp(); }

                if (t.dataset.act === 'set-chart-currency') {
                    state.chartCurrency = t.value;
                    renderApp();
                }

                if (t.id === 'route-trip-select') {
                    state.routeTrip = t.value;
                    state.helpersAccordion.route = true;
                    renderApp();
                    // KRÄ°TÄ°K DÃœZELTME: Rota seÃ§iminde sayfanÄ±n kapanmasÄ±nÄ± engelle
                    setTimeout(() => { window.location.hash = 'helper-route'; }, 10);
                }

                if (t.dataset.act === 'set-note-trip') {
                    state.selectedNoteTrip = t.value;
                    state.newCriticalNote = '';
                    renderApp();
                }

                if (t.dataset.act === 'set-report-trip') {
                    state.selectedReportTrip = t.value;
                    state.helpersAccordion.report = true;
                    renderApp();
                }

                if (t.dataset.act === 'set-report-currency') {
                    state.reportCurrency = t.value;
                    state.helpersAccordion.report = true;
                    renderApp();
                }


                // FOTOÄžRAF YÃœKLEME Ä°ÅžLEYÄ°CÄ°SÄ°
                if (t.dataset.act === 'img-upload') {
                    const files = t.files;
                    const currentCount = state.form.imgs.length;
                    const newFiles = Array.from(files).slice(0, MAX_IMAGES - currentCount);

                    if (newFiles.length === 0 && files.length > 0) {
                        setState({ err: `Maksimum ${MAX_IMAGES} fotoÄŸraf ekleme limitine ulaÅŸÄ±ldÄ±.` });
                        t.value = '';
                        return;
                    }

                    if (newFiles.length > 0) {

                        setState({ err: 'Resimler iÅŸleniyor ve optimize ediliyor... LÃ¼tfen bekleyiniz.' });

                        const errorMessages = [];

                        const readerPromises = newFiles.map(file => {
                            return resizeAndConvertImage(file)
                                .catch(error => {
                                    errorMessages.push(`Hata (${file.name}): ${error.message}`);
                                    return null;
                                });
                        });

                        Promise.all(readerPromises)
                            .then(processedImages => {
                                const validImages = processedImages.filter(img => img !== null);

                                if (validImages.length > 0) {
                                    const updatedImgs = [...state.form.imgs, ...validImages];
                                    state.form.imgs = updatedImgs.slice(0, MAX_IMAGES);
                                }

                                let finalError = '';
                                if (errorMessages.length > 0) {
                                    finalError = `YÃ¼kleme HatalarÄ± (${errorMessages.length} dosya): ${errorMessages.join(' | ')}`;
                                } else if (validImages.length === 0 && files.length > 0) {
                                    finalError = 'HiÃ§ resim yÃ¼klenemedi (Desteklenmeyen dosya formatÄ± veya bilinmeyen hata).';
                                } else {
                                    finalError = '';
                                }

                                t.value = '';
                                setState({ err: finalError });

                            })
                            .catch(error => {
                                console.error("Resim iÅŸlenirken beklenmeyen genel genel hata oluÅŸtu:", error);
                                state.err = "Resim yÃ¼klenirken beklenmeyen genel bir hata oluÅŸtu.";
                                t.value = '';
                                renderApp();
                            });
                    } else {
                        t.value = '';
                    }
                }
            });

            document.addEventListener('input', e => {
                const t = e.target;

                if (t.dataset.act === 'search') {
                    // Eski input iÃ§eriÄŸi ve imleÃ§ pozisyonu
                    const input = t;
                    const value = input.value;
                    const caret = input.selectionStart ?? value.length;

                    // Arama state'ini gÃ¼ncelle
                    state.search = value;

                    // UygulamayÄ± yeniden Ã§iz
                    renderApp();

                    // Yeniden Ã§izilen DOM'da arama kutusunu tekrar bul
                    const newInput = document.querySelector('input[data-act="search"]');
                    if (newInput) {
                        // Tekrar odak ver
                        newInput.focus();
                        // Ä°mleci eski pozisyona getir (try/catch: bazÄ± tarayÄ±cÄ±larda hata atmamasÄ± iÃ§in)
                        try {
                            newInput.setSelectionRange(caret, caret);
                        } catch (e) { }
                    }

                    // Bu event burada bitti
                    return;
                }



                if (t.dataset.act === 'update-new-note') {
                    state.newCriticalNote = t.value;
                    return;
                }

                // Harcama formu inputlarÄ±
                if (t.closest('.form-modal-overlay') && !t.closest('[data-act="save-res"]')) { // Sadece harcama formu alanlarÄ±
                    const fExp = state.form;
                    let shouldRender = false;

                    switch (t.id) {
                        case 'i-trip':
                            fExp.trip = t.value;
                            // Seyahat deÄŸiÅŸince, o seyahatte tek bir para birimi varsa varsayÄ±lanÄ± ona Ã§ek
                            (function () {
                                const tripName = (t.value || '').trim();
                                if (tripName) {
                                    const tripExps = state.exp.filter(x => (x.trip || '') === tripName && x.cur);
                                    const tripCurrencies = [...new Set(tripExps.map(x => x.cur || BASE_CURRENCY))];
                                    if (tripCurrencies.length === 1) {
                                        fExp.cur = tripCurrencies[0];
                                        shouldRender = true;
                                    }
                                }
                            })();
                            break;
                        case 'i-city': fExp.city = t.value; break;
                        case 'i-place': fExp.place = t.value; break;
                        case 'i-amt':
                            fExp.amt = t.value.replace(',', '.').replace(/[^0-9.]/g, '');
                            break;
                        case 'i-cur': fExp.cur = t.value; shouldRender = true; break;
                        case 'i-ppl': fExp.ppl = t.value; break;
                        case 'i-date': fExp.date = t.value; shouldRender = true; break;
                        case 'i-type': fExp.type = t.value; break;
                        case 'i-desc': fExp.desc = t.value; break;
                        case 'i-start-km': fExp.startKm = t.value.replace(/[^0-9]/g, ''); break;
                        case 'i-end-km': fExp.endKm = t.value.replace(/[^0-9]/g, ''); break;
                        case 'i-fuel-amount':
                            fExp.fuelAmount = t.value.replace(',', '.').replace(/[^0-9.]/g, '');
                            break;
                        default: return;
                    }

                    if (shouldRender) {
                        renderApp();
                    }
                }

                // Rezervasyon formu inputlarÄ± ARTÄ°K BURADA DEÄžÄ°L. SAVE ANINDA DOM'DAN OKUNUYOR.
                if (state.modals.resForm) {
                    const fRes = state.resForm;
                    let shouldRender = false;

                    switch (t.id) {
                        case 'i-res-name': fRes.name = t.value; break;
                        case 'i-res-trip': fRes.trip = t.value; break;
                        case 'i-res-location': fRes.location = t.value; break;
                        case 'i-res-code': fRes.code = t.value; break;
                        case 'i-res-cost': fRes.cost = t.value.replace(',', '.').replace(/[^0-9.]/g, ''); break;
                        case 'i-res-notes': fRes.notes = t.value; break;
                        // Tarih ve Kur alanÄ± input'tan renderApp() Ã§aÄŸÄ±rmalÄ± ki gÃ¼ncel deÄŸerler formda gÃ¶rÃ¼nsÃ¼n
                        case 'i-res-start-date': fRes.startDate = t.value; shouldRender = true; break;
                        case 'i-res-end-date': fRes.endDate = t.value; shouldRender = true; break;
                        case 'i-res-cur': fRes.cur = t.value; shouldRender = true; break;
                        default: return;
                    }

                    if (shouldRender) {
                        renderApp();
                    }
                }
            });

            // Saati her saniye gÃ¼ncelleyen ana fonksiyon
            const updateClock = () => {
                const timeElement = document.getElementById('local-time');
                if (timeElement) {
                    const { time } = formatTime(state.targetTimezone);
                    state.currentTime = time;
                    timeElement.textContent = time;
                }
            };

            const startClock = () => {
                updateClock();
                timeInterval = setInterval(updateClock, 1000);
            };

            window.onload = function () {
                try {
                    initFirebaseAuth();
                    initState();
                    renderApp(); // Ä°lk ekran, kur beklemeden Ã§izilsin
                    // Konumu otomatik iste
                    if (typeof handleGeolocation === 'function') {
                        handleGeolocation();
                    }
                    fetchAndApplyRates().then(() => {
                        startClock();
                    });
                } catch (e) {
                    console.error(e);
                    const root = document.getElementById('app-root');
                    if (root) {
                        const msg = (e && e.message) ? e.message : String(e || 'Bilinmeyen hata');
                        root.innerHTML = '<div class="p-4 text-sm text-red-300 bg-slate-900">Uygulama baÅŸlatÄ±lÄ±rken hata oluÅŸtu: ' + msg + '</div>';
                    }
                }
            };

            window.onbeforeunload = function () {
                if (timeInterval) clearInterval(timeInterval);
            };

        })();
    </script>
</body>

</html>