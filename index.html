<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Seyahat Cüzdanı - Travel Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.7);
      border-radius: 9999px;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 text-slate-100">
  <div id="app" class="min-h-screen flex items-center justify-center px-4 py-6 md:px-6 md:py-10">
    <div id="app-root" class="w-full max-w-2xl md:max-w-3xl"></div>
  </div>

  <script>
  (() => {
    const STORAGE_KEY = 'travel_expenses';
    let expenseChartInstance = null;

    const ICONS = {
      wallet: `
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="6" width="18" height="13" rx="3"></rect>
          <path d="M16 10h3"></path>
          <path d="M8 6V4h8v2"></path>
        </svg>
      `,
      walletMini: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="6" width="18" height="13" rx="3"></rect>
          <path d="M16 10h3"></path>
          <path d="M8 6V4h8v2"></path>
        </svg>
      `,
      trash: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
        </svg>
      `,
      info: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      `,
      warning: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      `,
      calendar: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      `,
      person: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4z"></path>
          <path d="M5 21a7 7 0 0 1 14 0"></path>
        </svg>
      `,
      photo: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="5" width="18" height="14" rx="2"></rect>
          <circle cx="8.5" cy="10.5" r="1.5"></circle>
          <path d="M21 15l-3.5-3.5L13 16l-2-2-4 4"></path>
        </svg>
      `,
      plus: `
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      `,
      chart: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.21 15.89A10 10 0 1 1 12 2"></path>
          <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
        </svg>
      `,
      x: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      `,
      xMini: `
        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      `,
      edit: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20h9"></path>
          <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
        </svg>
      `,
      map: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18l-5 2V6l5-2 6 2 5-2v14l-5 2-6-2z"></path>
          <path d="M9 6v12"></path>
          <path d="M15 8v12"></path>
        </svg>
      `,
      locationPin: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 21s-6-4.35-6-10a6 6 0 1 1 12 0c0 5.65-6 10-6 10z"></path>
          <circle cx="12" cy="11" r="2.5"></circle>
        </svg>
      `,
      chevronUp: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
      `,
      chevronDown: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      `,
      categoryFood: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 3h2v7a2 2 0 0 1-2 2"></path>
          <path d="M10 3h2v7a2 2 0 0 1-2 2"></path>
          <path d="M6 3v7a2 2 0 0 1-2 2"></path>
          <path d="M18 3v18"></path>
          <path d="M14 7h8"></path>
        </svg>
      `,
      categoryStay: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 11l9-7 9 7"></path>
          <path d="M5 10v10h14V10"></path>
          <path d="M10 21v-6h4v6"></path>
        </svg>
      `,
      categoryTransport: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="12" rx="2"></rect>
          <path d="M3 10h18"></path>
          <path d="M7 20h0.01"></path>
          <path d="M17 20h0.01"></path>
        </svg>
      `,
      categoryShopping: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 7l2 12h8l2-12z"></path>
          <path d="M9 7a3 3 0 0 1 6 0"></path>
        </svg>
      `,
      categoryActivity: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="4" r="2"></circle>
          <path d="M9 22l1-7 2-3 3-1"></path>
          <path d="M5 11l4 1 2-2"></path>
        </svg>
      `,
      categoryOther: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="5" cy="12" r="2"></circle>
          <circle cx="12" cy="12" r="2"></circle>
          <circle cx="19" cy="12" r="2"></circle>
        </svg>
      `
    };

    const CATEGORY_META = {
      food: {
        id: 'food',
        label: 'Yeme-İçme',
        icon: ICONS.categoryFood,
        bgClass: 'bg-rose-50 text-rose-700 border border-rose-100',
        chartColor: 'rgba(244,63,94,0.8)'
      },
      stay: {
        id: 'stay',
        label: 'Konaklama',
        icon: ICONS.categoryStay,
        bgClass: 'bg-emerald-50 text-emerald-700 border border-emerald-100',
        chartColor: 'rgba(16,185,129,0.8)'
      },
      transport: {
        id: 'transport',
        label: 'Ulaşım',
        icon: ICONS.categoryTransport,
        bgClass: 'bg-sky-50 text-sky-700 border border-sky-100',
        chartColor: 'rgba(56,189,248,0.8)'
      },
      shopping: {
        id: 'shopping',
        label: 'Alışveriş',
        icon: ICONS.categoryShopping,
        bgClass: 'bg-amber-50 text-amber-700 border border-amber-100',
        chartColor: 'rgba(245,158,11,0.85)'
      },
      activity: {
        id: 'activity',
        label: 'Müze & Aktivite',
        icon: ICONS.categoryActivity,
        bgClass: 'bg-violet-50 text-violet-700 border border-violet-100',
        chartColor: 'rgba(139,92,246,0.85)'
      },
      other: {
        id: 'other',
        label: 'Diğer',
        icon: ICONS.categoryOther,
        bgClass: 'bg-slate-50 text-slate-700 border border-slate-100',
        chartColor: 'rgba(148,163,184,0.9)'
      }
    };

    const CITY_GRADIENTS = [
      'from-sky-500/60 to-sky-700/70',
      'from-violet-500/60 to-indigo-700/70',
      'from-emerald-500/60 to-emerald-700/70',
      'from-amber-500/60 to-orange-600/70',
      'from-rose-500/60 to-pink-600/70',
      'from-cyan-500/60 to-blue-600/70'
    ];

    function getEmptyForm() {
      const today = new Date().toISOString().slice(0, 10);
      return {
        id: null,
        city: '',
        place: '',
        amount: '',
        currency: 'TRY',
        date: today,
        category: '',
        description: '',
        peopleCount: '1',
        photos: []
      };
    }

    let state = {
      expenses: [],
      view: 'list',
      filterCategory: '',
      selectedExpenseId: null,
      showDetailModal: false,
      showConfirmClear: false,
      showChartModal: false,
      error: '',
      form: getEmptyForm(),
      expandedCities: {}
    };

    function loadExpenses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
        if (parsed && Array.isArray(parsed.expenses)) return parsed.expenses;
      } catch (err) {
        console.error('localStorage parse error', err);
      }
      return [];
    }

    function saveExpenses() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state.expenses));
      } catch (err) {
        console.error('localStorage save error', err);
      }
    }

    function clearAllExpenses() {
      state.expenses = [];
      state.expandedCities = {};
      state.selectedExpenseId = null;
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (err) {
        console.error('localStorage remove error', err);
      }
    }

    function setState(partial) {
      state = Object.assign({}, state, partial);
      renderApp();
      attachEventListeners();
    }

    function resetForm() {
      state.form = getEmptyForm();
    }

    function generateId() {
      return (
        Date.now().toString(36) +
        Math.random().toString(36).slice(2, 10)
      );
    }

    function toTitleCase(text) {
      if (!text) return '';
      return text
        .toLowerCase()
        .split(' ')
        .filter(Boolean)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function hashString(str) {
      let hash = 0;
      const s = String(str || '');
      for (let i = 0; i < s.length; i++) {
        hash = (hash << 5) - hash + s.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function getCityGradientClass(city) {
      const idx = CITY_GRADIENTS.length ? hashString(city) % CITY_GRADIENTS.length : 0;
      return CITY_GRADIENTS[idx] || 'from-sky-500/60 to-sky-700/70';
    }

    function getCategoryMeta(id) {
      if (CATEGORY_META[id]) return CATEGORY_META[id];
      return CATEGORY_META.other;
    }

    function getMapsUrl(city, place) {
      const query = [city, place].filter(Boolean).join(' ');
      return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(query);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return parts[2] + '.' + parts[1] + '.' + parts[0];
      }
      return dateStr;
    }

    function formatAmount(amount) {
      const num = Number(amount || 0);
      return num.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
    }

    function getVisibleExpenses() {
      if (!state.filterCategory) return state.expenses.slice();
      return state.expenses.filter(exp => exp.category === state.filterCategory);
    }

    function getSelectedExpense() {
      if (!state.selectedExpenseId) return null;
      return state.expenses.find(e => e.id === state.selectedExpenseId) || null;
    }

    function renderHeader() {
      return `
        <header class="flex items-center justify-between mb-4 md:mb-6">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-2xl bg-blue-500/20 border border-blue-400/60 flex items-center justify-center text-blue-200">
              ${ICONS.wallet}
            </div>
            <div>
              <h1 class="text-lg md:text-xl font-semibold tracking-tight text-slate-50">Seyahat Cüzdanı</h1>
              <p class="text-xs md:text-sm text-slate-400">Gezilerindeki tüm harcamaları tek yerden takip et</p>
            </div>
          </div>
          <button type="button" id="clear-all-btn" class="inline-flex items-center gap-1.5 px-3 py-2 rounded-xl text-xs font-medium bg-red-500/10 text-red-300 border border-red-500/40 hover:bg-red-500/20 transition">
            ${ICONS.trash}
            <span>Veriyi Temizle</span>
          </button>
        </header>
      `;
    }

    function renderError(errorMsg) {
      if (!errorMsg) return '';
      return `
        <div class="mb-3 md:mb-4 rounded-2xl border border-amber-400/40 bg-amber-500/10 px-3.5 py-2.5 text-xs md:text-sm text-amber-100 flex items-start gap-2">
          <div class="mt-[2px] text-amber-300">
            ${ICONS.warning}
          </div>
          <div>${escapeHtml(errorMsg)}</div>
        </div>
      `;
    }

    function renderSummaryCard(expenses) {
      if (!expenses || !expenses.length) {
        return `
          <section class="mb-4 md:mb-5">
            <div class="rounded-2xl bg-slate-900/70 border border-white/10 px-4 py-3.5 text-xs md:text-sm text-slate-200 flex items-center gap-2">
              <div class="text-slate-300">
                ${ICONS.info}
              </div>
              <div>Henüz kayıt yok. Sağ alttaki <span class="font-semibold">+</span> butonuyla ilk harcamanı ekle.</div>
            </div>
          </section>
        `;
      }

      const totalsByCurrency = {};
      expenses.forEach(exp => {
        const cur = exp.currency || 'TRY';
        const val = Number(exp.amount) || 0;
        if (!totalsByCurrency[cur]) totalsByCurrency[cur] = 0;
        totalsByCurrency[cur] += val;
      });

      const currencyChips = Object.entries(totalsByCurrency)
        .map(([cur, total]) => {
          const formatted = total.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
          return `
            <div class="flex items-baseline gap-1.5">
              <span class="text-xs text-sky-100/90">${cur}</span>
              <span class="text-sm md:text-base font-semibold text-slate-50">${formatted}</span>
            </div>
          `;
        })
        .join('');

      return `
        <section class="mb-4 md:mb-5">
          <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-blue-600/70 via-indigo-600/70 to-sky-500/70 border border-white/20 shadow">
            <div class="absolute -right-10 -bottom-10 w-40 h-40 rounded-full bg-white/10 blur-3xl"></div>
            <div class="relative px-4 py-3.5 md:px-5 md:py-4 flex items-center justify-between gap-3">
              <div>
                <p class="text-[11px] uppercase tracking-wide text-sky-100/90 font-medium">Özet</p>
                <p class="text-xs md:text-sm text-sky-50/90">
                  ${expenses.length} kayıt · ${Object.keys(totalsByCurrency).length} para birimi
                </p>
              </div>
              <div class="flex flex-col items-end text-right gap-0.5">
                ${currencyChips}
              </div>
            </div>
          </div>
        </section>
      `;
    }

    function renderFilterBar(allExpenses, visibleExpenses, selectedCategory) {
      const total = allExpenses.length;
      const visible = visibleExpenses.length;
      const filterText = selectedCategory
        ? `Kategori filtresi: ${getCategoryMeta(selectedCategory).label}`
        : 'Kategori filtresi yok';
      const disableChart = visible === 0;
      const options = Object.values(CATEGORY_META)
        .map(cat => `
          <option value="${cat.id}" ${selectedCategory === cat.id ? 'selected' : ''}>
            ${cat.label}
          </option>
        `)
        .join('');

      return `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3 md:mb-4">
          <div class="text-xs md:text-sm text-slate-200/90">
            <span class="font-medium">${visible}</span> kayıt görüntüleniyor
            <span class="text-slate-400"> · ${escapeHtml(filterText)}</span>
            ${total > visible ? `<span class="text-slate-500"> · Toplam ${total} kayıt</span>` : ''}
          </div>
          <div class="flex items-center gap-2">
            <select id="category-filter" class="text-xs md:text-sm rounded-xl border border-slate-600/60 bg-slate-900/70 text-slate-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/70">
              <option value="">Tüm kategoriler</option>
              ${options}
            </select>
            <button type="button" id="open-chart-modal-btn" ${disableChart ? 'disabled' : ''} class="inline-flex items-center gap-1.5 text-xs md:text-sm px-3 py-2 rounded-xl bg-slate-900/80 border border-blue-500/40 text-blue-300 hover:bg-slate-900/90 disabled:opacity-40 disabled:cursor-not-allowed">
              ${ICONS.chart}
              <span>Grafiği Göster</span>
            </button>
          </div>
        </div>
      `;
    }

    function renderCategoryToolbox(selectedCategory) {
      const cats = Object.values(CATEGORY_META);
      const buttons = cats
        .map(cat => {
          const isActive = selectedCategory === cat.id;
          const baseClasses = 'flex items-center gap-2 px-2.5 py-2 rounded-2xl border text-xs cursor-pointer transition';
          const activeClasses = 'bg-slate-900 border-blue-500/60 text-blue-200 shadow-[0_0_0_1px_rgba(59,130,246,0.6)]';
          const inactiveClasses = 'bg-slate-900/90 border-slate-700/90 text-slate-300 hover:bg-slate-900';
          return `
            <button type="button" data-category="${cat.id}" class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}">
              <span class="shrink-0 w-6 h-6 inline-flex items-center justify-center rounded-xl bg-slate-800/90">
                ${cat.icon}
              </span>
              <span class="truncate">${cat.label}</span>
            </button>
          `;
        })
        .join('');
      return `
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          ${buttons}
        </div>
      `;
    }

    function renderPhotoThumbnails(form) {
      const photos = form.photos || [];
      if (!photos.length) {
        return '<p class="text-[11px] text-slate-400 italic">Henüz fotoğraf seçilmedi.</p>';
      }
      let html = '<div class="grid grid-cols-3 gap-2">';
      photos.forEach((src, idx) => {
        html += `
          <div class="relative group">
            <img src="${src}" alt="Fotoğraf ${idx + 1}" class="w-full h-20 object-cover rounded-xl border border-slate-600/70" />
            <button type="button" data-remove-photo="${idx}" class="absolute -top-1.5 -right-1.5 inline-flex items-center justify-center w-5 h-5 rounded-full bg-black/70 text-slate-100 opacity-0 group-hover:opacity-100 transition">
              ${ICONS.xMini}
            </button>
          </div>
        `;
      });
      html += '</div>';
      return html;
    }

    function groupExpensesByCity(expenses) {
      const groups = {};
      expenses.forEach(exp => {
        const city = exp.city || 'Diğer';
        if (!groups[city]) groups[city] = [];
        groups[city].push(exp);
      });
      return groups;
    }

    function renderExpenseCard(expense) {
      const category = getCategoryMeta(expense.category);
      const dateLabel = formatDate(expense.date);
      const photosCount = (expense.photos && expense.photos.length) ? expense.photos.length : 0;
      const peopleCount = expense.peopleCount ? Number(expense.peopleCount) : 0;
      const peopleChip = peopleCount
        ? `
          <span class="inline-flex items-center gap-1 text-[11px] text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded-full">
            ${ICONS.person}
            <span>x${peopleCount}</span>
          </span>
        `
        : '';
      const photosChip = photosCount
        ? `
          <span class="inline-flex items-center gap-1 text-[11px] text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded-full">
            ${ICONS.photo}
            <span>${photosCount}</span>
          </span>
        `
        : '';

      return `
        <article class="bg-white/80 rounded-2xl shadow-sm border border-gray-100 px-3.5 py-3 md:px-4 md:py-3.5 cursor-pointer hover:shadow-md hover:-translate-y-[1px] transition" data-expense-id="${escapeHtml(expense.id)}">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              <div class="text-[11px] font-medium uppercase tracking-wide text-slate-400 mb-0.5">
                ${escapeHtml(expense.city || '')}
              </div>
              <div class="text-sm md:text-base font-semibold text-slate-900 truncate">
                ${expense.place ? escapeHtml(expense.place) : '<span class="text-slate-400">Başlıksız</span>'}
              </div>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[11px] font-medium ${category.bgClass}">
                  <span class="shrink-0">${category.icon}</span>
                  <span>${category.label}</span>
                </span>
                <span class="inline-flex items-center gap-1 text-[11px] text-slate-500">
                  ${ICONS.calendar}
                  <span>${dateLabel}</span>
                </span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <div class="text-sm md:text-base font-semibold text-slate-900">
                ${formatAmount(expense.amount)} <span class="text-xs text-slate-500 ml-0.5">${escapeHtml(expense.currency || '')}</span>
              </div>
              <div class="flex items-center gap-2 mt-1">
                ${peopleChip}
                ${photosChip}
              </div>
            </div>
          </div>
        </article>
      `;
    }

    function renderCityExpenses(expensesInCity) {
      const sorted = expensesInCity.slice().sort((a, b) => {
        const da = a.date || '';
        const db = b.date || '';
        return db.localeCompare(da);
      });
      return sorted.map(exp => renderExpenseCard(exp)).join('');
    }

    function renderCitySection(city, expensesInCity) {
      const isExpanded = state.expandedCities[city] !== false;
      const gradientClass = getCityGradientClass(city);

      const totalsByCurrency = {};
      expensesInCity.forEach(exp => {
        const cur = exp.currency || 'TRY';
        const val = Number(exp.amount) || 0;
        if (!totalsByCurrency[cur]) totalsByCurrency[cur] = 0;
        totalsByCurrency[cur] += val;
      });
      const summaryParts = Object.entries(totalsByCurrency)
        .map(([cur, total]) => total.toLocaleString('tr-TR', { maximumFractionDigits: 1 }) + ' ' + cur)
        .join(' · ');
      const summaryText = summaryParts ? ' · ' + summaryParts : '';

      return `
        <div class="mb-3 md:mb-4">
          <button type="button" data-city-toggle="${escapeHtml(city)}" class="w-full text-left bg-gradient-to-r ${gradientClass} p-[1px] rounded-2xl shadow-sm hover:shadow-md hover:-translate-y-[1px] transition">
            <div class="flex items-center justify-between gap-3 px-3.5 py-2.5 bg-slate-950/80 rounded-[1rem]">
              <div>
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-100">
                  ${escapeHtml(city)}
                </div>
                <div class="text-[11px] text-slate-300">
                  ${expensesInCity.length} kayıt${summaryText}
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="hidden md:flex flex-col text-right text-[10px] text-slate-200/90">
                  <span>Detayları ${isExpanded ? 'gizle' : 'göster'}</span>
                </div>
                <div class="w-7 h-7 rounded-full bg-slate-900/80 border border-white/20 flex items-center justify-center text-slate-100">
                  ${isExpanded ? ICONS.chevronUp : ICONS.chevronDown}
                </div>
              </div>
            </div>
          </button>
          ${isExpanded ? `<div class="mt-2 space-y-2.5 md:space-y-3">${renderCityExpenses(expensesInCity)}</div>` : ''}
        </div>
      `;
    }

    function renderExpenseList(expenses) {
      if (!expenses || !expenses.length) {
        return `
          <div class="rounded-2xl bg-slate-900/70 border border-slate-700/70 px-4 py-5 text-center text-sm text-slate-300">
            Henüz hiç harcama eklenmedi.<br/>
            Sağ alttaki <span class="font-semibold">+</span> butonuna tıklayarak ilk kaydını oluştur.
          </div>
        `;
      }

      const groups = groupExpensesByCity(expenses);
      const entries = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0], 'tr'));

      let html = '<div class="space-y-4 md:space-y-5 pb-2">';
      entries.forEach(([city, exps]) => {
        html += renderCitySection(city, exps);
      });
      html += '</div>';
      return html;
    }

    function renderFormView() {
      const f = state.form;
      return `
        <section class="mt-3 md:mt-4">
          <div class="mb-3 md:mb-4 flex items-center justify-between">
            <div>
              <h2 class="text-base md:text-lg font-semibold text-slate-50">Harcama Kaydı</h2>
              <p class="text-xs md:text-sm text-slate-400">${f.id ? 'Mevcut kaydı düzenliyorsun' : 'Yeni bir harcama ekle'}</p>
            </div>
            <button type="button" id="back-to-list-btn" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl bg-slate-900/70 border border-slate-700 text-xs text-slate-200 hover:bg-slate-900">
              ${ICONS.x}
              <span>Listeye Dön</span>
            </button>
          </div>

          <form id="expense-form" class="space-y-4 md:space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label for="city" class="block text-xs font-medium text-slate-300 mb-1.5">Şehir</label>
                <input id="city" type="text" autocomplete="off" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/70" placeholder="Örn. Sevilla" value="${escapeHtml(f.city)}" />
              </div>
              <div>
                <label for="place" class="block text-xs font-medium text-slate-300 mb-1.5">Mekan / Başlık</label>
                <input id="place" type="text" autocomplete="off" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/70" placeholder="Örn. Kahve Molası" value="${escapeHtml(f.place)}" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label for="amount" class="block text-xs font-medium text-slate-300 mb-1.5">Tutar</label>
                <input id="amount" type="number" step="0.01" min="0" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/70" placeholder="0.00" value="${escapeHtml(f.amount)}" />
              </div>
              <div>
                <label for="currency" class="block text-xs font-medium text-slate-300 mb-1.5">Para Birimi</label>
                <select id="currency" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500/70">
                  ${['TRY','EUR','USD','GBP'].map(cur => `
                    <option value="${cur}" ${f.currency === cur ? 'selected' : ''}>${cur}</option>
                  `).join('')}
                </select>
              </div>
              <div>
                <label for="date" class="block text-xs font-medium text-slate-300 mb-1.5">Tarih</label>
                <input id="date" type="date" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500/70" value="${escapeHtml(f.date)}" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label for="peopleCount" class="block text-xs font-medium text-slate-300 mb-1.5">Kişi Sayısı</label>
                <input id="peopleCount" type="number" min="1" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/70" value="${escapeHtml(f.peopleCount)}" />
              </div>
              <div class="md:col-span-2">
                <span class="block text-xs font-medium text-slate-300 mb-1.5">Kategori</span>
                ${renderCategoryToolbox(f.category)}
              </div>
            </div>

            <div>
              <label for="description" class="block text-xs font-medium text-slate-300 mb-1.5">Açıklama</label>
              <textarea id="description" rows="3" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/70" placeholder="Notlar, detaylar...">${escapeHtml(f.description)}</textarea>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-300 mb-1.5">Fotoğraflar (max 3)</label>
              <div class="flex flex-col md:flex-row md:items-center gap-3">
                <div>
                  <input type="file" id="photo-input" accept="image/*" multiple class="block text-xs text-slate-300 file:mr-3 file:py-2 file:px-3 file:rounded-2xl file:border-0 file:text-xs file:font-medium file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer" />
                  <p class="mt-1 text-[11px] text-slate-400">Fotoğraflar otomatik olarak sıkıştırılıp base64 olarak kaydedilir.</p>
                </div>
                <div class="flex-1">
                  ${renderPhotoThumbnails(f)}
                </div>
              </div>
            </div>

            <div class="pt-2 flex items-center justify-between gap-3">
              <button type="button" id="close-form-btn" class="inline-flex items-center justify-center px-3.5 py-2.5 rounded-2xl bg-slate-900/70 border border-slate-700/70 text-xs md:text-sm text-slate-200 hover:bg-slate-900">
                İptal
              </button>
              <button type="submit" id="save-expense-btn" class="inline-flex items-center justify-center px-4 py-2.5 rounded-2xl bg-blue-600 text-xs md:text-sm font-medium text-white shadow hover:bg-blue-700">
                ${ICONS.walletMini}
                <span class="ml-1.5">${f.id ? 'Kaydı Güncelle' : 'Kaydet'}</span>
              </button>
            </div>
          </form>
        </section>
      `;
    }

    function renderDetailModal(expense) {
      if (!expense) return '';
      const category = getCategoryMeta(expense.category);
      const dateLabel = formatDate(expense.date);
      const amountFormatted = formatAmount(expense.amount);
      const currency = escapeHtml(expense.currency || '');
      const peopleCount = expense.peopleCount ? Number(expense.peopleCount) : 0;
      const perPerson = peopleCount ? (Number(expense.amount) / peopleCount) : null;
      const perPersonFormatted = perPerson ? perPerson.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) : null;
      const mapsUrl = getMapsUrl(expense.city, expense.place);
      const photos = expense.photos || [];

      let photosHtml = '';
      if (photos.length) {
        photosHtml = '<div class="mt-3"><h4 class="text-xs font-semibold text-slate-700 mb-2">Fotoğraflar</h4><div class="grid grid-cols-2 gap-2">';
        photos.forEach((src, idx) => {
          photosHtml += `
            <div class="overflow-hidden rounded-2xl border border-slate-200">
              <img src="${src}" alt="Fotoğraf ${idx + 1}" class="w-full h-28 object-cover" />
            </div>
          `;
        });
        photosHtml += '</div></div>';
      }

      const peopleInfo = peopleCount ? `
        <div class="mt-1 flex items-center justify-between text-xs text-slate-600">
          <div class="inline-flex items-center gap-1">
            ${ICONS.person}
            <span>${peopleCount} kişi</span>
          </div>
          <div class="inline-flex items-center gap-1">
            ${ICONS.walletMini}
            <span>Kişi başı: <span class="font-semibold text-slate-800">${perPersonFormatted} ${currency}</span></span>
          </div>
        </div>
      ` : '';

      return `
        <div id="detail-modal-overlay" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6 bg-black/60 backdrop-blur-sm">
          <div id="detail-modal" class="relative w-full max-w-md max-h-[85vh] overflow-y-auto scrollbar-thin bg-white rounded-3xl shadow-2xl p-5 md:p-6">
            <div class="flex items-start justify-between gap-3 mb-3">
              <div>
                <p class="text-[11px] font-medium uppercase tracking-wide text-slate-400 mb-0.5">
                  ${escapeHtml(expense.city || '')}
                </p>
                <h2 class="text-base md:text-lg font-semibold text-slate-900">
                  ${expense.place ? escapeHtml(expense.place) : 'Harcama Detayı'}
                </h2>
              </div>
              <button type="button" id="close-detail-modal-btn" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200">
                ${ICONS.x}
              </button>
            </div>

            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="text-xs text-slate-500 mb-1 inline-flex items-center gap-1">
                  ${ICONS.calendar}
                  <span>${dateLabel}</span>
                </div>
                <div class="mt-1 inline-flex items-center gap-2">
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[11px] font-medium ${category.bgClass}">
                    <span class="shrink-0">${category.icon}</span>
                    <span>${category.label}</span>
                  </span>
                </div>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-500 mb-0.5">Toplam Tutar</div>
                <div class="text-lg font-semibold text-slate-900">
                  ${amountFormatted} <span class="text-xs text-slate-500">${currency}</span>
                </div>
              </div>
            </div>

            ${peopleInfo}

            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="text-xs text-slate-600 flex-1">
                <div class="flex items-start gap-2">
                  <div class="mt-[2px] text-slate-500">
                    ${ICONS.locationPin}
                  </div>
                  <div>
                    <div class="font-medium text-slate-800">${escapeHtml(expense.city || '')}</div>
                    ${expense.place ? `<div class="text-slate-600">${escapeHtml(expense.place)}</div>` : ''}
                  </div>
                </div>
              </div>
              <a href="${mapsUrl}" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-2xl bg-blue-50 text-xs font-medium text-blue-700 border border-blue-100 hover:bg-blue-100">
                ${ICONS.map}
                <span>Haritada Aç</span>
              </a>
            </div>

            ${expense.description ? `
              <div class="mt-3">
                <h4 class="text-xs font-semibold text-slate-700 mb-1.5">Notlar</h4>
                <p class="text-sm text-slate-600 whitespace-pre-line">${escapeHtml(expense.description)}</p>
              </div>
            ` : ''}

            ${photosHtml}

            <div class="mt-5 flex items-center justify-between gap-3">
              <button type="button" id="edit-expense-btn" class="flex-1 inline-flex items-center justify-center px-3.5 py-2.5 rounded-2xl bg-slate-900 text-xs md:text-sm font-medium text-slate-50 border border-slate-900 hover:bg-slate-800">
                ${ICONS.edit}
                <span class="ml-1.5">Düzenle</span>
              </button>
              <button type="button" id="delete-expense-btn" class="inline-flex items-center justify-center px-3.5 py-2.5 rounded-2xl bg-red-600/90 text-xs md:text-sm font-medium text-white shadow hover:bg-red-700">
                ${ICONS.trash}
                <span class="ml-1.5">Sil</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderConfirmClearModal() {
      return `
        <div id="confirm-clear-modal" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6 bg-black/60 backdrop-blur-sm">
          <div class="w-full max-w-sm bg-slate-950/95 border border-red-500/40 rounded-3xl p-5">
            <div class="flex items-start gap-3">
              <div class="mt-1 text-red-400">
                ${ICONS.warning}
              </div>
              <div>
                <h3 class="text-sm font-semibold text-slate-50 mb-1">Tüm verileri silmek istiyor musun?</h3>
                <p class="text-xs text-slate-300 mb-3">
                  Bu işlem geri alınamaz. Tüm harcamalar ve fotoğraflar cihazındaki localStorage'dan temizlenecek.
                </p>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-end gap-2">
              <button type="button" id="cancel-clear-all-btn" class="px-3 py-1.5 rounded-2xl bg-slate-900 text-xs text-slate-200 border border-slate-700 hover:bg-slate-800">
                Vazgeç
              </button>
              <button type="button" id="confirm-clear-all-btn" class="px-3 py-1.5 rounded-2xl bg-red-600 text-xs text-white hover:bg-red-700">
                Evet, sil
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderChartModal() {
      return `
        <div id="chart-modal-overlay" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6 bg-black/60 backdrop-blur-sm">
          <div id="chart-modal" class="w-full max-w-md max-h-[80vh] bg-white rounded-3xl shadow-2xl flex flex-col">
            <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
              <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center">
                  ${ICONS.chart}
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-slate-900">Harcama Dağılımı</h3>
                  <p class="text-[11px] text-slate-500">Kategorilere göre toplam tutarların dağılımı</p>
                </div>
              </div>
              <button type="button" id="close-chart-modal-btn" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200">
                ${ICONS.x}
              </button>
            </div>
            <div class="px-5 pt-4 pb-5 flex-1 flex flex-col">
              <div class="relative h-40 md:h-52">
                <canvas id="expenseChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderFab() {
      return `
        <button id="add-expense-fab" class="fixed bottom-6 right-6 z-30 inline-flex items-center justify-center w-14 h-14 rounded-full bg-blue-600 text-white shadow-lg shadow-blue-500/40 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-slate-900">
          ${ICONS.plus}
        </button>
      `;
    }

    function renderApp() {
      const root = document.getElementById('app-root');
      if (!root) return;

      const visibleExpenses = getVisibleExpenses();

      let html = `
        <div class="relative bg-white/10 border border-white/10 backdrop-blur-xl rounded-3xl shadow-[0_24px_80px_rgba(15,23,42,0.9)] p-4 md:p-6 overflow-hidden">
          ${renderHeader()}
          ${renderError(state.error)}
          ${renderSummaryCard(state.expenses)}
          ${
            state.view === 'list'
              ? `
                ${renderFilterBar(state.expenses, visibleExpenses, state.filterCategory)}
                ${renderExpenseList(visibleExpenses)}
              `
              : `
                ${renderFormView()}
              `
          }
        </div>
        ${state.view === 'list' ? renderFab() : ''}
        ${state.showDetailModal ? renderDetailModal(getSelectedExpense()) : ''}
        ${state.showConfirmClear ? renderConfirmClearModal() : ''}
        ${state.showChartModal ? renderChartModal() : ''}
      `;

      root.innerHTML = html;
    }

    function resizeImageToDataURL(file) {
      const maxSize = 1280;
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) {
                height = Math.round((height * maxSize) / width);
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = Math.round((width * maxSize) / height);
                height = maxSize;
              }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            resolve(dataUrl);
          };
          img.onerror = (e) => reject(e);
          img.src = event.target.result;
        };
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
    }

    function handlePhotoInputChange(e) {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const existingPhotos = state.form.photos || [];
      const remainingSlots = 3 - existingPhotos.length;
      if (remainingSlots <= 0) {
        setState({ error: 'En fazla 3 fotoğraf ekleyebilirsin.' });
        e.target.value = '';
        return;
      }
      const filesToUse = files.slice(0, remainingSlots);
      if (files.length > remainingSlots) {
        setState({ error: 'En fazla 3 fotoğraf ekleyebilirsin. Fazladan seçilenler alınmadı.' });
      }
      Promise.all(filesToUse.map(resizeImageToDataURL))
        .then((newPhotos) => {
          const nextPhotos = existingPhotos.concat(newPhotos);
          const newForm = Object.assign({}, state.form, { photos: nextPhotos });
          state.form = newForm;
          setState({ form: newForm, error: '' });
        })
        .catch((err) => {
          console.error(err);
          setState({ error: 'Fotoğraflar işlenirken bir hata oluştu.' });
        })
        .finally(() => {
          e.target.value = '';
        });
    }

    function renderExpenseChart() {
      const canvas = document.getElementById('expenseChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const expenses = getVisibleExpenses();
      if (!expenses.length) return;

      const totals = {};
      expenses.forEach(exp => {
        const catId = exp.category || 'other';
        const amount = Number(exp.amount) || 0;
        if (!amount) return;
        if (!totals[catId]) totals[catId] = 0;
        totals[catId] += amount;
      });
      const catIds = Object.keys(totals);
      if (!catIds.length) return;

      const labels = catIds.map(id => getCategoryMeta(id).label);
      const data = catIds.map(id => totals[id]);
      const colors = catIds.map(id => getCategoryMeta(id).chartColor);

      if (expenseChartInstance) {
        expenseChartInstance.destroy();
        expenseChartInstance = null;
      }

      expenseChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: colors,
              borderWidth: 1,
              borderColor: 'rgba(15,23,42,0.08)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#0f172a',
                font: { size: 11 }
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  return label + ': ' + value.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
                }
              }
            }
          }
        }
      });
    }

    function openNewExpenseForm() {
      resetForm();
      setState({
        view: 'form',
        selectedExpenseId: null,
        showDetailModal: false,
        error: ''
      });
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const f = state.form;

      const trimmedCity = (f.city || '').trim();
      const trimmedPlace = (f.place || '').trim();
      const amountNum = parseFloat(f.amount);
      const peopleNum = parseInt(f.peopleCount || '1', 10) || 1;

      const errors = [];
      if (!trimmedCity) errors.push('Şehir alanı zorunludur.');
      if (!trimmedPlace) errors.push('Mekan / başlık alanı zorunludur.');
      if (!f.date) errors.push('Tarih seçmelisin.');
      if (!f.currency) errors.push('Para birimi seçmelisin.');
      if (!f.category) errors.push('Kategori seçmelisin.');
      if (!amountNum || amountNum <= 0) errors.push('Tutar 0\'dan büyük olmalıdır.');

      if (errors.length) {
        setState({ error: errors[0] });
        return;
      }

      const normalizedCity = toTitleCase(trimmedCity);
      const normalizedPlace = toTitleCase(trimmedPlace);

      const expense = {
        id: f.id || generateId(),
        city: normalizedCity,
        place: normalizedPlace,
        amount: amountNum,
        currency: f.currency,
        date: f.date,
        category: f.category,
        description: (f.description || '').trim(),
        peopleCount: peopleNum,
        photos: (f.photos || []).slice()
      };

      let newExpenses;
      if (f.id) {
        newExpenses = state.expenses.map(exp => exp.id === f.id ? Object.assign({}, exp, expense) : exp);
      } else {
        newExpenses = state.expenses.concat(expense);
      }
      state.expenses = newExpenses;
      const newExpanded = Object.assign({}, state.expandedCities, { [normalizedCity]: true });
      state.expandedCities = newExpanded;

      saveExpenses();
      resetForm();
      setState({
        view: 'list',
        error: ''
      });
    }

    function handleDeleteExpense() {
      const exp = getSelectedExpense();
      if (!exp) return;
      const filtered = state.expenses.filter(e => e.id !== exp.id);
      state.expenses = filtered;
      const remainingForCity = filtered.filter(e => e.city === exp.city);
      const expanded = Object.assign({}, state.expandedCities);
      if (!remainingForCity.length && expanded.hasOwnProperty(exp.city)) {
        delete expanded[exp.city];
      }
      state.expandedCities = expanded;
      saveExpenses();
      setState({
        showDetailModal: false,
        selectedExpenseId: null,
        error: ''
      });
    }

    function attachEventListeners() {
      const categoryFilter = document.getElementById('category-filter');
      if (categoryFilter) {
        categoryFilter.addEventListener('change', (e) => {
          setState({ filterCategory: e.target.value });
        });
      }

      const openChartBtn = document.getElementById('open-chart-modal-btn');
      if (openChartBtn) {
        openChartBtn.addEventListener('click', () => {
          if (getVisibleExpenses().length === 0) return;
          setState({ showChartModal: true });
        });
      }

      const closeChartBtn = document.getElementById('close-chart-modal-btn');
      if (closeChartBtn) {
        closeChartBtn.addEventListener('click', () => {
          if (expenseChartInstance) {
            expenseChartInstance.destroy();
            expenseChartInstance = null;
          }
          setState({ showChartModal: false });
        });
      }

      const chartOverlay = document.getElementById('chart-modal-overlay');
      if (chartOverlay) {
        chartOverlay.addEventListener('click', (e) => {
          if (e.target === chartOverlay) {
            if (expenseChartInstance) {
              expenseChartInstance.destroy();
              expenseChartInstance = null;
            }
            setState({ showChartModal: false });
          }
        });
      }

      const chartCanvas = document.getElementById('expenseChart');
      if (chartCanvas && state.showChartModal) {
        renderExpenseChart();
      }

      const clearBtn = document.getElementById('clear-all-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          setState({ showConfirmClear: true });
        });
      }

      const confirmClearBtn = document.getElementById('confirm-clear-all-btn');
      if (confirmClearBtn) {
        confirmClearBtn.addEventListener('click', () => {
          clearAllExpenses();
          setState({ showConfirmClear: false, error: '' });
        });
      }

      const cancelClearBtn = document.getElementById('cancel-clear-all-btn');
      if (cancelClearBtn) {
        cancelClearBtn.addEventListener('click', () => {
          setState({ showConfirmClear: false });
        });
      }

      const fab = document.getElementById('add-expense-fab');
      if (fab) {
        fab.addEventListener('click', () => {
          openNewExpenseForm();
        });
      }

      const backBtn = document.getElementById('back-to-list-btn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          resetForm();
          setState({ view: 'list', error: '' });
        });
      }

      const closeFormBtn = document.getElementById('close-form-btn');
      if (closeFormBtn) {
        closeFormBtn.addEventListener('click', () => {
          resetForm();
          setState({ view: 'list', error: '' });
        });
      }

      const formEl = document.getElementById('expense-form');
      if (formEl) {
        formEl.addEventListener('submit', handleFormSubmit);
      }

      const cityInput = document.getElementById('city');
      if (cityInput) {
        cityInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { city: e.target.value });
        });
      }

      const placeInput = document.getElementById('place');
      if (placeInput) {
        placeInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { place: e.target.value });
        });
      }

      const amountInput = document.getElementById('amount');
      if (amountInput) {
        amountInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { amount: e.target.value });
        });
      }

      const currencySelect = document.getElementById('currency');
      if (currencySelect) {
        currencySelect.addEventListener('change', (e) => {
          state.form = Object.assign({}, state.form, { currency: e.target.value });
        });
      }

      const dateInput = document.getElementById('date');
      if (dateInput) {
        dateInput.addEventListener('change', (e) => {
          state.form = Object.assign({}, state.form, { date: e.target.value });
        });
      }

      const peopleInput = document.getElementById('peopleCount');
      if (peopleInput) {
        peopleInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { peopleCount: e.target.value });
        });
      }

      const descInput = document.getElementById('description');
      if (descInput) {
        descInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { description: e.target.value });
        });
      }

      const categoryButtons = document.querySelectorAll('[data-category]');
      categoryButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = btn.getAttribute('data-category');
          const newForm = Object.assign({}, state.form, { category: catId });
          state.form = newForm;
          setState({ form: newForm, error: '' });
        });
      });

      const photoInput = document.getElementById('photo-input');
      if (photoInput) {
        photoInput.addEventListener('change', handlePhotoInputChange);
      }

      const thumbDeleteBtns = document.querySelectorAll('[data-remove-photo]');
      thumbDeleteBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.getAttribute('data-remove-photo'), 10);
          const photos = (state.form.photos || []).slice();
          if (idx >= 0 && idx < photos.length) {
            photos.splice(idx, 1);
            const newForm = Object.assign({}, state.form, { photos });
            state.form = newForm;
            setState({ form: newForm });
          }
        });
      });

      const expenseCards = document.querySelectorAll('[data-expense-id]');
      expenseCards.forEach(card => {
        card.addEventListener('click', () => {
          const id = card.getAttribute('data-expense-id');
          setState({
            selectedExpenseId: id,
            showDetailModal: true,
            error: ''
          });
        });
      });

      const cityHeaders = document.querySelectorAll('[data-city-toggle]');
      cityHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const city = header.getAttribute('data-city-toggle');
          const isExpanded = state.expandedCities[city] !== false;
          const updated = Object.assign({}, state.expandedCities, { [city]: !isExpanded });
          state.expandedCities = updated;
          setState({ expandedCities: updated });
        });
      });

      const closeDetailBtn = document.getElementById('close-detail-modal-btn');
      if (closeDetailBtn) {
        closeDetailBtn.addEventListener('click', () => {
          setState({ showDetailModal: false, selectedExpenseId: null });
        });
      }

      const detailOverlay = document.getElementById('detail-modal-overlay');
      if (detailOverlay) {
        detailOverlay.addEventListener('click', (e) => {
          if (e.target === detailOverlay) {
            setState({ showDetailModal: false, selectedExpenseId: null });
          }
        });
      }

      const deleteExpenseBtn = document.getElementById('delete-expense-btn');
      if (deleteExpenseBtn) {
        deleteExpenseBtn.addEventListener('click', handleDeleteExpense);
      }

      const editExpenseBtn = document.getElementById('edit-expense-btn');
      if (editExpenseBtn) {
        editExpenseBtn.addEventListener('click', () => {
          const expense = getSelectedExpense();
          if (!expense) return;
          const form = {
            id: expense.id,
            city: expense.city || '',
            place: expense.place || '',
            amount: String(expense.amount || ''),
            currency: expense.currency || 'TRY',
            date: expense.date || new Date().toISOString().slice(0, 10),
            category: expense.category || '',
            description: expense.description || '',
            peopleCount: String(expense.peopleCount || '1'),
            photos: (expense.photos || []).slice()
          };
          state.form = form;
          setState({
            view: 'form',
            showDetailModal: false,
            error: '',
            form
          });
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const loaded = loadExpenses();
      state.expenses = loaded;
      const expanded = {};
      loaded.forEach(exp => {
        if (exp.city) expanded[exp.city] = true;
      });
      state.expandedCities = expanded;
      if (!state.form.date) {
        state.form.date = new Date().toISOString().slice(0, 10);
      }
      renderApp();
      attachEventListeners();
    });
  })();
  </script>
</body>
</html>
