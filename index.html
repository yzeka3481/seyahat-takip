<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Seyahat CÃ¼zdanÄ± - Travel Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.7);
      border-radius: 9999px;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 text-slate-100">
  <div id="app" class="min-h-screen flex items-center justify-center px-4 py-6 md:px-6 md:py-10">
    <div id="app-root" class="w-full max-w-xl md:max-w-2xl"></div>
  </div>

  <script>
  (() => {
    const STORAGE_KEY = 'travel_expenses';
    const CHECKLIST_STORAGE_KEY = 'travel_checklist';
    let expenseChartInstance = null;

    const ICONS = {
      wallet: `
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="6" width="18" height="13" rx="3"></rect>
          <path d="M16 10h3"></path>
          <path d="M8 6V4h8v2"></path>
        </svg>
      `,
      walletMini: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="6" width="18" height="13" rx="3"></rect>
          <path d="M16 10h3"></path>
          <path d="M8 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
        </svg>
      `,
      trash: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
        </svg>
      `,
      info: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      `,
      warning: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      `,
      calendar: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      `,
      person: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4z"></path>
          <path d="M5 21a7 7 0 0 1 14 0"></path>
        </svg>
      `,
      photo: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="5" width="18" height="14" rx="2"></rect>
          <circle cx="8.5" cy="10.5" r="1.5"></circle>
          <path d="M21 15l-3.5-3.5L13 16l-2-2-4 4"></path>
        </svg>
      `,
      plus: `
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      `,
      chart: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.21 15.89A10 10 0 1 1 12 2"></path>
          <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
        </svg>
      `,
      x: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      `,
      xMini: `
        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      `,
      edit: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20h9"></path>
          <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
        </svg>
      `,
      map: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18l-5 2V6l5-2 6 2 5-2v14l-5 2-6-2z"></path>
          <path d="M9 6v12"></path>
          <path d="M15 8v12"></path>
        </svg>
      `,
      locationPin: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 21s-6-4.35-6-10a6 6 0 1 1 12 0c0 5.65-6 10-6 10z"></path>
          <circle cx="12" cy="11" r="2.5"></circle>
        </svg>
      `,
      chevronUp: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
      `,
      chevronDown: `
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      `,
      categoryFood: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 3h2v7a2 2 0 0 1-2 2"></path>
          <path d="M10 3h2v7a2 2 0 0 1-2 2"></path>
          <path d="M6 3v7a2 2 0 0 1-2 2"></path>
          <path d="M18 3v18"></path>
          <path d="M14 7h8"></path>
        </svg>
      `,
      categoryStay: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 11l9-7 9 7"></path>
          <path d="M5 10v10h14V10"></path>
          <path d="M10 21v-6h4v6"></path>
        </svg>
      `,
      categoryTransport: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="12" rx="2"></rect>
          <path d="M3 10h18"></path>
          <path d="M7 20h0.01"></path>
          <path d="M17 20h0.01"></path>
        </svg>
      `,
      categoryShopping: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 7l2 12h8l2-12z"></path>
          <path d="M9 7a3 3 0 0 1 6 0"></path>
        </svg>
      `,
      categoryActivity: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="4" r="2"></circle>
          <path d="M9 22l1-7 2-3 3-1"></path>
          <path d="M5 11l4 1 2-2"></path>
        </svg>
      `,
      categoryOther: `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="5" cy="12" r="2"></circle>
          <circle cx="12" cy="12" r="2"></circle>
          <circle cx="19" cy="12" r="2"></circle>
        </svg>
      `
    };

    const CATEGORY_META = {
      food: {
        id: 'food',
        label: 'Yeme-Ä°Ã§me',
        icon: ICONS.categoryFood,
        bgClass: 'bg-rose-50 text-rose-700 border border-rose-100',
        chartColor: 'rgba(244,63,94,0.8)',
        accent: 'bg-rose-500/15 text-rose-400',
        headerGradient: 'from-rose-500 via-rose-500 to-amber-400'
      },
      stay: {
        id: 'stay',
        label: 'Konaklama',
        icon: ICONS.categoryStay,
        bgClass: 'bg-emerald-50 text-emerald-700 border border-emerald-100',
        chartColor: 'rgba(16,185,129,0.8)',
        accent: 'bg-emerald-500/15 text-emerald-400',
        headerGradient: 'from-emerald-500 via-emerald-500 to-teal-400'
      },
      transport: {
        id: 'transport',
        label: 'UlaÅŸÄ±m',
        icon: ICONS.categoryTransport,
        bgClass: 'bg-sky-50 text-sky-700 border border-sky-100',
        chartColor: 'rgba(56,189,248,0.8)',
        accent: 'bg-sky-500/15 text-sky-400',
        headerGradient: 'from-sky-500 via-sky-500 to-indigo-400'
      },
      shopping: {
        id: 'shopping',
        label: 'AlÄ±ÅŸveriÅŸ',
        icon: ICONS.categoryShopping,
        bgClass: 'bg-amber-50 text-amber-700 border border-amber-100',
        chartColor: 'rgba(245,158,11,0.85)',
        accent: 'bg-amber-500/15 text-amber-400',
        headerGradient: 'from-amber-500 via-amber-500 to-rose-400'
      },
      activity: {
        id: 'activity',
        label: 'MÃ¼ze & Aktivite',
        icon: ICONS.categoryActivity,
        bgClass: 'bg-violet-50 text-violet-700 border border-violet-100',
        chartColor: 'rgba(139,92,246,0.85)',
        accent: 'bg-violet-500/15 text-violet-400',
        headerGradient: 'from-violet-500 via-violet-500 to-indigo-400'
      },
      other: {
        id: 'other',
        label: 'DiÄŸer',
        icon: ICONS.categoryOther,
        bgClass: 'bg-slate-50 text-slate-700 border border-slate-100',
        chartColor: 'rgba(148,163,184,0.9)',
        accent: 'bg-slate-500/15 text-slate-300',
        headerGradient: 'from-slate-500 via-slate-600 to-slate-700'
      }
    };

    const CITY_GRADIENTS = [
      'from-sky-500/70 to-sky-700/80',
      'from-violet-500/70 to-indigo-700/80',
      'from-emerald-500/70 to-emerald-700/80',
      'from-amber-500/70 to-orange-600/80',
      'from-rose-500/70 to-pink-600/80',
      'from-cyan-500/70 to-blue-600/80'
    ];

    const CHECKLIST_META = {
      documents: { id: 'documents', label: 'Belgeler', icon: 'ðŸ“„' },
      clothes: { id: 'clothes', label: 'Giyim', icon: 'ðŸ‘•' },
      electronics: { id: 'electronics', label: 'Elektronik', icon: 'ðŸ”Œ' },
      health: { id: 'health', label: 'SaÄŸlÄ±k', icon: 'ðŸ’Š' },
      other: { id: 'other', label: 'DiÄŸer', icon: 'â­' }
    };

    function getEmptyForm() {
      const today = new Date().toISOString().slice(0, 10);
      return {
        id: null,
        city: '',
        place: '',
        amount: '',
        currency: 'TRY',
        date: today,
        category: '',
        description: '',
        peopleCount: '1',
        photos: []
      };
    }

    function getDefaultChecklistItems() {
      return [
        { id: generateId(), label: 'Pasaport', category: 'documents', done: false },
        { id: generateId(), label: 'Kimlik / Ehliyet', category: 'documents', done: false },
        { id: generateId(), label: 'UÃ§ak bileti / Rezervasyon', category: 'documents', done: false },

        { id: generateId(), label: 'Ä°Ã§ Ã§amaÅŸÄ±rÄ±', category: 'clothes', done: false },
        { id: generateId(), label: 'Yedek tiÅŸÃ¶rt', category: 'clothes', done: false },
        { id: generateId(), label: 'HÄ±rka / YaÄŸmurluk', category: 'clothes', done: false },

        { id: generateId(), label: 'Telefon ÅŸarj aleti', category: 'electronics', done: false },
        { id: generateId(), label: 'Powerbank', category: 'electronics', done: false },
        { id: generateId(), label: 'FotoÄŸraf makinesi / SD kart', category: 'electronics', done: false },

        { id: generateId(), label: 'GÃ¼nlÃ¼k kullanÄ±lan ilaÃ§lar', category: 'health', done: false },
        { id: generateId(), label: 'AÄŸrÄ± kesici', category: 'health', done: false },
        { id: generateId(), label: 'Yara bandÄ± / bandaj', category: 'health', done: false },

        { id: generateId(), label: 'Not defteri / kalem', category: 'other', done: false },
        { id: generateId(), label: 'AtÄ±ÅŸtÄ±rmalÄ±k', category: 'other', done: false }
      ];
    }

    let state = {
      expenses: [],
      view: 'list',              // 'list' | 'form'
      activeTab: 'expenses',     // 'expenses' | 'checklist'
      filterCategory: '',
      selectedExpenseId: null,
      showDetailModal: false,
      showConfirmClear: false,
      showChartModal: false,
      error: '',
      form: getEmptyForm(),
      expandedCities: {},
      checklistItems: []
    };

    function loadExpenses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
        if (parsed && Array.isArray(parsed.expenses)) return parsed.expenses;
      } catch (err) {
        console.error('localStorage parse error', err);
      }
      return [];
    }

    function saveExpenses() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state.expenses));
      } catch (err) {
        console.error('localStorage save error', err);
      }
    }

    function clearAllExpenses() {
      state.expenses = [];
      state.expandedCities = {};
      state.selectedExpenseId = null;
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (err) {
        console.error('localStorage remove error', err);
      }
    }

    function loadChecklist() {
      try {
        const raw = localStorage.getItem(CHECKLIST_STORAGE_KEY);
        if (!raw) return getDefaultChecklistItems();
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
        if (parsed && Array.isArray(parsed.items)) return parsed.items;
      } catch (err) {
        console.error('localStorage checklist parse error', err);
      }
      return getDefaultChecklistItems();
    }

    function saveChecklist() {
      try {
        localStorage.setItem(CHECKLIST_STORAGE_KEY, JSON.stringify(state.checklistItems || []));
      } catch (err) {
        console.error('localStorage checklist save error', err);
      }
    }

    function setState(partial) {
      state = Object.assign({}, state, partial);
      renderApp();
      attachEventListeners();
    }

    function resetForm() {
      state.form = getEmptyForm();
    }

    function generateId() {
      return (
        Date.now().toString(36) +
        Math.random().toString(36).slice(2, 10)
      );
    }

    function toTitleCase(text) {
      if (!text) return '';
      return text
        .toLowerCase()
        .split(' ')
        .filter(Boolean)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function hashString(str) {
      let hash = 0;
      const s = String(str || '');
      for (let i = 0; i < s.length; i++) {
        hash = (hash << 5) - hash + s.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function getCityGradientClass(city) {
      const idx = CITY_GRADIENTS.length ? hashString(city) % CITY_GRADIENTS.length : 0;
      return CITY_GRADIENTS[idx] || 'from-sky-500/70 to-sky-700/80';
    }

    function getCategoryMeta(id) {
      if (CATEGORY_META[id]) return CATEGORY_META[id];
      return CATEGORY_META.other;
    }

    function getMapsUrl(city, place) {
      const query = [city, place].filter(Boolean).join(' ');
      return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(query);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return parts[2] + '.' + parts[1] + '.' + parts[0];
      }
      return dateStr;
    }

    function formatAmount(amount) {
      const num = Number(amount || 0);
      return num.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
    }

    function getVisibleExpenses() {
      if (!state.filterCategory) return state.expenses.slice();
      return state.expenses.filter(exp => exp.category === state.filterCategory);
    }

    function getSelectedExpense() {
      if (!state.selectedExpenseId) return null;
      return state.expenses.find(e => e.id === state.selectedExpenseId) || null;
    }

    function groupExpensesByCity(expenses) {
      const groups = {};
      expenses.forEach(exp => {
        const city = exp.city || 'DiÄŸer';
        if (!groups[city]) groups[city] = [];
        groups[city].push(exp);
      });
      return groups;
    }

    function renderHeader() {
      return `
        <header class="flex items-center justify-between mb-4 md:mb-6 relative z-10">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-sky-500 to-indigo-500 border border-sky-300/70 flex items-center justify-center text-white shadow-md shadow-sky-500/40">
              ${ICONS.wallet}
            </div>
            <div>
              <h1 class="text-lg md:text-xl font-semibold tracking-tight text-slate-50">Seyahat CÃ¼zdanÄ±</h1>
              <p class="text-xs md:text-sm text-slate-300/90">Gezilerindeki tÃ¼m harcamalarÄ± ve hazÄ±rlÄ±klarÄ± tek yerden takip et</p>
            </div>
          </div>
          <button type="button" id="clear-all-btn" class="inline-flex items-center gap-1.5 px-3 py-2 rounded-xl text-xs font-medium bg-gradient-to-r from-rose-600/80 to-amber-500/80 text-white border border-rose-300/60 hover:from-rose-600 hover:to-amber-500 shadow-sm shadow-rose-500/40 transition">
            ${ICONS.trash}
            <span>HarcamalarÄ± Temizle</span>
          </button>
        </header>
      `;
    }

    function renderError(errorMsg) {
      if (!errorMsg) return '';
      return `
        <div class="mb-3 md:mb-4 rounded-2xl border border-amber-400/60 bg-gradient-to-r from-amber-500/20 via-amber-500/15 to-amber-500/25 px-3.5 py-2.5 text-xs md:text-sm text-amber-100 flex items-start gap-2">
          <div class="mt-[2px] text-amber-200">
            ${ICONS.warning}
          </div>
          <div>${escapeHtml(errorMsg)}</div>
        </div>
      `;
    }

    function renderSummaryCard(expenses) {
      if (!expenses || !expenses.length) {
        return `
          <section class="mb-4 md:mb-5">
            <div class="rounded-2xl bg-gradient-to-r from-slate-900/85 via-slate-800/85 to-slate-900/85 border border-slate-600/70 px-4 py-3.5 text-xs md:text-sm text-slate-100 flex items-center gap-2">
              <div class="text-sky-300">
                ${ICONS.info}
              </div>
              <div>HenÃ¼z harcama kaydÄ± yok. SaÄŸ alttaki <span class="font-semibold text-sky-300">+</span> butonuyla ilk harcamanÄ± ekle.</div>
            </div>
          </section>
        `;
      }

      const totalsByCurrency = {};
      expenses.forEach(exp => {
        const cur = exp.currency || 'TRY';
        const val = Number(exp.amount) || 0;
        if (!totalsByCurrency[cur]) totalsByCurrency[cur] = 0;
        totalsByCurrency[cur] += val;
      });

      const currencyChips = Object.entries(totalsByCurrency)
        .map(([cur, total]) => {
          const formatted = total.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
          return `
            <div class="flex items-baseline gap-1.5">
              <span class="text-xs text-sky-50/80">${cur}</span>
              <span class="text-sm md:text-base font-semibold text-white">${formatted}</span>
            </div>
          `;
        })
        .join('');

      return `
        <section class="mb-4 md:mb-5 relative z-10">
          <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-sky-500 via-indigo-500 to-emerald-500 border border-white/20 shadow-lg shadow-sky-500/40">
            <div class="absolute -right-16 -bottom-16 w-44 h-44 rounded-full bg-white/15 blur-3xl"></div>
            <div class="absolute -left-20 -top-16 w-40 h-40 rounded-full bg-indigo-400/25 blur-3xl"></div>
            <div class="relative px-4 py-3.5 md:px-5 md:py-4 flex items-center justify-between gap-3">
              <div>
                <p class="text-[11px] uppercase tracking-wide text-sky-50/90 font-semibold">Harcamalar Ã–zeti</p>
                <p class="text-xs md:text-sm text-sky-50/90">
                  ${expenses.length} kayÄ±t Â· ${Object.keys(totalsByCurrency).length} para birimi
                </p>
              </div>
              <div class="flex flex-col items-end text-right gap-0.5">
                ${currencyChips}
              </div>
            </div>
          </div>
        </section>
      `;
    }

    function renderChecklistSummaryCard() {
      const items = state.checklistItems || [];
      if (!items.length) {
        return `
          <section class="mb-3 md:mb-4">
            <div class="rounded-2xl bg-gradient-to-r from-slate-900/90 via-slate-900/85 to-slate-950/95 border border-slate-700/80 px-4 py-3.5 text-xs md:text-sm text-slate-100 flex items-center gap-2">
              <div class="text-emerald-300">
                ${ICONS.info}
              </div>
              <div>HenÃ¼z check list maddesi yok. AÅŸaÄŸÄ±dan seyahatte yanÄ±na alman gerekenleri listelemeye baÅŸlayabilirsin.</div>
            </div>
          </section>
        `;
      }
      const total = items.length;
      const done = items.filter(i => i.done).length;
      const percent = total ? Math.round((done * 100) / total) : 0;
      const width = percent + '%';

      return `
        <section class="mb-3 md:mb-4">
          <div class="rounded-2xl bg-gradient-to-r from-emerald-500 via-teal-500 to-sky-500 border border-emerald-300/80 px-4 py-3.5 text-xs md:text-sm text-emerald-50 shadow-lg shadow-emerald-500/40">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div>
                <p class="text-[11px] uppercase tracking-wide font-semibold opacity-90">Seyahat HazÄ±rlÄ±ÄŸÄ±</p>
                <p class="text-xs md:text-sm">
                  ${total} maddeden <span class="font-semibold">${done}</span> tanesi hazÄ±r.
                </p>
              </div>
              <div class="text-right">
                <div class="text-[11px] uppercase tracking-wide text-emerald-50/90">Tamamlanma</div>
                <div class="text-base font-semibold">${percent}%</div>
              </div>
            </div>
            <div class="h-1.5 rounded-full bg-emerald-900/40 overflow-hidden">
              <div class="h-full bg-emerald-300" style="width:${width};"></div>
            </div>
          </div>
        </section>
      `;
    }

    function renderTabs() {
      const isExpenses = state.activeTab === 'expenses';
      const base = 'flex-1 px-3 py-1.5 md:px-4 md:py-2 rounded-xl text-center text-xs md:text-sm font-medium transition border';
      const expClasses = isExpenses
        ? 'bg-slate-900 text-slate-50 border-slate-600 shadow-sm'
        : 'bg-transparent text-slate-400 border-transparent hover:bg-slate-900/40';
      const checkClasses = !isExpenses
        ? 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white border-emerald-300 shadow-sm shadow-emerald-500/40'
        : 'bg-transparent text-slate-400 border-transparent hover:bg-slate-900/40';

      return `
        <div class="mb-2.5 md:mb-3 flex items-center gap-2 bg-slate-900/60 rounded-2xl p-1 border border-slate-700/80">
          <button type="button" data-tab="expenses" class="${base} ${expClasses}">
            Harcamalar
          </button>
          <button type="button" data-tab="checklist" class="${base} ${checkClasses}">
            Check List
          </button>
        </div>
      `;
    }

    function renderFilterBar(allExpenses, visibleExpenses, selectedCategory) {
      const total = allExpenses.length;
      const visible = visibleExpenses.length;
      const filterText = selectedCategory
        ? `Kategori filtresi: ${getCategoryMeta(selectedCategory).label}`
        : 'Kategori filtresi yok';
      const disableChart = visible === 0;
      const options = Object.values(CATEGORY_META)
        .map(cat => `
          <option value="${cat.id}" ${selectedCategory === cat.id ? 'selected' : ''}>
            ${cat.label}
          </option>
        `)
        .join('');

      return `
        <div class="mb-3 md:mb-4 rounded-2xl bg-gradient-to-r from-slate-900/90 via-slate-900/85 to-slate-950/95 border border-slate-700/80 px-3.5 py-2.5 md:px-4 md:py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="text-xs md:text-sm text-slate-100/90">
            <span class="font-semibold text-sky-300">${visible}</span> kayÄ±t gÃ¶rÃ¼ntÃ¼leniyor
            <span class="text-slate-400"> Â· ${escapeHtml(filterText)}</span>
            ${total > visible ? `<span class="text-slate-500"> Â· Toplam ${total} kayÄ±t</span>` : ''}
          </div>
          <div class="flex items-center gap-2">
            <select id="category-filter" class="text-xs md:text-sm rounded-xl border border-slate-600 bg-slate-900/90 text-slate-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80">
              <option value="">TÃ¼m kategoriler</option>
              ${options}
            </select>
            <button type="button" id="open-chart-modal-btn" ${disableChart ? 'disabled' : ''} class="inline-flex items-center gap-1.5 text-xs md:text-sm px-3 py-2 rounded-xl bg-gradient-to-r from-sky-600/90 to-indigo-600/90 border border-sky-400/70 text-sky-50 hover:from-sky-500 hover:to-indigo-500 disabled:opacity-40 disabled:cursor-not-allowed shadow-sm shadow-sky-500/40">
              ${ICONS.chart}
              <span>GrafiÄŸi GÃ¶ster</span>
            </button>
          </div>
        </div>
      `;
    }

    function renderCategoryToolbox(selectedCategory) {
      const cats = Object.values(CATEGORY_META);
      const buttons = cats
        .map(cat => {
          const isActive = selectedCategory === cat.id;
          const baseClasses =
            'flex flex-shrink-0 flex-col items-center justify-center gap-1 px-2.5 py-2.5 rounded-2xl border text-[11px] cursor-pointer transition min-w-[88px]';
          const activeClasses =
            'bg-gradient-to-r from-sky-600 to-indigo-600 border-sky-300/70 text-sky-50 shadow-sm shadow-sky-500/40';
          const inactiveClasses =
            'bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 border-slate-700 text-slate-200 hover:border-sky-500/60 hover:bg-slate-900';
          const accent = cat.accent || 'bg-slate-800/90 text-sky-100';
          return `
            <button type="button" data-category="${cat.id}" class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}">
              <span class="shrink-0 w-8 h-8 inline-flex items-center justify-center rounded-2xl ${accent}">
                ${cat.icon}
              </span>
              <span class="truncate mt-0.5">${cat.label}</span>
            </button>
          `;
        })
        .join('');
      return `
        <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-thin">
          ${buttons}
        </div>
      `;
    }

    function renderPhotoThumbnails(form) {
      const photos = form.photos || [];
      if (!photos.length) {
        return '<p class="text-[11px] text-slate-400 italic">HenÃ¼z fotoÄŸraf seÃ§ilmedi.</p>';
      }
      let html = '<div class="grid grid-cols-3 gap-2">';
      photos.forEach((src, idx) => {
        html += `
          <div class="relative group">
            <img src="${src}" alt="FotoÄŸraf ${idx + 1}" class="w-full h-20 object-cover rounded-xl border border-slate-600/70" />
            <button type="button" data-remove-photo="${idx}" class="absolute -top-1.5 -right-1.5 inline-flex items-center justify-center w-5 h-5 rounded-full bg-black/80 text-slate-100 opacity-0 group-hover:opacity-100 transition">
              ${ICONS.xMini}
            </button>
          </div>
        `;
      });
      html += '</div>';
      return html;
    }

    function renderExpenseCard(expense) {
      const category = getCategoryMeta(expense.category);
      const dateLabel = formatDate(expense.date);
      const photosCount = (expense.photos && expense.photos.length) ? expense.photos.length : 0;
      const peopleCount = expense.peopleCount ? Number(expense.peopleCount) : 0;
      const peopleChip = peopleCount
        ? `
          <span class="inline-flex items-center gap-1 text-[11px] text-slate-700 bg-slate-100/90 px-1.5 py-0.5 rounded-full">
            ${ICONS.person}
            <span>x${peopleCount}</span>
          </span>
        `
        : '';
      const photosChip = photosCount
        ? `
          <span class="inline-flex items-center gap-1 text-[11px] text-slate-700 bg-slate-100/90 px-1.5 py-0.5 rounded-full">
            ${ICONS.photo}
            <span>${photosCount}</span>
          </span>
        `
        : '';

      return `
        <article class="bg-gradient-to-br from-slate-50 via-slate-100 to-slate-50 rounded-2xl shadow-sm border border-slate-200/90 px-3.5 py-3 md:px-4 md:py-3.5 cursor-pointer hover:shadow-md hover:-translate-y-[1px] transition" data-expense-id="${escapeHtml(expense.id)}">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              <div class="text-[11px] font-medium uppercase tracking-wide text-sky-500 mb-0.5">
                ${escapeHtml(expense.city || '')}
              </div>
              <div class="text-sm md:text-base font-semibold text-slate-900 truncate">
                ${expense.place ? escapeHtml(expense.place) : '<span class="text-slate-400">BaÅŸlÄ±ksÄ±z</span>'}
              </div>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[11px] font-medium ${category.bgClass}">
                  <span class="shrink-0">${category.icon}</span>
                  <span>${category.label}</span>
                </span>
                <span class="inline-flex items-center gap-1 text-[11px] text-slate-500">
                  ${ICONS.calendar}
                  <span>${dateLabel}</span>
                </span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <div class="text-sm md:text-base font-semibold text-slate-900">
                ${formatAmount(expense.amount)} <span class="text-xs text-slate-500 ml-0.5">${escapeHtml(expense.currency || '')}</span>
              </div>
              <div class="flex items-center gap-2 mt-1">
                ${peopleChip}
                ${photosChip}
              </div>
            </div>
          </div>
        </article>
      `;
    }

    function renderCityExpenses(expensesInCity) {
      const sorted = expensesInCity.slice().sort((a, b) => {
        const da = a.date || '';
        const db = b.date || '';
        return db.localeCompare(da);
      });
      return sorted.map(exp => renderExpenseCard(exp)).join('');
    }

    function renderCitySection(city, expensesInCity) {
      const isExpanded = state.expandedCities[city] !== false;
      const gradientClass = getCityGradientClass(city);

      const totalsByCurrency = {};
      expensesInCity.forEach(exp => {
        const cur = exp.currency || 'TRY';
        const val = Number(exp.amount) || 0;
        if (!totalsByCurrency[cur]) totalsByCurrency[cur] = 0;
        totalsByCurrency[cur] += val;
      });
      const summaryParts = Object.entries(totalsByCurrency)
        .map(([cur, total]) => total.toLocaleString('tr-TR', { maximumFractionDigits: 1 }) + ' ' + cur)
        .join(' Â· ');
      const summaryText = summaryParts ? ' Â· ' + summaryParts : '';

      return `
        <div class="mb-3 md:mb-4">
          <button type="button" data-city-toggle="${escapeHtml(city)}" class="w-full text-left bg-gradient-to-r ${gradientClass} p-[1px] rounded-2xl shadow-sm hover:shadow-lg hover:-translate-y-[1px] transition">
            <div class="relative flex items-center justify-between gap-3 px-3.5 py-2.5 bg-slate-950/85 rounded-[1rem]">
              <div>
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-50">
                  ${escapeHtml(city)}
                </div>
                <div class="text-[11px] text-slate-200">
                  ${expensesInCity.length} kayÄ±t${summaryText}
                </div>
              </div>
              <div class="flex flex-col items-end gap-1">
                <div class="w-8 h-8 rounded-2xl bg-slate-900/80 border border-sky-400/70 flex items-center justify-center text-sky-300 shadow-sm shadow-sky-500/40">
                  ${ICONS.locationPin}
                </div>
                <div class="flex items-center gap-2">
                  <div class="hidden md:flex flex-col text-right text-[10px] text-slate-100/90">
                    <span>DetaylarÄ± ${isExpanded ? 'gizle' : 'gÃ¶ster'}</span>
                  </div>
                  <div class="w-7 h-7 rounded-full bg-slate-900/80 border border-white/30 flex items-center justify-center text-slate-50">
                    ${isExpanded ? ICONS.chevronUp : ICONS.chevronDown}
                  </div>
                </div>
              </div>
            </div>
          </button>
          ${isExpanded ? `<div class="mt-2 space-y-2.5 md:space-y-3">${renderCityExpenses(expensesInCity)}</div>` : ''}
        </div>
      `;
    }

    function renderExpenseList(expenses) {
      if (!expenses || !expenses.length) {
        return `
          <div class="rounded-2xl bg-gradient-to-br from-slate-900/85 via-slate-900/90 to-slate-950/95 border border-slate-700/80 px-4 py-5 text-center text-sm text-slate-100">
            HenÃ¼z hiÃ§ harcama eklenmedi.<br/>
            SaÄŸ alttaki <span class="font-semibold text-sky-300">+</span> butonuna tÄ±klayarak ilk kaydÄ±nÄ± oluÅŸtur.
          </div>
        `;
      }

      const groups = groupExpensesByCity(expenses);
      const entries = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0], 'tr'));

      let html = '<div class="space-y-4 md:space-y-5 pb-2">';
      entries.forEach(([city, exps]) => {
        html += renderCitySection(city, exps);
      });
      html += '</div>';
      return html;
    }

    function renderFormView() {
      const f = state.form;
      return `
        <section class="mt-3 md:mt-4">
          <div class="mb-3 md:mb-4 flex items-center justify-between">
            <div>
              <h2 class="text-base md:text-lg font-semibold text-slate-50">Harcama KaydÄ±</h2>
              <p class="text-xs md:text-sm text-slate-400">${f.id ? 'Mevcut kaydÄ± dÃ¼zenliyorsun' : 'Yeni bir harcama ekle'}</p>
            </div>
            <button type="button" id="back-to-list-btn" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl bg-slate-900/80 border border-slate-600 text-xs text-slate-200 hover:bg-slate-900">
              ${ICONS.x}
              <span>Listeye DÃ¶n</span>
            </button>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-slate-950/95 via-slate-900/95 to-slate-950/95 border border-slate-700/80 px-3.5 py-3.5 md:px-4 md:py-4">
            <form id="expense-form" class="space-y-4 md:space-y-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label for="city" class="block text-xs font-medium text-slate-300 mb-1.5">Åžehir</label>
                  <input id="city" type="text" autocomplete="off" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/80 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80" placeholder="Ã–rn. Sevilla" value="${escapeHtml(f.city)}" />
                </div>
                <div>
                  <label for="place" class="block text-xs font-medium text-slate-300 mb-1.5">Mekan / BaÅŸlÄ±k</label>
                  <input id="place" type="text" autocomplete="off" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/80 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80" placeholder="Ã–rn. Kahve MolasÄ±" value="${escapeHtml(f.place)}" />
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="col-span-2 md:col-span-1">
                  <label for="amount" class="block text-xs font-medium text-slate-300 mb-1.5">Tutar</label>
                  <input id="amount" type="text" inputmode="decimal" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/80 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80" placeholder="0.00" value="${escapeHtml(f.amount)}" />
                </div>
                <div class="col-span-1 md:col-span-1">
                  <label for="currency" class="block text-xs font-medium text-slate-300 mb-1.5">Para Birimi</label>
                  <select id="currency" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/80 px-2.5 py-2.5 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80">
                    ${['TRY','EUR','USD','GBP'].map(cur => `
                      <option value="${cur}" ${f.currency === cur ? 'selected' : ''}>${cur}</option>
                    `).join('')}
                  </select>
                </div>
                <div class="col-span-1 md:col-span-1">
                  <label for="peopleCount" class="block text-xs font-medium text-slate-300 mb-1.5">KiÅŸi SayÄ±sÄ±</label>
                  <input id="peopleCount" type="number" min="1" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/80 px-2.5 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80" value="${escapeHtml(f.peopleCount)}" />
                </div>
                <div class="col-span-2 md:col-span-1">
                  <label for="date" class="block text-xs font-medium text-slate-300 mb-1.5">Tarih</label>
                  <input id="date" type="date" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/80 px-3 py-2.5 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80" value="${escapeHtml(f.date)}" />
                </div>
              </div>

              <div>
                <span class="block text-xs font-medium text-slate-300 mb-1.5">Kategori</span>
                ${renderCategoryToolbox(f.category)}
              </div>

              <div>
                <label for="description" class="block text-xs font-medium text-slate-300 mb-1.5">AÃ§Ä±klama</label>
                <textarea id="description" rows="3" class="w-full rounded-2xl border border-slate-700/70 bg-slate-900/80 px-3 py-2.5 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/80 focus:border-sky-500/80" placeholder="Notlar, detaylar...">${escapeHtml(f.description)}</textarea>
              </div>

              <div>
                <label class="block text-xs font-medium text-slate-300 mb-1.5">FotoÄŸraflar (max 3)</label>
                <div class="flex flex-col md:flex-row md:items-center gap-3">
                  <div>
                    <input type="file" id="photo-input" accept="image/*" multiple class="block text-xs text-slate-300 file:mr-3 file:py-2 file:px-3 file:rounded-2xl file:border-0 file:text-xs file:font-medium file:bg-gradient-to-r file:from-sky-600 file:to-indigo-600 file:text-white hover:file:from-sky-500 hover:file:to-indigo-500 cursor-pointer" />
                    <p class="mt-1 text-[11px] text-slate-400">FotoÄŸraflar otomatik olarak sÄ±kÄ±ÅŸtÄ±rÄ±lÄ±p base64 olarak kaydedilir.</p>
                  </div>
                  <div class="flex-1">
                    ${renderPhotoThumbnails(f)}
                  </div>
                </div>
              </div>

              <div class="pt-2 flex items-center justify-between gap-3">
                <button type="button" id="close-form-btn" class="inline-flex items-center justify-center px-3.5 py-2.5 rounded-2xl bg-slate-900/80 border border-slate-600 text-xs md:text-sm text-slate-200 hover:bg-slate-900">
                  Ä°ptal
                </button>
                <button type="submit" id="save-expense-btn" class="inline-flex items-center justify-center px-4 py-2.5 rounded-2xl bg-gradient-to-r from-sky-600 to-indigo-600 text-xs md:text-sm font-medium text-white shadow-md shadow-sky-500/40 hover:from-sky-500 hover:to-indigo-500">
                  ${ICONS.walletMini}
                  <span class="ml-1.5">${f.id ? 'KaydÄ± GÃ¼ncelle' : 'Kaydet'}</span>
                </button>
              </div>
            </form>
          </div>
        </section>
      `;
    }

    function renderDetailModal(expense) {
      if (!expense) return '';
      const category = getCategoryMeta(expense.category);
      const dateLabel = formatDate(expense.date);
      const amountFormatted = formatAmount(expense.amount);
      const currency = escapeHtml(expense.currency || '');
      const peopleCount = expense.peopleCount ? Number(expense.peopleCount) : 0;
      const perPerson = peopleCount ? (Number(expense.amount) / peopleCount) : null;
      const perPersonFormatted = perPerson ? perPerson.toLocaleString('tr-TR', { maximumFractionDigits: 2 }) : null;
      const mapsUrl = getMapsUrl(expense.city, expense.place);
      const photos = expense.photos || [];
      const headerGradient = category.headerGradient || 'from-sky-500 via-indigo-500 to-emerald-500';

      let photosHtml = '';
      if (photos.length) {
        photosHtml = '<div class="mt-4"><h4 class="text-xs font-semibold text-slate-700 mb-2 flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span><span>FotoÄŸraflar</span></h4><div class="grid grid-cols-2 gap-2">';
        photos.forEach((src, idx) => {
          photosHtml += `
            <div class="overflow-hidden rounded-2xl border border-slate-200 bg-slate-100/60">
              <img src="${src}" alt="FotoÄŸraf ${idx + 1}" class="w-full h-28 object-cover" />
            </div>
          `;
        });
        photosHtml += '</div></div>';
      }

      const peopleInfo = peopleCount ? `
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div class="rounded-2xl bg-slate-50 border border-slate-200 px-3 py-2 flex items-center justify-between text-xs text-slate-700">
            <span class="inline-flex items-center gap-1">
              ${ICONS.person}
              <span>KiÅŸi sayÄ±sÄ±</span>
            </span>
            <span class="font-semibold text-slate-900">${peopleCount}</span>
          </div>
          <div class="rounded-2xl bg-gradient-to-r from-sky-50 to-emerald-50 border border-sky-200 px-3 py-2 flex items-center justify-between text-xs text-slate-700">
            <span class="inline-flex items-center gap-1">
              ${ICONS.walletMini}
              <span>KiÅŸi baÅŸÄ±</span>
            </span>
            <span class="font-semibold text-slate-900">${perPersonFormatted} <span class="text-[11px] text-slate-500">${currency}</span></span>
          </div>
        </div>
      ` : '';

      return `
        <div id="detail-modal-overlay" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6 bg-black/60 backdrop-blur-sm">
          <div id="detail-modal" class="relative w-full max-w-md max-h-[85vh] overflow-y-auto scrollbar-thin bg-gradient-to-br from-slate-50 via-white to-slate-50 rounded-3xl shadow-2xl border border-slate-200/70 p-0">
            <div class="relative overflow-hidden rounded-t-3xl bg-gradient-to-r ${headerGradient} px-5 pt-4 pb-5">
              <div class="absolute -right-16 -bottom-20 w-40 h-40 rounded-full bg-white/15 blur-2xl"></div>
              <div class="absolute -left-12 -top-16 w-36 h-36 rounded-full bg-indigo-300/25 blur-2xl"></div>
              <div class="relative flex items-start justify-between gap-3">
                <div class="max-w-[70%]">
                  <p class="text-[11px] font-medium uppercase tracking-wide text-slate-100/90 mb-0.5">
                    ${escapeHtml(expense.city || '')}
                  </p>
                  <h2 class="text-base md:text-lg font-semibold text-white leading-snug">
                    ${expense.place ? escapeHtml(expense.place) : 'Harcama DetayÄ±'}
                  </h2>
                  <div class="mt-2 inline-flex items-center gap-1.5 text-[11px] text-slate-100/90 bg-black/20 px-2 py-1 rounded-full">
                    ${ICONS.calendar}
                    <span>${dateLabel}</span>
                  </div>
                </div>
                <button type="button" id="close-detail-modal-btn" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-black/25 text-slate-50 hover:bg-black/35">
                  ${ICONS.x}
                </button>
              </div>
              <div class="relative mt-3 flex items-center justify-between gap-3">
                <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[11px] font-medium bg-white/90 text-slate-800">
                  <span class="shrink-0 text-sky-500">${category.icon}</span>
                  <span>${category.label}</span>
                </div>
                <div class="text-right">
                  <div class="text-[11px] text-slate-100/90">Toplam Tutar</div>
                  <div class="text-lg font-semibold text-white">
                    ${amountFormatted} <span class="text-xs text-slate-100/80">${currency}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="px-5 pb-5 pt-4">
              ${peopleInfo}

              <div class="mt-4 rounded-2xl bg-slate-50 border border-slate-200 px-3.5 py-3">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex items-start gap-2">
                    <div class="mt-[2px] text-slate-500">
                      ${ICONS.locationPin}
                    </div>
                    <div class="text-xs text-slate-700">
                      <div class="font-semibold text-slate-900">${escapeHtml(expense.city || '')}</div>
                      ${expense.place ? `<div class="text-slate-600">${escapeHtml(expense.place)}</div>` : ''}
                    </div>
                  </div>
                  <a href="${mapsUrl}" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-2xl bg-sky-50 text-[11px] font-medium text-sky-700 border border-sky-200 hover:bg-sky-100">
                    ${ICONS.map}
                    <span>Haritada AÃ§</span>
                  </a>
                </div>
              </div>

              ${expense.description ? `
                <div class="mt-4 rounded-2xl bg-slate-50 border border-slate-200 px-3.5 py-3">
                  <h4 class="text-xs font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
                    <span>Notlar</span>
                  </h4>
                  <p class="text-sm text-slate-600 whitespace-pre-line">${escapeHtml(expense.description)}</p>
                </div>
              ` : ''}

              ${photosHtml}

              <div class="mt-5 flex items-center justify-between gap-3">
                <button type="button" id="edit-expense-btn" class="flex-1 inline-flex items-center justify-center px-3.5 py-2.5 rounded-2xl bg-slate-900 text-xs md:text-sm font-medium text-slate-50 border border-slate-900 hover:bg-slate-800">
                  ${ICONS.edit}
                  <span class="ml-1.5">DÃ¼zenle</span>
                </button>
                <button type="button" id="delete-expense-btn" class="inline-flex items-center justify-center px-3.5 py-2.5 rounded-2xl bg-gradient-to-r from-rose-600 to-red-600 text-xs md:text-sm font-medium text-white shadow-md shadow-rose-500/40 hover:from-rose-500 hover:to-red-600">
                  ${ICONS.trash}
                  <span class="ml-1.5">Sil</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderConfirmClearModal() {
      return `
        <div id="confirm-clear-modal" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6 bg-black/60 backdrop-blur-sm">
          <div class="w-full max-w-sm bg-gradient-to-br from-slate-950 via-rose-950/90 to-slate-950 border border-rose-500/60 rounded-3xl p-5 shadow-xl shadow-rose-500/30">
            <div class="flex items-start gap-3">
              <div class="mt-1 text-rose-300">
                ${ICONS.warning}
              </div>
              <div>
                <h3 class="text-sm font-semibold text-rose-50 mb-1">TÃ¼m harcamalarÄ± silmek istiyor musun?</h3>
                <p class="text-xs text-rose-100/90 mb-3">
                  Bu iÅŸlem geri alÄ±namaz. TÃ¼m harcamalar ve fotoÄŸraflar cihazÄ±ndaki localStorage'dan temizlenecek.
                </p>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-end gap-2">
              <button type="button" id="cancel-clear-all-btn" class="px-3 py-1.5 rounded-2xl bg-slate-900/80 text-xs text-slate-100 border border-slate-600 hover:bg-slate-900">
                VazgeÃ§
              </button>
              <button type="button" id="confirm-clear-all-btn" class="px-3 py-1.5 rounded-2xl bg-gradient-to-r from-rose-600 to-red-600 text-xs text-white hover:from-rose-500 hover:to-red-600">
                Evet, sil
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderChartModal() {
      return `
        <div id="chart-modal-overlay" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6 bg-black/60 backdrop-blur-sm">
          <div id="chart-modal" class="w-full max-w-md max-h-[80vh] bg-gradient-to-br from-slate-50 via-white to-slate-50 rounded-3xl shadow-2xl flex flex-col border border-slate-200/80">
            <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100">
              <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-sky-500 to-indigo-500 text-white flex items-center justify-center shadow-sm shadow-sky-500/40">
                  ${ICONS.chart}
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-slate-900">Harcama DaÄŸÄ±lÄ±mÄ±</h3>
                  <p class="text-[11px] text-slate-500">Kategorilere gÃ¶re toplam tutarlarÄ±n daÄŸÄ±lÄ±mÄ±</p>
                </div>
              </div>
              <button type="button" id="close-chart-modal-btn" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200">
                ${ICONS.x}
              </button>
            </div>
            <div class="px-5 pt-4 pb-5 flex-1 flex flex-col">
              <div class="relative h-40 md:h-52">
                <canvas id="expenseChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderFab() {
      return `
        <button id="add-expense-fab" class="fixed bottom-6 right-6 z-30 inline-flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-sky-500 to-indigo-500 text-white shadow-xl shadow-sky-500/40 hover:from-sky-400 hover:to-indigo-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 focus:ring-offset-slate-900">
          ${ICONS.plus}
        </button>
      `;
    }

    function renderChecklistCategorySection(cat, itemsInCat) {
      const total = itemsInCat.length;
      const done = itemsInCat.filter(i => i.done).length;
      const hasItems = total > 0;
      const progressText = hasItems ? `${done} / ${total} tamamlandÄ±` : 'HenÃ¼z madde yok';
      const itemsHtml = hasItems
        ? itemsInCat.map(item => `
            <label class="flex items-center gap-2 text-xs text-slate-100">
              <input type="checkbox" data-check-item-id="${item.id}"
                     class="h-4 w-4 rounded border-slate-500 bg-slate-950 text-emerald-400 focus:ring-emerald-500/70"
                     ${item.done ? 'checked' : ''} />
              <span class="${item.done ? 'line-through text-slate-500' : ''}">
                ${escapeHtml(item.label)}
              </span>
            </label>
          `).join('')
        : `<p class="text-[11px] text-slate-500 italic">Bu kategoride henÃ¼z madde yok.</p>`;

      return `
        <div class="rounded-2xl bg-slate-900/85 border border-slate-700/80 px-3.5 py-3.5">
          <div class="flex items-center justify-between mb-2.5">
            <div class="flex items-center gap-2">
              <div class="w-7 h-7 rounded-xl bg-slate-950 border border-slate-700 flex items-center justify-center text-base">
                ${cat.icon}
              </div>
              <div>
                <div class="text-xs font-semibold text-slate-50">${cat.label}</div>
                <div class="text-[11px] text-slate-400">${progressText}</div>
              </div>
            </div>
            <button type="button" data-check-all-category="${cat.id}"
                    class="text-[11px] text-slate-200 px-2 py-1 rounded-xl bg-slate-800/80 border border-slate-600 hover:bg-slate-700/90 ${hasItems ? '' : 'opacity-40 cursor-default'}"
                    ${hasItems ? '' : 'disabled'}>
              Hepsini iÅŸaretle
            </button>
          </div>
          <div class="space-y-1.5">
            ${itemsHtml}
          </div>
        </div>
      `;
    }

    function renderChecklistView() {
      const items = state.checklistItems || [];
      const categories = Object.values(CHECKLIST_META);

      let html = `
        <section class="mt-3 md:mt-4">
          <div class="rounded-2xl bg-gradient-to-br from-slate-950/95 via-slate-900/95 to-slate-950/95 border border-slate-700/80 px-3.5 py-3.5 md:px-4 md:py-4">
            <div class="space-y-3 md:space-y-4">
      `;
      categories.forEach(cat => {
        const itemsInCat = items.filter(item => item.category === cat.id);
        html += renderChecklistCategorySection(cat, itemsInCat);
      });

      html += `
              <div class="mt-2 rounded-2xl bg-slate-950/90 border border-slate-700/80 px-3.5 py-3.5 space-y-2">
                <div class="text-xs font-medium text-slate-200 mb-1 flex items-center gap-1.5">
                  <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                  <span>Yeni madde ekle</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <input id="new-check-label" type="text" placeholder="Ã–rn. Powerbank"
                         class="col-span-2 rounded-2xl bg-slate-900/90 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/80 focus:border-emerald-500/80" />
                  <select id="new-check-category"
                          class="col-span-1 rounded-2xl bg-slate-900/90 border border-slate-700 px-2 py-2 text-xs text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/80 focus:border-emerald-500/80">
                    ${Object.values(CHECKLIST_META).map(cat => `<option value="${cat.id}">${cat.label}</option>`).join('')}
                  </select>
                </div>
                <div class="flex justify-end">
                  <button type="button" id="add-check-item-btn"
                          class="mt-2 inline-flex items-center justify-center px-3.5 py-2 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-500 text-[11px] font-medium text-white shadow-sm shadow-emerald-500/40 hover:from-emerald-400 hover:to-teal-500">
                    + Madde Ekle
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      `;
      return html;
    }

    function renderApp() {
      const root = document.getElementById('app-root');
      if (!root) return;

      const visibleExpenses = getVisibleExpenses();

      let html = `
        <div class="relative bg-gradient-to-br from-slate-950/95 via-slate-900/95 to-slate-950/95 border border-white/10 backdrop-blur-xl rounded-3xl shadow-[0_24px_80px_rgba(15,23,42,0.9)] p-4 md:p-5 overflow-hidden">
          <div class="pointer-events-none absolute -top-24 -right-10 w-56 h-56 rounded-full bg-sky-500/20 blur-3xl"></div>
          <div class="pointer-events-none absolute -bottom-24 -left-10 w-60 h-60 rounded-full bg-indigo-500/20 blur-3xl"></div>
          <div class="relative z-10">
            ${renderHeader()}
            ${renderError(state.error)}
            ${
              state.activeTab === 'expenses'
                ? renderSummaryCard(state.expenses)
                : renderChecklistSummaryCard()
            }
            ${renderTabs()}
            ${
              state.activeTab === 'expenses'
                ? (
                    state.view === 'list'
                      ? `
                        ${renderFilterBar(state.expenses, visibleExpenses, state.filterCategory)}
                        ${renderExpenseList(visibleExpenses)}
                      `
                      : `${renderFormView()}`
                  )
                : renderChecklistView()
            }
          </div>
        </div>
        ${state.activeTab === 'expenses' && state.view === 'list' ? renderFab() : ''}
        ${state.showDetailModal ? renderDetailModal(getSelectedExpense()) : ''}
        ${state.showConfirmClear ? renderConfirmClearModal() : ''}
        ${state.showChartModal ? renderChartModal() : ''}
      `;

      root.innerHTML = html;
    }

    function resizeImageToDataURL(file) {
      const maxSize = 1280;
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) {
                height = Math.round((height * maxSize) / width);
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = Math.round((width * maxSize) / height);
                height = maxSize;
              }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            resolve(dataUrl);
          };
          img.onerror = (e) => reject(e);
          img.src = event.target.result;
        };
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
    }

    function handlePhotoInputChange(e) {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const existingPhotos = state.form.photos || [];
      const remainingSlots = 3 - existingPhotos.length;
      if (remainingSlots <= 0) {
        setState({ error: 'En fazla 3 fotoÄŸraf ekleyebilirsin.' });
        e.target.value = '';
        return;
      }
      const filesToUse = files.slice(0, remainingSlots);
      if (files.length > remainingSlots) {
        setState({ error: 'En fazla 3 fotoÄŸraf ekleyebilirsin. Fazladan seÃ§ilenler alÄ±nmadÄ±.' });
      }
      Promise.all(filesToUse.map(resizeImageToDataURL))
        .then((newPhotos) => {
          const nextPhotos = existingPhotos.concat(newPhotos);
          const newForm = Object.assign({}, state.form, { photos: nextPhotos });
          state.form = newForm;
          setState({ form: newForm, error: '' });
        })
        .catch((err) => {
          console.error(err);
          setState({ error: 'FotoÄŸraflar iÅŸlenirken bir hata oluÅŸtu.' });
        })
        .finally(() => {
          e.target.value = '';
        });
    }

    function renderExpenseChart() {
      const canvas = document.getElementById('expenseChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const expenses = getVisibleExpenses();
      if (!expenses.length) return;

      const totals = {};
      expenses.forEach(exp => {
        const catId = exp.category || 'other';
        const amount = Number(exp.amount) || 0;
        if (!amount) return;
        if (!totals[catId]) totals[catId] = 0;
        totals[catId] += amount;
      });
      const catIds = Object.keys(totals);
      if (!catIds.length) return;

      const labels = catIds.map(id => getCategoryMeta(id).label);
      const data = catIds.map(id => totals[id]);
      const colors = catIds.map(id => getCategoryMeta(id).chartColor);

      if (expenseChartInstance) {
        expenseChartInstance.destroy();
        expenseChartInstance = null;
      }

      expenseChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: colors,
              borderWidth: 1,
              borderColor: 'rgba(15,23,42,0.08)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#0f172a',
                font: { size: 11 }
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  return label + ': ' + value.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
                }
              }
            }
          }
        }
      });
    }

    function openNewExpenseForm() {
      resetForm();
      setState({
        view: 'form',
        selectedExpenseId: null,
        showDetailModal: false,
        error: '',
        activeTab: 'expenses'
      });
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const f = state.form;

      const trimmedCity = (f.city || '').trim();
      const trimmedPlace = (f.place || '').trim();
      const amountNum = parseFloat(f.amount);
      const peopleNum = parseInt(f.peopleCount || '1', 10) || 1;

      const errors = [];
      if (!trimmedCity) errors.push('Åžehir alanÄ± zorunludur.');
      if (!trimmedPlace) errors.push('Mekan / baÅŸlÄ±k alanÄ± zorunludur.');
      if (!f.date) errors.push('Tarih seÃ§melisin.');
      if (!f.currency) errors.push('Para birimi seÃ§melisin.');
      if (!f.category) errors.push('Kategori seÃ§melisin.');
      if (!amountNum || amountNum <= 0) errors.push('Tutar 0\'dan bÃ¼yÃ¼k olmalÄ±dÄ±r.');

      if (errors.length) {
        setState({ error: errors[0] });
        return;
      }

      const normalizedCity = toTitleCase(trimmedCity);
      const normalizedPlace = toTitleCase(trimmedPlace);

      const expense = {
        id: f.id || generateId(),
        city: normalizedCity,
        place: normalizedPlace,
        amount: amountNum,
        currency: f.currency,
        date: f.date,
        category: f.category,
        description: (f.description || '').trim(),
        peopleCount: peopleNum,
        photos: (f.photos || []).slice()
      };

      let newExpenses;
      if (f.id) {
        newExpenses = state.expenses.map(exp => exp.id === f.id ? Object.assign({}, exp, expense) : exp);
      } else {
        newExpenses = state.expenses.concat(expense);
      }
      state.expenses = newExpenses;

      const newExpanded = Object.assign({}, state.expandedCities, { [normalizedCity]: true });
      state.expandedCities = newExpanded;

      saveExpenses();
      resetForm();
      setState({
        view: 'list',
        error: '',
        activeTab: 'expenses'
      });
    }

    function handleDeleteExpense() {
      const exp = getSelectedExpense();
      if (!exp) return;
      const filtered = state.expenses.filter(e => e.id !== exp.id);
      state.expenses = filtered;
      const remainingForCity = filtered.filter(e => e.city === exp.city);
      const expanded = Object.assign({}, state.expandedCities);
      if (!remainingForCity.length && expanded.hasOwnProperty(exp.city)) {
        delete expanded[exp.city];
      }
      state.expandedCities = expanded;
      saveExpenses();
      setState({
        showDetailModal: false,
        selectedExpenseId: null,
        error: ''
      });
    }

    function addChecklistItem() {
      const labelInput = document.getElementById('new-check-label');
      const categorySelect = document.getElementById('new-check-category');
      if (!labelInput) return;
      const label = (labelInput.value || '').trim();
      const category = categorySelect ? (categorySelect.value || 'other') : 'other';
      if (!label) {
        setState({ error: 'LÃ¼tfen eklenecek maddenin adÄ±nÄ± yaz.' });
        return;
      }
      const newItem = {
        id: generateId(),
        label,
        category,
        done: false
      };
      const newItems = (state.checklistItems || []).concat(newItem);
      state.checklistItems = newItems;
      saveChecklist();
      labelInput.value = '';
      setState({ checklistItems: newItems, error: '' });
    }

    function attachEventListeners() {
      const categoryFilter = document.getElementById('category-filter');
      if (categoryFilter) {
        categoryFilter.addEventListener('change', (e) => {
          setState({ filterCategory: e.target.value });
        });
      }

      const openChartBtn = document.getElementById('open-chart-modal-btn');
      if (openChartBtn) {
        openChartBtn.addEventListener('click', () => {
          if (getVisibleExpenses().length === 0) return;
          setState({ showChartModal: true });
        });
      }

      const closeChartBtn = document.getElementById('close-chart-modal-btn');
      if (closeChartBtn) {
        closeChartBtn.addEventListener('click', () => {
          if (expenseChartInstance) {
            expenseChartInstance.destroy();
            expenseChartInstance = null;
          }
          setState({ showChartModal: false });
        });
      }

      const chartOverlay = document.getElementById('chart-modal-overlay');
      if (chartOverlay) {
        chartOverlay.addEventListener('click', (e) => {
          if (e.target === chartOverlay) {
            if (expenseChartInstance) {
              expenseChartInstance.destroy();
              expenseChartInstance = null;
            }
            setState({ showChartModal: false });
          }
        });
      }

      const chartCanvas = document.getElementById('expenseChart');
      if (chartCanvas && state.showChartModal) {
        renderExpenseChart();
      }

      const clearBtn = document.getElementById('clear-all-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          setState({ showConfirmClear: true });
        });
      }

      const confirmClearBtn = document.getElementById('confirm-clear-all-btn');
      if (confirmClearBtn) {
        confirmClearBtn.addEventListener('click', () => {
          clearAllExpenses();
          setState({ showConfirmClear: false, error: '' });
        });
      }

      const cancelClearBtn = document.getElementById('cancel-clear-all-btn');
      if (cancelClearBtn) {
        cancelClearBtn.addEventListener('click', () => {
          setState({ showConfirmClear: false });
        });
      }

      const fab = document.getElementById('add-expense-fab');
      if (fab) {
        fab.addEventListener('click', () => {
          openNewExpenseForm();
        });
      }

      const backBtn = document.getElementById('back-to-list-btn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          resetForm();
          setState({ view: 'list', error: '', activeTab: 'expenses' });
        });
      }

      const closeFormBtn = document.getElementById('close-form-btn');
      if (closeFormBtn) {
        closeFormBtn.addEventListener('click', () => {
          resetForm();
          setState({ view: 'list', error: '', activeTab: 'expenses' });
        });
      }

      const formEl = document.getElementById('expense-form');
      if (formEl) {
        formEl.addEventListener('submit', handleFormSubmit);
      }

      const cityInput = document.getElementById('city');
      if (cityInput) {
        cityInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { city: e.target.value });
        });
      }

      const placeInput = document.getElementById('place');
      if (placeInput) {
        placeInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { place: e.target.value });
        });
      }

      const amountInput = document.getElementById('amount');
      if (amountInput) {
        amountInput.addEventListener('input', (e) => {
          let val = e.target.value || '';
          val = val.replace(',', '.');
          val = val.replace(/[^0-9.]/g, '');
          const parts = val.split('.');
          if (parts.length > 2) {
            val = parts[0] + '.' + parts.slice(1).join('');
          }
          e.target.value = val;
          state.form = Object.assign({}, state.form, { amount: val });
        });
      }

      const currencySelect = document.getElementById('currency');
      if (currencySelect) {
        currencySelect.addEventListener('change', (e) => {
          state.form = Object.assign({}, state.form, { currency: e.target.value });
        });
      }

      const dateInput = document.getElementById('date');
      if (dateInput) {
        dateInput.addEventListener('change', (e) => {
          state.form = Object.assign({}, state.form, { date: e.target.value });
        });
      }

      const peopleInput = document.getElementById('peopleCount');
      if (peopleInput) {
        peopleInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { peopleCount: e.target.value });
        });
      }

      const descInput = document.getElementById('description');
      if (descInput) {
        descInput.addEventListener('input', (e) => {
          state.form = Object.assign({}, state.form, { description: e.target.value });
        });
      }

      const categoryButtons = document.querySelectorAll('[data-category]');
      categoryButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = btn.getAttribute('data-category');
          const newForm = Object.assign({}, state.form, { category: catId });
          state.form = newForm;
          setState({ form: newForm, error: '' });
        });
      });

      const photoInput = document.getElementById('photo-input');
      if (photoInput) {
        photoInput.addEventListener('change', handlePhotoInputChange);
      }

      const thumbDeleteBtns = document.querySelectorAll('[data-remove-photo]');
      thumbDeleteBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.getAttribute('data-remove-photo'), 10);
          const photos = (state.form.photos || []).slice();
          if (idx >= 0 && idx < photos.length) {
            photos.splice(idx, 1);
            const newForm = Object.assign({}, state.form, { photos });
            state.form = newForm;
            setState({ form: newForm });
          }
        });
      });

      const expenseCards = document.querySelectorAll('[data-expense-id]');
      expenseCards.forEach(card => {
        card.addEventListener('click', () => {
          const id = card.getAttribute('data-expense-id');
          setState({
            selectedExpenseId: id,
            showDetailModal: true,
            error: '',
            activeTab: 'expenses'
          });
        });
      });

      const cityHeaders = document.querySelectorAll('[data-city-toggle]');
      cityHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const city = header.getAttribute('data-city-toggle');
          const isExpanded = state.expandedCities[city] !== false;
          const updated = Object.assign({}, state.expandedCities, { [city]: !isExpanded });
          state.expandedCities = updated;
          setState({ expandedCities: updated });
        });
      });

      const detailCloseBtn = document.getElementById('close-detail-modal-btn');
      const detailOverlay = document.getElementById('detail-modal-overlay');
      if (detailCloseBtn) {
        detailCloseBtn.addEventListener('click', () => {
          setState({ showDetailModal: false, selectedExpenseId: null });
        });
      }
      if (detailOverlay) {
        detailOverlay.addEventListener('click', (e) => {
          if (e.target === detailOverlay) {
            setState({ showDetailModal: false, selectedExpenseId: null });
          }
        });
      }

      const editExpenseBtn = document.getElementById('edit-expense-btn');
      if (editExpenseBtn) {
        editExpenseBtn.addEventListener('click', () => {
          const exp = getSelectedExpense();
          if (!exp) return;
          state.form = {
            id: exp.id,
            city: exp.city || '',
            place: exp.place || '',
            amount: String(exp.amount),
            currency: exp.currency || 'TRY',
            date: exp.date || new Date().toISOString().slice(0, 10),
            category: exp.category || '',
            description: exp.description || '',
            peopleCount: exp.peopleCount != null ? String(exp.peopleCount) : '1',
            photos: (exp.photos || []).slice()
          };
          setState({
            view: 'form',
            showDetailModal: false,
            error: '',
            activeTab: 'expenses'
          });
        });
      }

      const deleteExpenseBtn = document.getElementById('delete-expense-btn');
      if (deleteExpenseBtn) {
        deleteExpenseBtn.addEventListener('click', () => {
          handleDeleteExpense();
        });
      }

      const tabButtons = document.querySelectorAll('[data-tab]');
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          if (tab === 'expenses') {
            setState({ activeTab: 'expenses' });
          } else if (tab === 'checklist') {
            setState({ activeTab: 'checklist', view: 'list', showDetailModal: false });
          }
        });
      });

      const addCheckItemBtn = document.getElementById('add-check-item-btn');
      if (addCheckItemBtn) {
        addCheckItemBtn.addEventListener('click', () => {
          addChecklistItem();
        });
      }

      const checkboxes = document.querySelectorAll('[data-check-item-id]');
      checkboxes.forEach(ch => {
        ch.addEventListener('change', () => {
          const id = ch.getAttribute('data-check-item-id');
          const items = (state.checklistItems || []).map(item =>
            item.id === id ? Object.assign({}, item, { done: ch.checked }) : item
          );
          state.checklistItems = items;
          saveChecklist();
          setState({ checklistItems: items });
        });
      });

      const checkAllButtons = document.querySelectorAll('[data-check-all-category]');
      checkAllButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = btn.getAttribute('data-check-all-category');
          const items = (state.checklistItems || []).map(item =>
            item.category === catId ? Object.assign({}, item, { done: true }) : item
          );
          state.checklistItems = items;
          saveChecklist();
          setState({ checklistItems: items });
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const expenses = loadExpenses();
      const checklist = loadChecklist();
      const expandedCities = {};
      expenses.forEach(exp => {
        if (exp.city) expandedCities[exp.city] = true;
      });
      state.expenses = expenses;
      state.checklistItems = checklist;
      state.expandedCities = expandedCities;

      renderApp();
      attachEventListeners();
    });
  })();
  </script>
</body>
</html>
